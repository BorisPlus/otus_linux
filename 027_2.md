# Фильтрация трафика - firewalld, iptables

Сценарии iptables:
* реализовать knocking port
* centralRouter может попасть на ssh inetRouter через knock скрипт пример в материалах.
* добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
* запустить nginx на centralServer.
* пробросить 80й порт на inetRouter2 8080.
* дефолт в инет оставить через inetRouter.

Формат сдачи ДЗ - vagrant + ansible
* реализовать проход на 80й порт без маскарадинга

Критерии оценки:

Статус "Принято" ставится при выполнении всех основных условий.
Рекомендуем сдать до: 16.08.2021

## Исполнение

[template][Vagrantfile](./027_2/vm/Vagrantfile)

```shell
pwd
    ./027_2/vm

vagrant up 
...

python3 v2a.py -o ../ansible/inventories/hosts

cd ../ansible/
pwd
    ./027_2/ansible
    
ansible-playbook playbooks/routing.yml 
ansible-playbook playbooks/internet-router.yml 

ansible-playbook playbooks/test_001_network_connectivity.yml 
```

```shell
cd ../vm
vagrant ssh centralRouter
    
    ssh 192.168.255.1
    # The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
    # ECDSA key fingerprint is SHA256:N66NFgJ/P/VQ2eKrzP4kLUe0RbbzeQ/xA4rn/hHIGuw.
    # ECDSA key fingerprint is MD5:1c:0d:da:e0:59:07:f7:52:d4:bd:c4:93:06:9d:33:c1.
    # Are you sure you want to continue connecting (yes/no)? yes                    <--- yes
    # Warning: Permanently added '192.168.255.1' (ECDSA) to the list of known hosts.
    # Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
    exit
```

```shell
cd ../ansible
ansible-playbook playbooks/task_001_password_auth.yml 

cd ../vm
vagrant ssh centralRouter

    ssh 192.168.255.1
    # vagrant@192.168.255.1's password: 
    # Last login: Sun Aug 29 19:48:43 2021 from 10.0.2.2
    # [vagrant@inetRouter ~]$ 
    exit
    
    exit
```

```shell
cd ../ansible
ansible-playbook playbooks/task_001_port_knocking_target.yml 
ansible-playbook playbooks/task_001_port_knocking_client.yml 
```

```shell
cd ../vm
vagrant ssh centralRouter

    ssh 192.168.255.1
    #   ssh: connect to host 192.168.255.1 port 22: Connection timed out
    
    ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.255.1
    #   vagrant@192.168.255.1's password: 
    #   Last login: Sun Aug 29 22:33:38 2021 from 10.0.2.2
    #   [vagrant@inetRouter ~]$ 
    exit
    exit
    
```
Видоизменил [template][port_knocking.sh](./027_2/ansible/roles/task_001_port_knocking_client/files/port_knocking.sh)

Замечание:
* port_knocking.sh требует установки nmap на клиенте, а можно иными? curl? c `ssh <IP> -p <PORT>` не вышло.
* port_knocking.sh необходим sudo для nmap, поведение c/без разнится, связано с правами на локальный сокет?

```shell
cd ../ansible
ansible-playbook playbooks/task_002_nginx.yml 
ansible-playbook playbooks/task_002_port_forwarding.yml

cd ../vm
vagrant ssh centralServer
    
    traceroute 8.8.8.8
    exit
    
vagrant ssh inetRouterSecond
Last login: Sun Aug 29 23:40:19 2021 from 10.0.2.2
[vagrant@inetRouterSecond ~]$ 

```

playbooks/task_002_nginx.yml