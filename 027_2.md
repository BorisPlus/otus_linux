# Фильтрация трафика - firewalld, iptables

Сценарии iptables:
* реализовать knocking port
* centralRouter может попасть на ssh inetRouter через knock скрипт пример в материалах.
* добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
* запустить nginx на centralServer.
* пробросить 80й порт на inetRouter2 8080.
* дефолт в инет оставить через inetRouter.

Формат сдачи ДЗ - vagrant + ansible
* реализовать проход на 80й порт без маскарадинга

Критерии оценки:

Статус "Принято" ставится при выполнении всех основных условий.
Рекомендуем сдать до: 16.08.2021

## Исполнение

[Vagrantfile](./027_2/vm/Vagrantfile)

<details><summary>см. Vagrantfile</summary>

```text
# -*- mode: ruby -*-
# vim: set ft=ruby :

MACHINES = {
    :inetRouter => {
        :box_name => "centos/7",
        # :public => {:ip => '10.10.10.1', :adapter => 1, :bridge => "enp4s0"},
        :net => [
            {ip: '192.168.255.1',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :inetRouterSecond => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.3',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :centralRouter => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.2',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
            {ip: '192.168.0.1',     adapter: 3, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
    :centralServer => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.0.2',     adapter: 2, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
}

Vagrant.configure("2") do |config|

    MACHINES.each do |boxname, boxconfig|
        config.gatling.rsync_on_startup = false
        config.vm.define boxname do |box|
            box.vm.provision "shell", run: "always", inline: <<-SHELL

                systemctl stop NetworkManager    # <--- No once anymore
                systemctl disable NetworkManager # <--- No once anymore
                systemctl enable network.service
                systemctl start network.service

                yum install -y traceroute
                yum install -y nano
            SHELL

            case boxname.to_s
            when "inetRouterSecond"
                box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
            end

            config.vm.provider "virtualbox" do |v|
                v.memory = 256
                v.cpus = 1
            end

            box.vm.box = boxconfig[:box_name]
            box.vm.host_name = boxname.to_s

            boxconfig[:net].each do |ipconf|
                box.vm.network "private_network", ipconf
            end

            if boxconfig.key?(:public)
                box.vm.network "public_network", boxconfig[:public]
            end

            box.vm.provision "shell", inline: <<-SHELL
                mkdir -p ~root/.ssh
                cp ~vagrant/.ssh/auth* ~root/.ssh
            SHELL

        end
    end
end

```

</details>

Ключевым моментом проверки доступности Web-сервера через inetRouterSecond является
```shell
case boxname.to_s
when "inetRouterSecond"
    box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
end
```

Разворачивание инфраструктуры

```shell
pwd
# ./027_2/vm

vagrant destroy -f && vagrant up 
# ...

python3 v2a.py -o ../ansible/inventories/hosts

cd ../ansible/
pwd
# ./027_2/ansible
    
```

Шлюзы по-умолчанию, маршруты, форвардинг:

```shell
ansible-playbook playbooks/routing.yml > ../files/playbooks_routing.txt
```


<details><summary>см. лог playbooks/routing.yml</summary>

```text

PLAY [Playbook of ethX gateway config] *****************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralServer]
ok: [inetRouter]
ok: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network | "NOZEROCONF=yes" | I don't want 169.254.0.0/16 network at default] ***
changed: [centralServer]
changed: [centralRouter]
changed: [inetRouter]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | delete route files] ***
changed: [centralRouter]
changed: [inetRouter]
changed: [centralServer]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | create needed route files] ***
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | set route] ***
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [centralRouter]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | set up if did not set] ***
skipping: [inetRouter]
changed: [centralRouter]
changed: [inetRouterSecond]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | replace] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | content] ***
changed: [centralRouter]
changed: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if did not set] ***
changed: [inetRouter]
changed: [centralRouter]
changed: [inetRouterSecond]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if "yes"] ***
ok: [inetRouter]
ok: [centralServer]
ok: [inetRouterSecond]
ok: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [inetRouter]
changed: [centralRouter]
changed: [inetRouterSecond]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes  | if did not set] ***
skipping: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes | if "no"] ***
skipping: [centralServer]
skipping: [inetRouterSecond]
skipping: [centralRouter]
changed: [inetRouter]

TASK [../roles/routing : /etc/sysctl.conf | content] ***************************
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if does not yet] ***
skipping: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if it was early] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]

RUNNING HANDLER [../roles/routing : systemctl-restart-network] *****************
changed: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]

PLAY RECAP *********************************************************************
centralRouter              : ok=13   changed=11   unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
centralServer              : ok=12   changed=10   unreachable=0    failed=0    skipped=6    rescued=0    ignored=0   
inetRouter                 : ok=14   changed=12   unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   
inetRouterSecond           : ok=15   changed=13   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   


```

</details>

Выходная нода (маскарадинг):

```shell
ansible-playbook playbooks/internet-router.yml  > ../files/playbooks_internet-router.txt
```


<details><summary>см. лог playbooks/internet-router.txt</summary>

```text

PLAY [Playbook of internet-node server initialization] *************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [inetRouter]

TASK [../roles/internet-router : iptables masquerading] ************************
changed: [inetRouter]
changed: [inetRouterSecond]

PLAY RECAP *********************************************************************
inetRouter                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Промежуточный тест сетевой связности и проверка inetRouter как единой точки выхода во вне

```shell
# если не сделать, то после тук-тук-тук не попадем
ansible-playbook playbooks/test_001_network_connectivity.yml > ../files/playbooks_test_001_network_connectivity.txt
```


<details><summary>см. лог playbooks/test_001_network_connectivity.yml</summary>

```text

PLAY [Playbook of tests] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]
ok: [centralRouter]
ok: [centralServer]
ok: [inetRouterSecond]

TASK [../roles/test_001_network_connectivity : test | demostration] ************
ok: [inetRouter] => {
    "msg": "Run from inventory: inetRouter"
}
ok: [inetRouterSecond] => {
    "msg": "Run from inventory: inetRouterSecond"
}
ok: [centralRouter] => {
    "msg": "Run from inventory: centralRouter"
}
ok: [centralServer] => {
    "msg": "Run from inventory: centralServer"
}

TASK [../roles/test_001_network_connectivity : test | traceroute foreign host] ***
changed: [inetRouterSecond] => (item=192.168.0.2)
changed: [centralRouter] => (item=192.168.0.2)
changed: [inetRouter] => (item=192.168.0.2)
changed: [centralServer] => (item=192.168.0.2)
changed: [inetRouterSecond] => (item=192.168.0.1)
changed: [centralRouter] => (item=192.168.0.1)
changed: [inetRouter] => (item=192.168.0.1)
changed: [centralServer] => (item=192.168.0.1)
changed: [centralRouter] => (item=192.168.255.2)
changed: [centralRouter] => (item=192.168.255.1)
changed: [inetRouterSecond] => (item=192.168.255.2)
changed: [inetRouter] => (item=192.168.255.2)
changed: [centralServer] => (item=192.168.255.2)
changed: [inetRouterSecond] => (item=192.168.255.1)
changed: [inetRouter] => (item=192.168.255.1)
changed: [centralServer] => (item=192.168.255.1)
changed: [inetRouter] => (item=8.8.8.8)
changed: [centralRouter] => (item=8.8.8.8)
changed: [inetRouterSecond] => (item=8.8.8.8)
changed: [centralServer] => (item=8.8.8.8)

TASK [../roles/test_001_network_connectivity : test | result file output] ******
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:56.519361', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  centralServer (192.168.0.2)  0.043 ms  0.049 ms  0.020 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:25:56.460042', 'stderr': '', 'delta': '0:00:00.059319', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  centralServer (192.168.0.2)  0.043 ms  0.049 ms  0.020 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:56.535990', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  14.060 ms  12.437 ms  12.125 ms\n 2  192.168.0.2 (192.168.0.2)  26.821 ms  26.686 ms  26.462 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:25:56.433888', 'stderr': '', 'delta': '0:00:00.102102', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  14.060 ms  12.437 ms  12.125 ms', ' 2  192.168.0.2 (192.168.0.2)  26.821 ms  26.686 ms  26.462 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:56.413690', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  20.321 ms  19.978 ms  19.895 ms\n 2  192.168.0.2 (192.168.0.2)  28.461 ms  28.415 ms  28.341 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:25:56.270506', 'stderr': '', 'delta': '0:00:00.143184', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  20.321 ms  19.978 ms  19.895 ms', ' 2  192.168.0.2 (192.168.0.2)  28.461 ms  28.415 ms  28.341 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:56.532425', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.0.2 (192.168.0.2)  6.124 ms  5.867 ms  5.711 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:25:56.462447', 'stderr': '', 'delta': '0:00:00.069978', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.0.2 (192.168.0.2)  6.124 ms  5.867 ms  5.711 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:58.056471', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.420 ms  0.240 ms  0.244 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:25:57.965918', 'stderr': '', 'delta': '0:00:00.090553', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.420 ms  0.240 ms  0.244 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:57.851199', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  192.168.0.1 (192.168.0.1)  0.392 ms  0.257 ms  0.247 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:25:57.785298', 'stderr': '', 'delta': '0:00:00.065901', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  192.168.0.1 (192.168.0.1)  0.392 ms  0.257 ms  0.247 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:57.999900', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  192.168.0.1 (192.168.0.1)  0.776 ms  0.432 ms  0.293 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:25:57.923290', 'stderr': '', 'delta': '0:00:00.076610', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  192.168.0.1 (192.168.0.1)  0.776 ms  0.432 ms  0.293 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:57.857384', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.0.1)  0.042 ms  0.020 ms  0.026 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:25:57.778996', 'stderr': '', 'delta': '0:00:00.078388', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.0.1)  0.042 ms  0.020 ms  0.026 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:04.553810', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.420 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:25:59.489383', 'stderr': '', 'delta': '0:00:05.064427', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.420 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:04.071575', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  10.916 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:25:59.012862', 'stderr': '', 'delta': '0:00:05.058713', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  10.916 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:04.214642', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.477 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:25:59.160462', 'stderr': '', 'delta': '0:00:05.054180', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.477 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:59.170119', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.255.2)  0.044 ms  0.020 ms  0.020 ms', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:25:59.098224', 'stderr': '', 'delta': '0:00:00.071895', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.255.2)  0.044 ms  0.020 ms  0.020 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:05.523403', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.577 ms  0.553 ms  0.418 ms\n 2  192.168.255.1 (192.168.255.1)  1.030 ms  0.866 ms  0.988 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:26:05.431650', 'stderr': '', 'delta': '0:00:00.091753', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.577 ms  0.553 ms  0.418 ms', ' 2  192.168.255.1 (192.168.255.1)  1.030 ms  0.866 ms  0.988 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:05.067750', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  inetRouter (192.168.255.1)  0.073 ms  0.037 ms  0.042 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:26:05.013103', 'stderr': '', 'delta': '0:00:00.054647', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  inetRouter (192.168.255.1)  0.073 ms  0.037 ms  0.042 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:04.912112', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.533 ms  0.379 ms  0.276 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:26:04.850093', 'stderr': '', 'delta': '0:00:00.062019', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.533 ms  0.379 ms  0.276 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:25:59.901461', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.783 ms  1.274 ms  1.120 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:25:59.842915', 'stderr': '', 'delta': '0:00:00.058546', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.783 ms  1.274 ms  1.120 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:22.211468', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.736 ms  0.753 ms  2.542 ms\n 2  * * *\n 3  * * *\n 4  * * *\n 5  * * *\n 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.247 ms  12.844 ms  12.420 ms\n 7  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  12.130 ms  13.284 ms  9.896 ms\n 8  188.254.2.6 (188.254.2.6)  35.331 ms  35.179 ms 188.254.2.4 (188.254.2.4)  27.480 ms\n 9  87.226.194.47 (87.226.194.47)  27.314 ms  25.009 ms  26.334 ms\n10  74.125.244.180 (74.125.244.180)  37.722 ms 74.125.244.132 (74.125.244.132)  27.617 ms  26.859 ms\n11  72.14.232.85 (72.14.232.85)  26.803 ms 216.239.48.163 (216.239.48.163)  30.743 ms 72.14.232.85 (72.14.232.85)  22.991 ms\n12  216.239.49.115 (216.239.49.115)  30.439 ms 142.251.51.187 (142.251.51.187)  35.689 ms 142.251.61.221 (142.251.61.221)  28.734 ms\n13  * 216.239.56.113 (216.239.56.113)  28.924 ms *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  * * *\n22  * dns.google (8.8.8.8)  41.965 ms *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:26:06.336041', 'stderr': '', 'delta': '0:00:15.875427', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.736 ms  0.753 ms  2.542 ms', ' 2  * * *', ' 3  * * *', ' 4  * * *', ' 5  * * *', ' 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.247 ms  12.844 ms  12.420 ms', ' 7  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  12.130 ms  13.284 ms  9.896 ms', ' 8  188.254.2.6 (188.254.2.6)  35.331 ms  35.179 ms 188.254.2.4 (188.254.2.4)  27.480 ms', ' 9  87.226.194.47 (87.226.194.47)  27.314 ms  25.009 ms  26.334 ms', '10  74.125.244.180 (74.125.244.180)  37.722 ms 74.125.244.132 (74.125.244.132)  27.617 ms  26.859 ms', '11  72.14.232.85 (72.14.232.85)  26.803 ms 216.239.48.163 (216.239.48.163)  30.743 ms 72.14.232.85 (72.14.232.85)  22.991 ms', '12  216.239.49.115 (216.239.49.115)  30.439 ms 142.251.51.187 (142.251.51.187)  35.689 ms 142.251.61.221 (142.251.61.221)  28.734 ms', '13  * 216.239.56.113 (216.239.56.113)  28.924 ms *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  * * *', '22  * dns.google (8.8.8.8)  41.965 ms *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:16.591809', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (10.0.2.2)  0.740 ms  2.292 ms  1.926 ms\n 2  router.asus.com (192.168.101.1)  1.745 ms  1.559 ms  1.366 ms\n 3  192.168.100.1 (192.168.100.1)  1.597 ms  2.419 ms  3.219 ms\n 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  17.418 ms  17.371 ms  17.463 ms\n 5  212.48.194.212 (212.48.194.212)  22.868 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  17.033 ms  17.025 ms\n 6  188.254.2.4 (188.254.2.4)  31.990 ms  27.245 ms 188.254.2.6 (188.254.2.6)  54.474 ms\n 7  87.226.194.47 (87.226.194.47)  52.613 ms  27.558 ms  30.647 ms\n 8  74.125.244.132 (74.125.244.132)  49.969 ms 74.125.244.180 (74.125.244.180)  51.837 ms 74.125.244.132 (74.125.244.132)  32.228 ms\n 9  72.14.232.85 (72.14.232.85)  25.323 ms 142.251.61.219 (142.251.61.219)  38.087 ms 72.14.232.85 (72.14.232.85)  31.132 ms\n10  142.250.208.23 (142.250.208.23)  36.966 ms 216.239.56.101 (216.239.56.101)  33.499 ms 142.251.51.187 (142.251.51.187)  36.574 ms\n11  * 216.239.42.23 (216.239.42.23)  40.532 ms *\n12  * * *\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * dns.google (8.8.8.8)  43.445 ms *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:26:05.995598', 'stderr': '', 'delta': '0:00:10.596211', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (10.0.2.2)  0.740 ms  2.292 ms  1.926 ms', ' 2  router.asus.com (192.168.101.1)  1.745 ms  1.559 ms  1.366 ms', ' 3  192.168.100.1 (192.168.100.1)  1.597 ms  2.419 ms  3.219 ms', ' 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  17.418 ms  17.371 ms  17.463 ms', ' 5  212.48.194.212 (212.48.194.212)  22.868 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  17.033 ms  17.025 ms', ' 6  188.254.2.4 (188.254.2.4)  31.990 ms  27.245 ms 188.254.2.6 (188.254.2.6)  54.474 ms', ' 7  87.226.194.47 (87.226.194.47)  52.613 ms  27.558 ms  30.647 ms', ' 8  74.125.244.132 (74.125.244.132)  49.969 ms 74.125.244.180 (74.125.244.180)  51.837 ms 74.125.244.132 (74.125.244.132)  32.228 ms', ' 9  72.14.232.85 (72.14.232.85)  25.323 ms 142.251.61.219 (142.251.61.219)  38.087 ms 72.14.232.85 (72.14.232.85)  31.132 ms', '10  142.250.208.23 (142.250.208.23)  36.966 ms 216.239.56.101 (216.239.56.101)  33.499 ms 142.251.51.187 (142.251.51.187)  36.574 ms', '11  * 216.239.42.23 (216.239.42.23)  40.532 ms *', '12  * * *', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * dns.google (8.8.8.8)  43.445 ms *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:22.027194', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.429 ms * *\n 2  * * *\n 3  * * *\n 4  192.168.100.1 (192.168.100.1)  4.148 ms  4.880 ms  5.373 ms\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  15.215 ms  14.787 ms  14.624 ms\n 6  212.48.194.212 (212.48.194.212)  15.247 ms  16.110 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.738 ms\n 7  188.254.2.6 (188.254.2.6)  33.158 ms  32.924 ms  47.896 ms\n 8  87.226.194.47 (87.226.194.47)  47.551 ms  33.701 ms  33.489 ms\n 9  74.125.244.180 (74.125.244.180)  32.835 ms 74.125.244.132 (74.125.244.132)  32.299 ms  29.466 ms\n10  142.251.61.219 (142.251.61.219)  29.272 ms 72.14.232.85 (72.14.232.85)  36.144 ms  27.589 ms\n11  172.253.51.185 (172.253.51.185)  33.267 ms 216.239.63.27 (216.239.63.27)  32.629 ms 74.125.253.147 (74.125.253.147)  42.272 ms\n12  216.239.62.13 (216.239.62.13)  32.253 ms * *\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  dns.google (8.8.8.8)  32.670 ms  32.405 ms  33.583 ms', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:26:05.858181', 'stderr': '', 'delta': '0:00:16.169013', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.429 ms * *', ' 2  * * *', ' 3  * * *', ' 4  192.168.100.1 (192.168.100.1)  4.148 ms  4.880 ms  5.373 ms', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  15.215 ms  14.787 ms  14.624 ms', ' 6  212.48.194.212 (212.48.194.212)  15.247 ms  16.110 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.738 ms', ' 7  188.254.2.6 (188.254.2.6)  33.158 ms  32.924 ms  47.896 ms', ' 8  87.226.194.47 (87.226.194.47)  47.551 ms  33.701 ms  33.489 ms', ' 9  74.125.244.180 (74.125.244.180)  32.835 ms 74.125.244.132 (74.125.244.132)  32.299 ms  29.466 ms', '10  142.251.61.219 (142.251.61.219)  29.272 ms 72.14.232.85 (72.14.232.85)  36.144 ms  27.589 ms', '11  172.253.51.185 (172.253.51.185)  33.267 ms 216.239.63.27 (216.239.63.27)  32.629 ms 74.125.253.147 (74.125.253.147)  42.272 ms', '12  216.239.62.13 (216.239.62.13)  32.253 ms * *', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  dns.google (8.8.8.8)  32.670 ms  32.405 ms  33.583 ms'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:26:17.165800', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  192.168.100.1 (192.168.100.1)  5.589 ms  5.471 ms  5.632 ms\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  20.436 ms  20.302 ms  20.076 ms\n 6  212.48.194.212 (212.48.194.212)  18.860 ms  15.266 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.106 ms\n 7  188.254.2.6 (188.254.2.6)  32.740 ms  24.065 ms 188.254.2.4 (188.254.2.4)  24.774 ms\n 8  87.226.194.47 (87.226.194.47)  27.812 ms  27.652 ms  39.152 ms\n 9  74.125.244.132 (74.125.244.132)  33.689 ms  26.230 ms 74.125.244.180 (74.125.244.180)  41.567 ms\n10  72.14.232.85 (72.14.232.85)  26.390 ms 216.239.48.163 (216.239.48.163)  29.670 ms 142.251.61.219 (142.251.61.219)  41.783 ms\n11  142.250.210.103 (142.250.210.103)  43.380 ms 216.239.56.101 (216.239.56.101)  30.276 ms 216.239.62.15 (216.239.62.15)  27.512 ms\n12  209.85.251.41 (209.85.251.41)  37.492 ms 172.253.51.189 (172.253.51.189)  38.941 ms 216.239.63.129 (216.239.63.129)  31.233 ms\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  * dns.google (8.8.8.8)  39.032 ms  33.358 ms', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:26:00.469115', 'stderr': '', 'delta': '0:00:16.696685', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  * * *', ' 2  * * *', ' 3  * * *', ' 4  192.168.100.1 (192.168.100.1)  5.589 ms  5.471 ms  5.632 ms', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  20.436 ms  20.302 ms  20.076 ms', ' 6  212.48.194.212 (212.48.194.212)  18.860 ms  15.266 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.106 ms', ' 7  188.254.2.6 (188.254.2.6)  32.740 ms  24.065 ms 188.254.2.4 (188.254.2.4)  24.774 ms', ' 8  87.226.194.47 (87.226.194.47)  27.812 ms  27.652 ms  39.152 ms', ' 9  74.125.244.132 (74.125.244.132)  33.689 ms  26.230 ms 74.125.244.180 (74.125.244.180)  41.567 ms', '10  72.14.232.85 (72.14.232.85)  26.390 ms 216.239.48.163 (216.239.48.163)  29.670 ms 142.251.61.219 (142.251.61.219)  41.783 ms', '11  142.250.210.103 (142.250.210.103)  43.380 ms 216.239.56.101 (216.239.56.101)  30.276 ms 216.239.62.15 (216.239.62.15)  27.512 ms', '12  209.85.251.41 (209.85.251.41)  37.492 ms 172.253.51.189 (172.253.51.189)  38.941 ms 216.239.63.129 (216.239.63.129)  31.233 ms', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  * dns.google (8.8.8.8)  39.032 ms  33.358 ms'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
centralRouter              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouter                 : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

* промежуточный тест доступности 192.168.0.1


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.420 ms  0.240 ms  0.244 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  centralRouter (192.168.0.1)  0.042 ms  0.020 ms  0.026 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  0.776 ms  0.432 ms  0.293 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  0.392 ms  0.257 ms  0.247 ms
```

</details>

* промежуточный тес доступности 192.168.0.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  centralServer (192.168.0.2)  0.043 ms  0.049 ms  0.020 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.0.2 (192.168.0.2)  6.124 ms  5.867 ms  5.711 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  14.060 ms  12.437 ms  12.125 ms
 2  192.168.0.2 (192.168.0.2)  26.821 ms  26.686 ms  26.462 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  20.321 ms  19.978 ms  19.895 ms
 2  192.168.0.2 (192.168.0.2)  28.461 ms  28.415 ms  28.341 ms
```

</details>

* промежуточный тест доступности 192.168.255.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.420 ms * *
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  centralRouter (192.168.255.2)  0.044 ms  0.020 ms  0.020 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.477 ms * *
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  10.916 ms * *
```

</details>

* промежуточный тест доступности 192.168.255.1


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.577 ms  0.553 ms  0.418 ms
 2  192.168.255.1 (192.168.255.1)  1.030 ms  0.866 ms  0.988 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.783 ms  1.274 ms  1.120 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  inetRouter (192.168.255.1)  0.073 ms  0.037 ms  0.042 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.533 ms  0.379 ms  0.276 ms
```

</details>

* промежуточный тест доступности 8.8.8.8 (это выход во вне)


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.736 ms  0.753 ms  2.542 ms
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.247 ms  12.844 ms  12.420 ms
 7  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  12.130 ms  13.284 ms  9.896 ms
 8  188.254.2.6 (188.254.2.6)  35.331 ms  35.179 ms 188.254.2.4 (188.254.2.4)  27.480 ms
 9  87.226.194.47 (87.226.194.47)  27.314 ms  25.009 ms  26.334 ms
10  74.125.244.180 (74.125.244.180)  37.722 ms 74.125.244.132 (74.125.244.132)  27.617 ms  26.859 ms
11  72.14.232.85 (72.14.232.85)  26.803 ms 216.239.48.163 (216.239.48.163)  30.743 ms 72.14.232.85 (72.14.232.85)  22.991 ms
12  216.239.49.115 (216.239.49.115)  30.439 ms 142.251.51.187 (142.251.51.187)  35.689 ms 142.251.61.221 (142.251.61.221)  28.734 ms
13  * 216.239.56.113 (216.239.56.113)  28.924 ms *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * dns.google (8.8.8.8)  41.965 ms *
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  192.168.100.1 (192.168.100.1)  5.589 ms  5.471 ms  5.632 ms
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  20.436 ms  20.302 ms  20.076 ms
 6  212.48.194.212 (212.48.194.212)  18.860 ms  15.266 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.106 ms
 7  188.254.2.6 (188.254.2.6)  32.740 ms  24.065 ms 188.254.2.4 (188.254.2.4)  24.774 ms
 8  87.226.194.47 (87.226.194.47)  27.812 ms  27.652 ms  39.152 ms
 9  74.125.244.132 (74.125.244.132)  33.689 ms  26.230 ms 74.125.244.180 (74.125.244.180)  41.567 ms
10  72.14.232.85 (72.14.232.85)  26.390 ms 216.239.48.163 (216.239.48.163)  29.670 ms 142.251.61.219 (142.251.61.219)  41.783 ms
11  142.250.210.103 (142.250.210.103)  43.380 ms 216.239.56.101 (216.239.56.101)  30.276 ms 216.239.62.15 (216.239.62.15)  27.512 ms
12  209.85.251.41 (209.85.251.41)  37.492 ms 172.253.51.189 (172.253.51.189)  38.941 ms 216.239.63.129 (216.239.63.129)  31.233 ms
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * dns.google (8.8.8.8)  39.032 ms  33.358 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond (все равно идет через inetRouter)</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.429 ms * *
 2  * * *
 3  * * *
 4  192.168.100.1 (192.168.100.1)  4.148 ms  4.880 ms  5.373 ms
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  15.215 ms  14.787 ms  14.624 ms
 6  212.48.194.212 (212.48.194.212)  15.247 ms  16.110 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.738 ms
 7  188.254.2.6 (188.254.2.6)  33.158 ms  32.924 ms  47.896 ms
 8  87.226.194.47 (87.226.194.47)  47.551 ms  33.701 ms  33.489 ms
 9  74.125.244.180 (74.125.244.180)  32.835 ms 74.125.244.132 (74.125.244.132)  32.299 ms  29.466 ms
10  142.251.61.219 (142.251.61.219)  29.272 ms 72.14.232.85 (72.14.232.85)  36.144 ms  27.589 ms
11  172.253.51.185 (172.253.51.185)  33.267 ms 216.239.63.27 (216.239.63.27)  32.629 ms 74.125.253.147 (74.125.253.147)  42.272 ms
12  216.239.62.13 (216.239.62.13)  32.253 ms * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  dns.google (8.8.8.8)  32.670 ms  32.405 ms  33.583 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (10.0.2.2)  0.740 ms  2.292 ms  1.926 ms
 2  router.asus.com (192.168.101.1)  1.745 ms  1.559 ms  1.366 ms
 3  192.168.100.1 (192.168.100.1)  1.597 ms  2.419 ms  3.219 ms
 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  17.418 ms  17.371 ms  17.463 ms
 5  212.48.194.212 (212.48.194.212)  22.868 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  17.033 ms  17.025 ms
 6  188.254.2.4 (188.254.2.4)  31.990 ms  27.245 ms 188.254.2.6 (188.254.2.6)  54.474 ms
 7  87.226.194.47 (87.226.194.47)  52.613 ms  27.558 ms  30.647 ms
 8  74.125.244.132 (74.125.244.132)  49.969 ms 74.125.244.180 (74.125.244.180)  51.837 ms 74.125.244.132 (74.125.244.132)  32.228 ms
 9  72.14.232.85 (72.14.232.85)  25.323 ms 142.251.61.219 (142.251.61.219)  38.087 ms 72.14.232.85 (72.14.232.85)  31.132 ms
10  142.250.208.23 (142.250.208.23)  36.966 ms 216.239.56.101 (216.239.56.101)  33.499 ms 142.251.51.187 (142.251.51.187)  36.574 ms
11  * 216.239.42.23 (216.239.42.23)  40.532 ms *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * dns.google (8.8.8.8)  43.445 ms *
```

</details>
    
### Тук-тук-тук

Проверка дефолтного SSH доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
    # ECDSA key fingerprint is SHA256:N66NFgJ/P/VQ2eKrzP4kLUe0RbbzeQ/xA4rn/hHIGuw.
    # ECDSA key fingerprint is MD5:1c:0d:da:e0:59:07:f7:52:d4:bd:c4:93:06:9d:33:c1.
    # Are you sure you want to continue connecting (yes/no)? yes                    <--- yes
    # Warning: Permanently added '192.168.255.1' (ECDSA) to the list of known hosts.
    # Permission denied (publickey,gssapi-keyex,gssapi-with-mic).                   <--- omg
    exit
exit
```

Настройка парольного доступа

```shell
cd ../ansible
ansible-playbook playbooks/task_001_password_auth.yml > ../files/task_001_password_auth.txt
```


<details><summary>см. лог playbooks/task_001_password_auth.yml</summary>

```text

PLAY [Set up /etc/ssh/sshd_config PasswordAuthentication yes] ******************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | content] ********
changed: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it does not set up] ***
skipping: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it was set up early] ***
changed: [inetRouter]

RUNNING HANDLER [../roles/task_001_password_auth : systemctl-restart-sshd] *****
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=4    changed=3    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   


```

</details>

Проверка работы парольного доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # vagrant@192.168.255.1's password: 
    # Last login: Sun Aug 29 19:48:43 2021 from 10.0.2.2
    # [vagrant@inetRouter ~]$  <-- OK
    exit
exit
```

```shell
cd ../ansible
```

Реализация "тук-тук-тук" на цели доступа

```shell
ansible-playbook playbooks/task_001_port_knocking_target.yml > ../files/task_001_port_knocking_target.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_target.yml</summary>

```text

PLAY [Configure port-knocking target] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Copy port-knocking rules file] ***
changed: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Apply and save port-knocking rules] ***
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

ПО для "тук-тук-тук" на клиенте, осуществляющем доступ

```shell
ansible-playbook playbooks/task_001_port_knocking_client.yml > ../files/task_001_port_knocking_client.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_client.yml</summary>

```text

PLAY [Set up port-knocking client program] *************************************

TASK [Gathering Facts] *********************************************************
ok: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Install Nmap] *******************
changed: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Copy port knocking file for clients] ***
changed: [centralRouter]

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работоспособности "тук-тук-тук"

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    #   ssh: connect to host 192.168.255.1 port 22: Connection timed out    <--- бет тук-тук-тук не откроет
    ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.255.1
    #   vagrant@192.168.255.1's password:                                   <--- с тук-тук-тук открыл
    #   Last login: Sun Aug 29 22:33:38 2021 from 10.0.2.2
    #   [vagrant@inetRouter ~]$ 
    exit
exit  
```

Видоизменил [port_knocking.sh](./027_2/ansible/roles/task_001_port_knocking_client/files/port_knocking.sh)

<details><summary>см. port_knocking.sh</summary>

```shell
#!/bin/bash
# ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.0.1

# Проверка на переданный параметр
USAGE="SYNOPSIS: ./port_knocking.sh <TARGET_IP> <port_1> [<port_2> <port_3> ...]"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter TARGET_IP. "
    echo $USAGE
    exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, some knock-port id needed. "
    echo $USAGE
    exit 1
fi

TARGET_IP=$1
shift
for ARG in "$@"
do
  sudo nmap -Pn --max-retries 0 -p $ARG $TARGET_IP # !! SUDO - MUST BE
#  sudo ssh -o ConnectTimeout=1 $TARGET_IP -p $ARG
done
```

</details>

Замечание:
* port_knocking.sh требует установки nmap на клиенте, а можно иными? curl? или `ssh <IP> -p <PORT>` не вышло.
* port_knocking.sh необходим sudo для nmap, поведение c/без разнится, связано с правами на локальный сокет?

Внимание: если захотите проверить сетевую связность тут, как я сделал выше, то будет необходимо сделать "тук-тук-тук"

Развертка nginx

```shell
cd ../ansible
ansible-playbook playbooks/task_002_nginx.yml > ../files/task_002_nginx.txt
```


<details><summary>см. лог playbooks/task_002_nginx.yml</summary>

```text

PLAY [Deploy nginx] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [centralServer]

TASK [../roles/task_002_nginx : Install EPEL Repo package from standart repo] ***
changed: [centralServer]

TASK [../roles/task_002_nginx : Install nginx] *********************************
changed: [centralServer]

TASK [../roles/task_002_nginx : Configure nginx] *******************************
changed: [centralServer]

TASK [../roles/task_002_nginx : index.html] ************************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : start nginx] ************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : restart nginx] **********************
changed: [centralServer]

PLAY RECAP *********************************************************************
centralServer              : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проброс порта 80 --> 8080

```shell
ansible-playbook playbooks/task_002_port_forwarding.yml > ../files/playbooks_task_002_port_forwarding.txt
```


<details><summary>см. лог playbooks/task_002_port_forwarding.yml</summary>

```text

PLAY [Configure port forwarding] ***********************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables dnat] ***********************
changed: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables snat] ***********************
changed: [inetRouterSecond]

PLAY RECAP *********************************************************************
inetRouterSecond           : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 192.168.0.2:80 внутри сети

```shell
ansible-playbook playbooks/test_003_http_connectivity.yml > ../files/test_003_http_connectivity.txt
```


<details><summary>см. лог playbooks/test_003_http_connectivity.yml</summary>

```text

PLAY [Playbook of internal http connectivity tests] ****************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralServer]
ok: [centralRouter]

TASK [../roles/test_003_http_connectivity : test | http | curl] ****************
changed: [centralServer]
changed: [inetRouterSecond]
changed: [centralRouter]

TASK [../roles/test_003_http_connectivity : test | http | index page content] ***
ok: [inetRouterSecond] => {
    "msg": "Hello from centralServer"
}
ok: [centralRouter] => {
    "msg": "Hello from centralServer"
}
ok: [centralServer] => {
    "msg": "Hello from centralServer"
}

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 8080 извне сети

```shell
cd ../vm
curl -I 127.0.0.1:8080 > ../files/curl_localhost_8080.md
curl 127.0.0.1:8080 >> ../files/curl_localhost_8080.md
```

Лог `curl_localhost_8080.md`:

```text


HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Sat, 04 Sep 2021 19:42:16 GMT
Content-Type: text/html
Content-Length: 24
Last-Modified: Sat, 04 Sep 2021 19:41:02 GMT
Connection: keep-alive
ETag: "6133cbce-18"
Accept-Ranges: bytes

Hello from centralServer
```
