# Фильтрация трафика - firewalld, iptables

Сценарии iptables:
* реализовать knocking port
* centralRouter может попасть на ssh inetRouter через knock скрипт пример в материалах.
* добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
* запустить nginx на centralServer.
* пробросить 80й порт на inetRouter2 8080.
* дефолт в инет оставить через inetRouter.

Формат сдачи ДЗ - vagrant + ansible
* реализовать проход на 80й порт без маскарадинга

Критерии оценки:

Статус "Принято" ставится при выполнении всех основных условий.
Рекомендуем сдать до: 16.08.2021

## Исполнение

[Vagrantfile](./027_2/vm/Vagrantfile)

<details><summary>см. Vagrantfile</summary>

```text
# -*- mode: ruby -*-
# vim: set ft=ruby :

MACHINES = {
    :inetRouter => {
        :box_name => "centos/7",
        # :public => {:ip => '10.10.10.1', :adapter => 1, :bridge => "enp4s0"},
        :net => [
            {ip: '192.168.255.1',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :inetRouterSecond => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.3',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :centralRouter => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.2',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
            {ip: '192.168.0.1',     adapter: 3, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
    :centralServer => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.0.2',     adapter: 2, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
}

Vagrant.configure("2") do |config|

    MACHINES.each do |boxname, boxconfig|
        config.gatling.rsync_on_startup = false
        config.vm.define boxname do |box|
            box.vm.provision "shell", run: "always", inline: <<-SHELL

                systemctl stop NetworkManager    # <--- No once anymore
                systemctl disable NetworkManager # <--- No once anymore
                systemctl enable network.service
                systemctl start network.service

                yum install -y traceroute
                yum install -y nano
            SHELL

            case boxname.to_s
            when "inetRouterSecond"
                box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
            end

            config.vm.provider "virtualbox" do |v|
                v.memory = 256
                v.cpus = 1
            end

            box.vm.box = boxconfig[:box_name]
            box.vm.host_name = boxname.to_s

            boxconfig[:net].each do |ipconf|
                box.vm.network "private_network", ipconf
            end

            if boxconfig.key?(:public)
                box.vm.network "public_network", boxconfig[:public]
            end

            box.vm.provision "shell", inline: <<-SHELL
                mkdir -p ~root/.ssh
                cp ~vagrant/.ssh/auth* ~root/.ssh
            SHELL

        end
    end
end

```

</details>

Ключевым моментом проверки доступности Web-сервера через inetRouterSecond является
```shell
case boxname.to_s
when "inetRouterSecond"
    box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
end
```

Разворачивание инфраструктуры

```shell
pwd
# ./027_2/vm

vagrant destroy -f && vagrant up 
# ...

python3 v2a.py -o ../ansible/inventories/hosts

cd ../ansible/
pwd
# ./027_2/ansible
    
```

Шлюзы по-умолчанию, маршруты, форвардинг:

```shell
ansible-playbook playbooks/routing.yml > ../files/playbooks_routing.txt
```


<details><summary>см. лог playbooks/routing.yml</summary>

```text

PLAY [Playbook of ethX gateway config] *****************************************

TASK [Gathering Facts] *********************************************************
ok: [centralServer]
ok: [inetRouter]
ok: [inetRouterSecond]
ok: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network | "NOZEROCONF=yes" | I don't want 169.254.0.0/16 network at default] ***
changed: [inetRouter]
changed: [centralRouter]
changed: [inetRouterSecond]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | delete route files] ***
changed: [centralRouter]
changed: [inetRouter]
changed: [centralServer]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | create needed route files] ***
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | set route] ***
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [inetRouterSecond]
changed: [centralServer]
changed: [inetRouter]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | set up if did not set] ***
skipping: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | replace] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralServer]
skipping: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | content] ***
changed: [centralRouter]
changed: [inetRouterSecond]
changed: [inetRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if did not set] ***
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralServer]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if "yes"] ***
ok: [inetRouterSecond]
ok: [centralServer]
ok: [inetRouter]
ok: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [centralRouter]
changed: [inetRouter]
changed: [centralServer]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes  | if did not set] ***
skipping: [inetRouter]
changed: [inetRouterSecond]
changed: [centralServer]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes | if "no"] ***
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]
changed: [inetRouter]

TASK [../roles/routing : /etc/sysctl.conf | content] ***************************
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]
changed: [inetRouter]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if does not yet] ***
skipping: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if it was early] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]

RUNNING HANDLER [../roles/routing : systemctl-restart-network] *****************
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

PLAY RECAP *********************************************************************
centralRouter              : ok=13   changed=11   unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
centralServer              : ok=12   changed=10   unreachable=0    failed=0    skipped=6    rescued=0    ignored=0   
inetRouter                 : ok=14   changed=12   unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   
inetRouterSecond           : ok=15   changed=13   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   


```

</details>

Выходная нода (маскарадинг):

```shell
ansible-playbook playbooks/internet-router.yml  > ../files/playbooks_internet-router.txt
```


<details><summary>см. лог playbooks/internet-router.txt</summary>

```text

PLAY [Playbook of internet-node server initialization] *************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]
ok: [inetRouterSecond]

TASK [../roles/internet-router : iptables masquerading] ************************
changed: [inetRouterSecond]
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Промежуточный тест сетевой связности и проверка inetRouter как единой точки выхода во вне

```shell
# если не сделать, то после тук-тук-тук не попадем
ansible-playbook playbooks/test_001_network_connectivity.yml > ../files/playbooks_test_001_network_connectivity.txt
```


<details><summary>см. лог playbooks/test_001_network_connectivity.yml</summary>

```text

PLAY [Playbook of tests] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralRouter]
ok: [inetRouter]
ok: [centralServer]

TASK [../roles/test_001_network_connectivity : test | demostration] ************
ok: [inetRouter] => {
    "msg": "Run from inventory: inetRouter"
}
ok: [inetRouterSecond] => {
    "msg": "Run from inventory: inetRouterSecond"
}
ok: [centralRouter] => {
    "msg": "Run from inventory: centralRouter"
}
ok: [centralServer] => {
    "msg": "Run from inventory: centralServer"
}

TASK [../roles/test_001_network_connectivity : test | traceroute foreign host] ***
changed: [centralRouter] => (item=192.168.0.2)
changed: [inetRouter] => (item=192.168.0.2)
changed: [centralServer] => (item=192.168.0.2)
changed: [inetRouterSecond] => (item=192.168.0.2)
changed: [centralRouter] => (item=192.168.0.1)
changed: [centralServer] => (item=192.168.0.1)
changed: [inetRouter] => (item=192.168.0.1)
changed: [inetRouterSecond] => (item=192.168.0.1)
changed: [centralRouter] => (item=192.168.255.2)
changed: [centralRouter] => (item=192.168.255.1)
changed: [inetRouter] => (item=192.168.255.2)
changed: [centralServer] => (item=192.168.255.2)
changed: [inetRouterSecond] => (item=192.168.255.2)
changed: [inetRouter] => (item=192.168.255.1)
changed: [centralServer] => (item=192.168.255.1)
changed: [inetRouterSecond] => (item=192.168.255.1)
changed: [inetRouter] => (item=8.8.8.8)
changed: [centralRouter] => (item=8.8.8.8)
changed: [centralServer] => (item=8.8.8.8)
changed: [inetRouterSecond] => (item=8.8.8.8)

TASK [../roles/test_001_network_connectivity : test | result file output] ******
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:46.582097', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.0.2 (192.168.0.2)  0.475 ms  0.157 ms  0.250 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:03:46.505491', 'stderr': '', 'delta': '0:00:00.076606', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.0.2 (192.168.0.2)  0.475 ms  0.157 ms  0.250 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:46.823727', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  1.241 ms  0.870 ms  1.103 ms\n 2  192.168.0.2 (192.168.0.2)  1.557 ms  1.281 ms  1.415 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:03:46.725003', 'stderr': '', 'delta': '0:00:00.098724', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  1.241 ms  0.870 ms  1.103 ms', ' 2  192.168.0.2 (192.168.0.2)  1.557 ms  1.281 ms  1.415 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:46.600151', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  centralServer (192.168.0.2)  0.074 ms  0.022 ms  0.022 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:03:46.541906', 'stderr': '', 'delta': '0:00:00.058245', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  centralServer (192.168.0.2)  0.074 ms  0.022 ms  0.022 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:46.572063', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.494 ms  0.562 ms  0.314 ms\n 2  192.168.0.2 (192.168.0.2)  0.776 ms  1.574 ms  1.602 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 21:03:46.461163', 'stderr': '', 'delta': '0:00:00.110900', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.494 ms  0.562 ms  0.314 ms', ' 2  192.168.0.2 (192.168.0.2)  0.776 ms  1.574 ms  1.602 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:47.796249', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.0.1)  0.053 ms  0.020 ms  0.025 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:03:47.737903', 'stderr': '', 'delta': '0:00:00.058346', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.0.1)  0.053 ms  0.020 ms  0.025 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:47.978765', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  192.168.0.1 (192.168.0.1)  6.443 ms  5.860 ms  5.577 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:03:47.919419', 'stderr': '', 'delta': '0:00:00.059346', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  192.168.0.1 (192.168.0.1)  6.443 ms  5.860 ms  5.577 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:48.047372', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  192.168.0.1 (192.168.0.1)  2.308 ms  0.406 ms  0.264 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:03:47.976143', 'stderr': '', 'delta': '0:00:00.071229', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  192.168.0.1 (192.168.0.1)  2.308 ms  0.406 ms  0.264 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:47.907967', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  2.718 ms  2.468 ms  0.525 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 21:03:47.839627', 'stderr': '', 'delta': '0:00:00.068340', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  2.718 ms  2.468 ms  0.525 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:54.198596', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.528 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:03:49.137093', 'stderr': '', 'delta': '0:00:05.061503', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.528 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:49.105268', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.255.2)  0.046 ms  0.019 ms  0.018 ms', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:03:49.047731', 'stderr': '', 'delta': '0:00:00.057537', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.255.2)  0.046 ms  0.019 ms  0.018 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:54.372389', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.587 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:03:49.316787', 'stderr': '', 'delta': '0:00:05.055602', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.587 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:54.260566', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  4.689 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 21:03:49.197731', 'stderr': '', 'delta': '0:00:05.062835', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  4.689 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:55.078434', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  inetRouter (192.168.255.1)  0.072 ms  0.031 ms  0.031 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:03:55.021240', 'stderr': '', 'delta': '0:00:00.057194', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  inetRouter (192.168.255.1)  0.072 ms  0.031 ms  0.031 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:49.788066', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.366 ms  0.988 ms  0.771 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:03:49.739917', 'stderr': '', 'delta': '0:00:00.048149', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.366 ms  0.988 ms  0.771 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:55.240843', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  1.028 ms  3.561 ms  2.751 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:03:55.188317', 'stderr': '', 'delta': '0:00:00.052526', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  1.028 ms  3.561 ms  2.751 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:03:55.196211', 'stdout': 'traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.409 ms  0.294 ms  0.735 ms\n 2  192.168.255.1 (192.168.255.1)  3.756 ms  4.007 ms  4.866 ms', 'cmd': 'traceroute 192.168.255.1', 'rc': 0, 'start': '2021-09-04 21:03:55.104509', 'stderr': '', 'delta': '0:00:00.091702', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.409 ms  0.294 ms  0.735 ms', ' 2  192.168.255.1 (192.168.255.1)  3.756 ms  4.007 ms  4.866 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.1', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:04:07.065294', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  192.168.100.1 (192.168.100.1)  2.290 ms  2.948 ms  3.258 ms\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.311 ms  13.150 ms  12.945 ms\n 6  212.48.194.212 (212.48.194.212)  17.015 ms  15.851 ms  14.945 ms\n 7  188.254.2.6 (188.254.2.6)  39.992 ms  23.775 ms  25.206 ms\n 8  87.226.194.47 (87.226.194.47)  29.477 ms  25.309 ms  25.607 ms\n 9  74.125.244.180 (74.125.244.180)  33.664 ms 74.125.244.132 (74.125.244.132)  22.222 ms 74.125.244.180 (74.125.244.180)  30.831 ms\n10  216.239.48.163 (216.239.48.163)  26.591 ms 72.14.232.85 (72.14.232.85)  28.457 ms  49.171 ms\n11  142.251.51.187 (142.251.51.187)  40.265 ms 172.253.64.53 (172.253.64.53)  28.247 ms 172.253.51.223 (172.253.51.223)  27.626 ms\n12  * 172.253.64.57 (172.253.64.57)  28.623 ms *\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  dns.google (8.8.8.8)  32.566 ms  33.407 ms *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:03:50.390135', 'stderr': '', 'delta': '0:00:16.675159', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  * * *', ' 2  * * *', ' 3  * * *', ' 4  192.168.100.1 (192.168.100.1)  2.290 ms  2.948 ms  3.258 ms', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.311 ms  13.150 ms  12.945 ms', ' 6  212.48.194.212 (212.48.194.212)  17.015 ms  15.851 ms  14.945 ms', ' 7  188.254.2.6 (188.254.2.6)  39.992 ms  23.775 ms  25.206 ms', ' 8  87.226.194.47 (87.226.194.47)  29.477 ms  25.309 ms  25.607 ms', ' 9  74.125.244.180 (74.125.244.180)  33.664 ms 74.125.244.132 (74.125.244.132)  22.222 ms 74.125.244.180 (74.125.244.180)  30.831 ms', '10  216.239.48.163 (216.239.48.163)  26.591 ms 72.14.232.85 (72.14.232.85)  28.457 ms  49.171 ms', '11  142.251.51.187 (142.251.51.187)  40.265 ms 172.253.64.53 (172.253.64.53)  28.247 ms 172.253.51.223 (172.253.51.223)  27.626 ms', '12  * 172.253.64.57 (172.253.64.57)  28.623 ms *', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  dns.google (8.8.8.8)  32.566 ms  33.407 ms *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [inetRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:04:06.949908', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (10.0.2.2)  0.424 ms  0.212 ms  0.285 ms\n 2  router.asus.com (192.168.101.1)  0.737 ms  0.527 ms  0.652 ms\n 3  192.168.100.1 (192.168.100.1)  1.485 ms  2.082 ms  2.562 ms\n 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  16.900 ms  16.690 ms  16.522 ms\n 5  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  16.125 ms 212.48.194.212 (212.48.194.212)  15.809 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.554 ms\n 6  188.254.2.6 (188.254.2.6)  32.487 ms 188.254.2.4 (188.254.2.4)  21.833 ms 188.254.2.6 (188.254.2.6)  23.810 ms\n 7  87.226.194.47 (87.226.194.47)  23.940 ms  25.059 ms  25.492 ms\n 8  74.125.244.132 (74.125.244.132)  55.972 ms 74.125.244.180 (74.125.244.180)  55.799 ms  55.532 ms\n 9  216.239.48.163 (216.239.48.163)  29.879 ms 72.14.232.85 (72.14.232.85)  29.608 ms 216.239.48.163 (216.239.48.163)  43.248 ms\n10  172.253.51.239 (172.253.51.239)  80.704 ms 216.239.57.229 (216.239.57.229)  55.550 ms 216.239.62.107 (216.239.62.107)  59.159 ms\n11  216.239.48.85 (216.239.48.85)  58.789 ms 172.253.51.249 (172.253.51.249)  75.842 ms 172.253.51.243 (172.253.51.243)  29.377 ms\n12  * * *\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * dns.google (8.8.8.8)  38.334 ms *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:03:55.944358', 'stderr': '', 'delta': '0:00:11.005550', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (10.0.2.2)  0.424 ms  0.212 ms  0.285 ms', ' 2  router.asus.com (192.168.101.1)  0.737 ms  0.527 ms  0.652 ms', ' 3  192.168.100.1 (192.168.100.1)  1.485 ms  2.082 ms  2.562 ms', ' 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  16.900 ms  16.690 ms  16.522 ms', ' 5  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  16.125 ms 212.48.194.212 (212.48.194.212)  15.809 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.554 ms', ' 6  188.254.2.6 (188.254.2.6)  32.487 ms 188.254.2.4 (188.254.2.4)  21.833 ms 188.254.2.6 (188.254.2.6)  23.810 ms', ' 7  87.226.194.47 (87.226.194.47)  23.940 ms  25.059 ms  25.492 ms', ' 8  74.125.244.132 (74.125.244.132)  55.972 ms 74.125.244.180 (74.125.244.180)  55.799 ms  55.532 ms', ' 9  216.239.48.163 (216.239.48.163)  29.879 ms 72.14.232.85 (72.14.232.85)  29.608 ms 216.239.48.163 (216.239.48.163)  43.248 ms', '10  172.253.51.239 (172.253.51.239)  80.704 ms 216.239.57.229 (216.239.57.229)  55.550 ms 216.239.62.107 (216.239.62.107)  59.159 ms', '11  216.239.48.85 (216.239.48.85)  58.789 ms 172.253.51.249 (172.253.51.249)  75.842 ms 172.253.51.243 (172.253.51.243)  29.377 ms', '12  * * *', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * dns.google (8.8.8.8)  38.334 ms *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:04:11.889695', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  1.106 ms  0.781 ms  0.568 ms\n 2  * * *\n 3  * * *\n 4  * * *\n 5  * * *\n 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.721 ms  19.603 ms  19.377 ms\n 7  212.48.194.212 (212.48.194.212)  18.130 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  18.735 ms 212.48.194.212 (212.48.194.212)  8.562 ms\n 8  188.254.2.4 (188.254.2.4)  30.507 ms 188.254.2.6 (188.254.2.6)  31.055 ms 188.254.2.4 (188.254.2.4)  30.861 ms\n 9  87.226.194.47 (87.226.194.47)  28.277 ms  24.258 ms  25.256 ms\n10  74.125.244.132 (74.125.244.132)  28.342 ms  31.070 ms 74.125.244.180 (74.125.244.180)  31.301 ms\n11  216.239.48.163 (216.239.48.163)  29.484 ms  27.831 ms 72.14.232.85 (72.14.232.85)  27.563 ms\n12  142.251.51.187 (142.251.51.187)  53.750 ms 142.250.233.27 (142.250.233.27)  33.434 ms 216.239.42.21 (216.239.42.21)  31.695 ms\n13  142.250.236.77 (142.250.236.77)  31.886 ms * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  * * *\n22  * dns.google (8.8.8.8)  40.920 ms  40.809 ms', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:03:56.028264', 'stderr': '', 'delta': '0:00:15.861431', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  1.106 ms  0.781 ms  0.568 ms', ' 2  * * *', ' 3  * * *', ' 4  * * *', ' 5  * * *', ' 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.721 ms  19.603 ms  19.377 ms', ' 7  212.48.194.212 (212.48.194.212)  18.130 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  18.735 ms 212.48.194.212 (212.48.194.212)  8.562 ms', ' 8  188.254.2.4 (188.254.2.4)  30.507 ms 188.254.2.6 (188.254.2.6)  31.055 ms 188.254.2.4 (188.254.2.4)  30.861 ms', ' 9  87.226.194.47 (87.226.194.47)  28.277 ms  24.258 ms  25.256 ms', '10  74.125.244.132 (74.125.244.132)  28.342 ms  31.070 ms 74.125.244.180 (74.125.244.180)  31.301 ms', '11  216.239.48.163 (216.239.48.163)  29.484 ms  27.831 ms 72.14.232.85 (72.14.232.85)  27.563 ms', '12  142.251.51.187 (142.251.51.187)  53.750 ms 142.250.233.27 (142.250.233.27)  33.434 ms 216.239.42.21 (216.239.42.21)  31.695 ms', '13  142.250.236.77 (142.250.236.77)  31.886 ms * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  * * *', '22  * dns.google (8.8.8.8)  40.920 ms  40.809 ms'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 21:04:12.151779', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  * * *\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  10.916 ms  13.784 ms  13.850 ms\n 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  24.028 ms 212.48.194.212 (212.48.194.212)  13.412 ms  10.962 ms\n 7  188.254.2.4 (188.254.2.4)  27.613 ms  22.981 ms  23.283 ms\n 8  87.226.194.47 (87.226.194.47)  34.496 ms  27.235 ms  27.608 ms\n 9  74.125.244.180 (74.125.244.180)  33.911 ms  30.661 ms 74.125.244.132 (74.125.244.132)  28.858 ms\n10  216.239.48.163 (216.239.48.163)  30.837 ms 72.14.232.85 (72.14.232.85)  25.981 ms  23.472 ms\n11  72.14.235.193 (72.14.235.193)  38.948 ms 142.251.61.221 (142.251.61.221)  28.988 ms 172.253.51.221 (172.253.51.221)  30.124 ms\n12  216.239.54.201 (216.239.54.201)  29.225 ms 216.239.47.201 (216.239.47.201)  37.757 ms *\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  dns.google (8.8.8.8)  39.155 ms *  38.800 ms', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 21:03:56.121136', 'stderr': '', 'delta': '0:00:16.030643', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  * * *', ' 2  * * *', ' 3  * * *', ' 4  * * *', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  10.916 ms  13.784 ms  13.850 ms', ' 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  24.028 ms 212.48.194.212 (212.48.194.212)  13.412 ms  10.962 ms', ' 7  188.254.2.4 (188.254.2.4)  27.613 ms  22.981 ms  23.283 ms', ' 8  87.226.194.47 (87.226.194.47)  34.496 ms  27.235 ms  27.608 ms', ' 9  74.125.244.180 (74.125.244.180)  33.911 ms  30.661 ms 74.125.244.132 (74.125.244.132)  28.858 ms', '10  216.239.48.163 (216.239.48.163)  30.837 ms 72.14.232.85 (72.14.232.85)  25.981 ms  23.472 ms', '11  72.14.235.193 (72.14.235.193)  38.948 ms 142.251.61.221 (142.251.61.221)  28.988 ms 172.253.51.221 (172.253.51.221)  30.124 ms', '12  216.239.54.201 (216.239.54.201)  29.225 ms 216.239.47.201 (216.239.47.201)  37.757 ms *', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  dns.google (8.8.8.8)  39.155 ms *  38.800 ms'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
centralRouter              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouter                 : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

* промежуточный тест доступности 192.168.0.1


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  2.718 ms  2.468 ms  0.525 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  centralRouter (192.168.0.1)  0.053 ms  0.020 ms  0.025 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  6.443 ms  5.860 ms  5.577 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  2.308 ms  0.406 ms  0.264 ms
```

</details>

* промежуточный тес доступности 192.168.0.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  centralServer (192.168.0.2)  0.074 ms  0.022 ms  0.022 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.0.2 (192.168.0.2)  0.475 ms  0.157 ms  0.250 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.494 ms  0.562 ms  0.314 ms
 2  192.168.0.2 (192.168.0.2)  0.776 ms  1.574 ms  1.602 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  1.241 ms  0.870 ms  1.103 ms
 2  192.168.0.2 (192.168.0.2)  1.557 ms  1.281 ms  1.415 ms
```

</details>

* промежуточный тест доступности 192.168.255.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  4.689 ms * *
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  centralRouter (192.168.255.2)  0.046 ms  0.019 ms  0.018 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.528 ms * *
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.587 ms * *
```

</details>

* промежуточный тест доступности 192.168.255.1


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.409 ms  0.294 ms  0.735 ms
 2  192.168.255.1 (192.168.255.1)  3.756 ms  4.007 ms  4.866 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.366 ms  0.988 ms  0.771 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  inetRouter (192.168.255.1)  0.072 ms  0.031 ms  0.031 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.255.1 (192.168.255.1), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  1.028 ms  3.561 ms  2.751 ms
```

</details>

* промежуточный тест доступности 8.8.8.8 (это выход во вне)


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  1.106 ms  0.781 ms  0.568 ms
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  14.721 ms  19.603 ms  19.377 ms
 7  212.48.194.212 (212.48.194.212)  18.130 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  18.735 ms 212.48.194.212 (212.48.194.212)  8.562 ms
 8  188.254.2.4 (188.254.2.4)  30.507 ms 188.254.2.6 (188.254.2.6)  31.055 ms 188.254.2.4 (188.254.2.4)  30.861 ms
 9  87.226.194.47 (87.226.194.47)  28.277 ms  24.258 ms  25.256 ms
10  74.125.244.132 (74.125.244.132)  28.342 ms  31.070 ms 74.125.244.180 (74.125.244.180)  31.301 ms
11  216.239.48.163 (216.239.48.163)  29.484 ms  27.831 ms 72.14.232.85 (72.14.232.85)  27.563 ms
12  142.251.51.187 (142.251.51.187)  53.750 ms 142.250.233.27 (142.250.233.27)  33.434 ms 216.239.42.21 (216.239.42.21)  31.695 ms
13  142.250.236.77 (142.250.236.77)  31.886 ms * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * dns.google (8.8.8.8)  40.920 ms  40.809 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  192.168.100.1 (192.168.100.1)  2.290 ms  2.948 ms  3.258 ms
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.311 ms  13.150 ms  12.945 ms
 6  212.48.194.212 (212.48.194.212)  17.015 ms  15.851 ms  14.945 ms
 7  188.254.2.6 (188.254.2.6)  39.992 ms  23.775 ms  25.206 ms
 8  87.226.194.47 (87.226.194.47)  29.477 ms  25.309 ms  25.607 ms
 9  74.125.244.180 (74.125.244.180)  33.664 ms 74.125.244.132 (74.125.244.132)  22.222 ms 74.125.244.180 (74.125.244.180)  30.831 ms
10  216.239.48.163 (216.239.48.163)  26.591 ms 72.14.232.85 (72.14.232.85)  28.457 ms  49.171 ms
11  142.251.51.187 (142.251.51.187)  40.265 ms 172.253.64.53 (172.253.64.53)  28.247 ms 172.253.51.223 (172.253.51.223)  27.626 ms
12  * 172.253.64.57 (172.253.64.57)  28.623 ms *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  dns.google (8.8.8.8)  32.566 ms  33.407 ms *
```

</details>

<details><summary>см. со стороны inetRouterSecond (все равно идет через inetRouter)</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  10.916 ms  13.784 ms  13.850 ms
 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  24.028 ms 212.48.194.212 (212.48.194.212)  13.412 ms  10.962 ms
 7  188.254.2.4 (188.254.2.4)  27.613 ms  22.981 ms  23.283 ms
 8  87.226.194.47 (87.226.194.47)  34.496 ms  27.235 ms  27.608 ms
 9  74.125.244.180 (74.125.244.180)  33.911 ms  30.661 ms 74.125.244.132 (74.125.244.132)  28.858 ms
10  216.239.48.163 (216.239.48.163)  30.837 ms 72.14.232.85 (72.14.232.85)  25.981 ms  23.472 ms
11  72.14.235.193 (72.14.235.193)  38.948 ms 142.251.61.221 (142.251.61.221)  28.988 ms 172.253.51.221 (172.253.51.221)  30.124 ms
12  216.239.54.201 (216.239.54.201)  29.225 ms 216.239.47.201 (216.239.47.201)  37.757 ms *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  dns.google (8.8.8.8)  39.155 ms *  38.800 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (10.0.2.2)  0.424 ms  0.212 ms  0.285 ms
 2  router.asus.com (192.168.101.1)  0.737 ms  0.527 ms  0.652 ms
 3  192.168.100.1 (192.168.100.1)  1.485 ms  2.082 ms  2.562 ms
 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  16.900 ms  16.690 ms  16.522 ms
 5  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  16.125 ms 212.48.194.212 (212.48.194.212)  15.809 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  15.554 ms
 6  188.254.2.6 (188.254.2.6)  32.487 ms 188.254.2.4 (188.254.2.4)  21.833 ms 188.254.2.6 (188.254.2.6)  23.810 ms
 7  87.226.194.47 (87.226.194.47)  23.940 ms  25.059 ms  25.492 ms
 8  74.125.244.132 (74.125.244.132)  55.972 ms 74.125.244.180 (74.125.244.180)  55.799 ms  55.532 ms
 9  216.239.48.163 (216.239.48.163)  29.879 ms 72.14.232.85 (72.14.232.85)  29.608 ms 216.239.48.163 (216.239.48.163)  43.248 ms
10  172.253.51.239 (172.253.51.239)  80.704 ms 216.239.57.229 (216.239.57.229)  55.550 ms 216.239.62.107 (216.239.62.107)  59.159 ms
11  216.239.48.85 (216.239.48.85)  58.789 ms 172.253.51.249 (172.253.51.249)  75.842 ms 172.253.51.243 (172.253.51.243)  29.377 ms
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * dns.google (8.8.8.8)  38.334 ms *
```

</details>
    
### Тук-тук-тук

Проверка дефолтного SSH доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
    # ECDSA key fingerprint is SHA256:N66NFgJ/P/VQ2eKrzP4kLUe0RbbzeQ/xA4rn/hHIGuw.
    # ECDSA key fingerprint is MD5:1c:0d:da:e0:59:07:f7:52:d4:bd:c4:93:06:9d:33:c1.
    # Are you sure you want to continue connecting (yes/no)? yes                    <--- yes
    # Warning: Permanently added '192.168.255.1' (ECDSA) to the list of known hosts.
    # Permission denied (publickey,gssapi-keyex,gssapi-with-mic).                   <--- omg
    exit
exit
```

Настройка парольного доступа

```shell
cd ../ansible
ansible-playbook playbooks/task_001_password_auth.yml > ../files/task_001_password_auth.txt
```


<details><summary>см. лог playbooks/task_001_password_auth.yml</summary>

```text

PLAY [Set up /etc/ssh/sshd_config PasswordAuthentication yes] ******************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | content] ********
changed: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it does not set up] ***
skipping: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it was set up early] ***
changed: [inetRouter]

RUNNING HANDLER [../roles/task_001_password_auth : systemctl-restart-sshd] *****
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=4    changed=3    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   


```

</details>

Проверка работы парольного доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # vagrant@192.168.255.1's password: 
    # Last login: Sun Aug 29 19:48:43 2021 from 10.0.2.2
    # [vagrant@inetRouter ~]$  <-- OK
    exit
exit
```

```shell
cd ../ansible
```

Реализация "тук-тук-тук" на цели доступа

```shell
ansible-playbook playbooks/task_001_port_knocking_target.yml > ../files/task_001_port_knocking_target.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_target.yml</summary>

```text

PLAY [Configure port-knocking target] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Copy port-knocking rules file] ***
changed: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Apply and save port-knocking rules] ***
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

ПО для "тук-тук-тук" на клиенте, осуществляющем доступ

```shell
ansible-playbook playbooks/task_001_port_knocking_client.yml > ../files/task_001_port_knocking_client.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_client.yml</summary>

```text

PLAY [Set up port-knocking client program] *************************************

TASK [Gathering Facts] *********************************************************
ok: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Install Nmap] *******************
changed: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Copy port knocking file for clients] ***
changed: [centralRouter]

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работоспособности "тук-тук-тук"

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    #   ssh: connect to host 192.168.255.1 port 22: Connection timed out    <--- бет тук-тук-тук не откроет
    ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.255.1
    #   vagrant@192.168.255.1's password:                                   <--- с тук-тук-тук открыл
    #   Last login: Sun Aug 29 22:33:38 2021 from 10.0.2.2
    #   [vagrant@inetRouter ~]$ 
    exit
exit  
```

Видоизменил [port_knocking.sh](./027_2/ansible/roles/task_001_port_knocking_client/files/port_knocking.sh)

<details><summary>см. port_knocking.sh</summary>

```shell
#!/bin/bash
# ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.0.1

# Проверка на переданный параметр
USAGE="SYNOPSIS: ./port_knocking.sh <TARGET_IP> <port_1> [<port_2> <port_3> ...]"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter TARGET_IP. "
    echo $USAGE
    exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, some knock-port id needed. "
    echo $USAGE
    exit 1
fi

TARGET_IP=$1
shift
for ARG in "$@"
do
  sudo nmap -Pn --max-retries 0 -p $ARG $TARGET_IP # !! SUDO - MUST BE
#  sudo ssh -o ConnectTimeout=1 $TARGET_IP -p $ARG
done
```

</details>

Замечание:
* port_knocking.sh требует установки nmap на клиенте, а можно иными? curl? или `ssh <IP> -p <PORT>` не вышло.
* port_knocking.sh необходим sudo для nmap, поведение c/без разнится, связано с правами на локальный сокет?

Внимание: если захотите проверить сетевую связность тут, как я сделал выше, то будет необходимо сделать "тук-тук-тук"

Развертка nginx

```shell
cd ../ansible
ansible-playbook playbooks/task_002_nginx.yml > ../files/task_002_nginx.txt
```


<details><summary>см. лог playbooks/task_002_nginx.yml</summary>

```text

PLAY [Deploy nginx] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [centralServer]

TASK [../roles/task_002_nginx : Install EPEL Repo package from standart repo] ***
changed: [centralServer]

TASK [../roles/task_002_nginx : Install nginx] *********************************
changed: [centralServer]

TASK [../roles/task_002_nginx : Configure nginx] *******************************
changed: [centralServer]

TASK [../roles/task_002_nginx : index.html] ************************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : start nginx] ************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : restart nginx] **********************
changed: [centralServer]

PLAY RECAP *********************************************************************
centralServer              : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проброс порта 80 --> 8080

```shell
ansible-playbook playbooks/task_002_port_forwarding.yml > ../files/playbooks_task_002_port_forwarding.txt
```


<details><summary>см. лог playbooks/task_002_port_forwarding.yml</summary>

```text

PLAY [Configure port forwarding] ***********************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables dnat] ***********************
changed: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables snat] ***********************
changed: [inetRouterSecond]

PLAY RECAP *********************************************************************
inetRouterSecond           : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 192.168.0.2:80 внутри сети

```shell
ansible-playbook playbooks/test_003_http_connectivity.yml > ../files/test_003_http_connectivity.txt
```


<details><summary>см. лог playbooks/test_003_http_connectivity.yml</summary>

```text

PLAY [Playbook of internal http connectivity tests] ****************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralServer]
ok: [centralRouter]

TASK [../roles/test_003_http_connectivity : test | http | curl] ****************
changed: [centralServer]
changed: [inetRouterSecond]
changed: [centralRouter]

TASK [../roles/test_003_http_connectivity : test | http | index page content] ***
ok: [inetRouterSecond] => {
    "msg": "Hello from centralServer"
}
ok: [centralRouter] => {
    "msg": "Hello from centralServer"
}
ok: [centralServer] => {
    "msg": "Hello from centralServer"
}

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 8080 извне сети

```shell
cd ../vm
curl -I 127.0.0.1:8080 > ../files/curl_localhost_8080.md
curl 127.0.0.1:8080 >> ../files/curl_localhost_8080.md
```

Лог `curl_localhost_8080.md`:

```text


HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Sat, 04 Sep 2021 19:42:16 GMT
Content-Type: text/html
Content-Length: 24
Last-Modified: Sat, 04 Sep 2021 19:41:02 GMT
Connection: keep-alive
ETag: "6133cbce-18"
Accept-Ranges: bytes

Hello from centralServer
```
