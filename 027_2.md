# Фильтрация трафика - firewalld, iptables

Сценарии iptables:
* реализовать knocking port
* centralRouter может попасть на ssh inetRouter через knock скрипт пример в материалах.
* добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
* запустить nginx на centralServer.
* пробросить 80й порт на inetRouter2 8080.
* дефолт в инет оставить через inetRouter.

Формат сдачи ДЗ - vagrant + ansible
* реализовать проход на 80й порт без маскарадинга

Критерии оценки:

Статус "Принято" ставится при выполнении всех основных условий.
Рекомендуем сдать до: 16.08.2021

## Исполнение

[Vagrantfile](./027_2/vm/Vagrantfile)

<details><summary>см. Vagrantfile</summary>

```text
# -*- mode: ruby -*-
# vim: set ft=ruby :

MACHINES = {
    :inetRouter => {
        :box_name => "centos/7",
        # :public => {:ip => '10.10.10.1', :adapter => 1, :bridge => "enp4s0"},
        :net => [
            {ip: '192.168.255.1',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :inetRouterSecond => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.3',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
        ]
    },
    :centralRouter => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.255.2',   adapter: 2, netmask: "255.255.255.240", virtualbox__intnet: "inet-router-net"},
            {ip: '192.168.0.1',     adapter: 3, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
    :centralServer => {
        :box_name => "centos/7",
        :net => [
            {ip: '192.168.0.2',     adapter: 2, netmask: "255.255.255.252", virtualbox__intnet: "central-router-net"},
        ]
    },
}

Vagrant.configure("2") do |config|

    MACHINES.each do |boxname, boxconfig|
        config.gatling.rsync_on_startup = false
        config.vm.define boxname do |box|
            box.vm.provision "shell", run: "always", inline: <<-SHELL

                systemctl stop NetworkManager    # <--- No once anymore
                systemctl disable NetworkManager # <--- No once anymore
                systemctl enable network.service
                systemctl start network.service

                yum install -y traceroute
                yum install -y nano
            SHELL

            case boxname.to_s
            when "inetRouterSecond"
                box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
            end

            config.vm.provider "virtualbox" do |v|
                v.memory = 256
                v.cpus = 1
            end

            box.vm.box = boxconfig[:box_name]
            box.vm.host_name = boxname.to_s

            boxconfig[:net].each do |ipconf|
                box.vm.network "private_network", ipconf
            end

            if boxconfig.key?(:public)
                box.vm.network "public_network", boxconfig[:public]
            end

            box.vm.provision "shell", inline: <<-SHELL
                mkdir -p ~root/.ssh
                cp ~vagrant/.ssh/auth* ~root/.ssh
            SHELL

        end
    end
end

```

</details>

Ключевым моментом проверки доступности Web-сервера через inetRouterSecond является
```shell
case boxname.to_s
when "inetRouterSecond"
    box.vm.network 'forwarded_port', guest: 8080, host: 8080, host_ip: '127.0.0.1'
end
```

Разворачивание инфраструктуры

```shell
pwd
# ./027_2/vm

vagrant destroy -f && vagrant up 
# ...

python3 v2a.py -o ../ansible/inventories/hosts

cd ../ansible/
pwd
# ./027_2/ansible
    
```

Шлюзы по-умолчанию, маршруты, форвардинг:

```shell
ansible-playbook playbooks/routing.yml > ../files/playbooks_routing.txt
```


<details><summary>см. лог playbooks/routing.yml</summary>

```text

PLAY [Playbook of ethX gateway config] *****************************************

TASK [Gathering Facts] *********************************************************
ok: [centralServer]
ok: [inetRouter]
ok: [centralRouter]
ok: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network | "NOZEROCONF=yes" | I don't want 169.254.0.0/16 network at default] ***
changed: [centralRouter]
changed: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | delete route files] ***
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [inetRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | create needed route files] ***
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/route-* | set route] ***
changed: [inetRouterSecond] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})
changed: [inetRouter] => (item={'interface': 'eth1', 'nw': '192.168.0.0/24', 'via': '192.168.255.2'})

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [centralServer]
changed: [inetRouterSecond]
changed: [inetRouter]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | set up if did not set] ***
skipping: [inetRouter]
changed: [centralRouter]
changed: [centralServer]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | GATEWAY=<ip> | replace] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | content] ***
changed: [inetRouter]
changed: [centralRouter]
changed: [centralServer]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if did not set] ***
changed: [inetRouterSecond]
changed: [inetRouter]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-eth0 | DEFROUTE=no | if "yes"] ***
ok: [centralServer]
ok: [centralRouter]
ok: [inetRouterSecond]
ok: [inetRouter]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | content] ***
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes  | if did not set] ***
skipping: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/routing : /etc/sysconfig/network-scripts/ifcfg-ethX | DEFROUTE=yes | if "no"] ***
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]
changed: [inetRouter]

TASK [../roles/routing : /etc/sysctl.conf | content] ***************************
changed: [inetRouter]
changed: [centralServer]
changed: [centralRouter]
changed: [inetRouterSecond]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if does not yet] ***
skipping: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]

TASK [../roles/routing : /etc/sysctl.conf | forwarding set up | if it was early] ***
skipping: [inetRouter]
skipping: [inetRouterSecond]
skipping: [centralRouter]
skipping: [centralServer]

RUNNING HANDLER [../roles/routing : systemctl-restart-network] *****************
changed: [centralServer]
changed: [inetRouter]
changed: [inetRouterSecond]
changed: [centralRouter]

PLAY RECAP *********************************************************************
centralRouter              : ok=13   changed=11   unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
centralServer              : ok=12   changed=10   unreachable=0    failed=0    skipped=6    rescued=0    ignored=0   
inetRouter                 : ok=14   changed=12   unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   
inetRouterSecond           : ok=15   changed=13   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   


```

</details>

Выходная нода (маскарадинг):

```shell
ansible-playbook playbooks/internet-router.yml  > ../files/playbooks_internet-router.txt
```


<details><summary>см. лог playbooks/internet-router.txt</summary>

```text

PLAY [Playbook of internet-node server initialization] *************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [inetRouter]

TASK [../roles/internet-router : iptables masquerading] ************************
changed: [inetRouterSecond]
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Промежуточный тест сетевой связности и проверка inetRouter как единой точки выхода во вне

```shell
# если не сделать, то после тук-тук-тук не попадем
ansible-playbook playbooks/test_001_network_connectivity.yml > ../files/playbooks_test_001_network_connectivity.txt
```


<details><summary>см. лог playbooks/test_001_network_connectivity.yml</summary>

```text

PLAY [Playbook of tests] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralRouter]
ok: [centralServer]
fatal: [inetRouter]: UNREACHABLE! => {"changed": false, "msg": "Failed to connect to the host via ssh: ssh: connect to host 127.0.0.1 port 2222: Connection timed out", "unreachable": true}

TASK [../roles/test_001_network_connectivity : test | demostration] ************
ok: [inetRouterSecond] => {
    "msg": "Run from inventory: inetRouterSecond"
}
ok: [centralRouter] => {
    "msg": "Run from inventory: centralRouter"
}
ok: [centralServer] => {
    "msg": "Run from inventory: centralServer"
}

TASK [../roles/test_001_network_connectivity : test | traceroute foreign host] ***
changed: [centralServer] => (item=192.168.0.2)
changed: [inetRouterSecond] => (item=192.168.0.2)
changed: [centralRouter] => (item=192.168.0.2)
changed: [centralServer] => (item=192.168.0.1)
changed: [centralRouter] => (item=192.168.0.1)
changed: [inetRouterSecond] => (item=192.168.0.1)
changed: [centralRouter] => (item=192.168.255.2)
changed: [centralServer] => (item=192.168.255.2)
changed: [inetRouterSecond] => (item=192.168.255.2)
changed: [centralRouter] => (item=8.8.8.8)
changed: [centralServer] => (item=8.8.8.8)
changed: [inetRouterSecond] => (item=8.8.8.8)

TASK [../roles/test_001_network_connectivity : test | result file output] ******
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:29.792956', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  centralServer (192.168.0.2)  0.060 ms  0.035 ms  0.036 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 20:33:29.726406', 'stderr': '', 'delta': '0:00:00.066550', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  centralServer (192.168.0.2)  0.060 ms  0.035 ms  0.036 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:29.809799', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.0.2 (192.168.0.2)  0.309 ms  0.165 ms  0.177 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 20:33:29.751392', 'stderr': '', 'delta': '0:00:00.058407', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.0.2 (192.168.0.2)  0.309 ms  0.165 ms  0.177 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:29.805810', 'stdout': 'traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.710 ms  0.193 ms  0.448 ms\n 2  192.168.0.2 (192.168.0.2)  1.227 ms  1.050 ms  0.575 ms', 'cmd': 'traceroute 192.168.0.2', 'rc': 0, 'start': '2021-09-04 20:33:29.691195', 'stderr': '', 'delta': '0:00:00.114615', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.710 ms  0.193 ms  0.448 ms', ' 2  192.168.0.2 (192.168.0.2)  1.227 ms  1.050 ms  0.575 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:30.669821', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.343 ms  0.259 ms  0.274 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 20:33:30.602048', 'stderr': '', 'delta': '0:00:00.067773', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.343 ms  0.259 ms  0.274 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:30.711522', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.0.1)  0.045 ms  0.020 ms  0.020 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 20:33:30.663537', 'stderr': '', 'delta': '0:00:00.047985', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.0.1)  0.045 ms  0.020 ms  0.020 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:30.729247', 'stdout': 'traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets\n 1  192.168.0.1 (192.168.0.1)  0.474 ms  0.473 ms  0.321 ms', 'cmd': 'traceroute 192.168.0.1', 'rc': 0, 'start': '2021-09-04 20:33:30.665117', 'stderr': '', 'delta': '0:00:00.064130', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.0.1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets', ' 1  192.168.0.1 (192.168.0.1)  0.474 ms  0.473 ms  0.321 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.0.1', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:36.522215', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  * * *\n 5  * * *\n 6  * 192.168.255.2 (192.168.255.2)  3.920 ms  3.634 ms', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 20:33:31.428727', 'stderr': '', 'delta': '0:00:05.093488', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  * * *', ' 2  * * *', ' 3  * * *', ' 4  * * *', ' 5  * * *', ' 6  * 192.168.255.2 (192.168.255.2)  3.920 ms  3.634 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:31.567447', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  centralRouter (192.168.255.2)  0.036 ms  0.014 ms  0.015 ms', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 20:33:31.507162', 'stderr': '', 'delta': '0:00:00.060285', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  centralRouter (192.168.255.2)  0.036 ms  0.014 ms  0.015 ms'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:36.642046', 'stdout': 'traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets\n 1  192.168.255.2 (192.168.255.2)  0.580 ms * *', 'cmd': 'traceroute 192.168.255.2', 'rc': 0, 'start': '2021-09-04 20:33:31.591217', 'stderr': '', 'delta': '0:00:05.050829', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 192.168.255.2', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets', ' 1  192.168.255.2 (192.168.255.2)  0.580 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '192.168.255.2', 'ansible_loop_var': 'item'})
changed: [centralServer -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:53.616120', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.0.1)  0.754 ms * *\n 2  192.168.255.1 (192.168.255.1)  14.932 ms  14.771 ms  14.614 ms\n 3  * * *\n 4  * * *\n 5  * * *\n 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  21.081 ms  6.930 ms  10.850 ms\n 7  212.48.194.212 (212.48.194.212)  10.007 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  10.092 ms  20.655 ms\n 8  188.254.2.6 (188.254.2.6)  29.111 ms  31.261 ms  27.923 ms\n 9  87.226.194.47 (87.226.194.47)  26.291 ms  33.148 ms  24.543 ms\n10  74.125.244.132 (74.125.244.132)  34.101 ms 74.125.244.180 (74.125.244.180)  34.947 ms  38.694 ms\n11  142.251.61.219 (142.251.61.219)  31.513 ms 72.14.232.85 (72.14.232.85)  45.623 ms 142.251.61.219 (142.251.61.219)  37.298 ms\n12  142.251.51.187 (142.251.51.187)  36.279 ms 172.253.79.113 (172.253.79.113)  42.640 ms 172.253.51.185 (172.253.51.185)  40.743 ms\n13  216.239.42.23 (216.239.42.23)  32.409 ms * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  * * *\n22  * dns.google (8.8.8.8)  45.674 ms *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 20:33:37.472034', 'stderr': '', 'delta': '0:00:16.144086', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.0.1)  0.754 ms * *', ' 2  192.168.255.1 (192.168.255.1)  14.932 ms  14.771 ms  14.614 ms', ' 3  * * *', ' 4  * * *', ' 5  * * *', ' 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  21.081 ms  6.930 ms  10.850 ms', ' 7  212.48.194.212 (212.48.194.212)  10.007 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  10.092 ms  20.655 ms', ' 8  188.254.2.6 (188.254.2.6)  29.111 ms  31.261 ms  27.923 ms', ' 9  87.226.194.47 (87.226.194.47)  26.291 ms  33.148 ms  24.543 ms', '10  74.125.244.132 (74.125.244.132)  34.101 ms 74.125.244.180 (74.125.244.180)  34.947 ms  38.694 ms', '11  142.251.61.219 (142.251.61.219)  31.513 ms 72.14.232.85 (72.14.232.85)  45.623 ms 142.251.61.219 (142.251.61.219)  37.298 ms', '12  142.251.51.187 (142.251.51.187)  36.279 ms 172.253.79.113 (172.253.79.113)  42.640 ms 172.253.51.185 (172.253.51.185)  40.743 ms', '13  216.239.42.23 (216.239.42.23)  32.409 ms * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  * * *', '22  * dns.google (8.8.8.8)  45.674 ms *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [centralRouter -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:43.162809', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.403 ms  0.225 ms  0.355 ms\n 2  * * *\n 3  * * *\n 4  192.168.100.1 (192.168.100.1)  2.788 ms  3.360 ms  3.890 ms\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.227 ms  11.915 ms  11.801 ms\n 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  40.781 ms  21.278 ms 212.48.194.212 (212.48.194.212)  20.997 ms\n 7  188.254.2.4 (188.254.2.4)  29.079 ms  33.837 ms  33.564 ms\n 8  87.226.194.47 (87.226.194.47)  33.659 ms  44.494 ms  34.480 ms\n 9  74.125.244.180 (74.125.244.180)  44.119 ms  48.509 ms  47.131 ms\n10  216.239.48.163 (216.239.48.163)  37.550 ms 72.14.232.85 (72.14.232.85)  33.173 ms 142.251.61.219 (142.251.61.219)  32.812 ms\n11  142.251.51.187 (142.251.51.187)  53.500 ms  34.599 ms  34.361 ms\n12  172.253.51.247 (172.253.51.247)  43.027 ms 216.239.47.173 (216.239.47.173)  44.606 ms 142.250.232.179 (142.250.232.179)  38.202 ms\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  dns.google (8.8.8.8)  56.473 ms * *', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 20:33:32.141059', 'stderr': '', 'delta': '0:00:11.021750', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.403 ms  0.225 ms  0.355 ms', ' 2  * * *', ' 3  * * *', ' 4  192.168.100.1 (192.168.100.1)  2.788 ms  3.360 ms  3.890 ms', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.227 ms  11.915 ms  11.801 ms', ' 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  40.781 ms  21.278 ms 212.48.194.212 (212.48.194.212)  20.997 ms', ' 7  188.254.2.4 (188.254.2.4)  29.079 ms  33.837 ms  33.564 ms', ' 8  87.226.194.47 (87.226.194.47)  33.659 ms  44.494 ms  34.480 ms', ' 9  74.125.244.180 (74.125.244.180)  44.119 ms  48.509 ms  47.131 ms', '10  216.239.48.163 (216.239.48.163)  37.550 ms 72.14.232.85 (72.14.232.85)  33.173 ms 142.251.61.219 (142.251.61.219)  32.812 ms', '11  142.251.51.187 (142.251.51.187)  53.500 ms  34.599 ms  34.361 ms', '12  172.253.51.247 (172.253.51.247)  43.027 ms 216.239.47.173 (216.239.47.173)  44.606 ms 142.250.232.179 (142.250.232.179)  38.202 ms', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  dns.google (8.8.8.8)  56.473 ms * *'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})
changed: [inetRouterSecond -> localhost] => (item={'changed': True, 'end': '2021-09-04 20:33:53.804494', 'stdout': 'traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  gateway (192.168.255.1)  0.350 ms  0.480 ms  0.477 ms\n 2  * * *\n 3  * * *\n 4  192.168.100.1 (192.168.100.1)  5.316 ms  5.512 ms  5.871 ms\n 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  26.230 ms  26.051 ms  25.891 ms\n 6  212.48.194.212 (212.48.194.212)  32.104 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  20.610 ms 212.48.194.212 (212.48.194.212)  20.333 ms\n 7  188.254.2.6 (188.254.2.6)  41.142 ms 188.254.2.4 (188.254.2.4)  28.513 ms  40.641 ms\n 8  87.226.194.47 (87.226.194.47)  36.696 ms  40.363 ms  54.830 ms\n 9  74.125.244.132 (74.125.244.132)  40.008 ms 74.125.244.180 (74.125.244.180)  64.665 ms 74.125.244.132 (74.125.244.132)  31.627 ms\n10  72.14.232.85 (72.14.232.85)  45.303 ms 216.239.48.163 (216.239.48.163)  36.835 ms 72.14.232.85 (72.14.232.85)  28.408 ms\n11  142.251.61.221 (142.251.61.221)  39.709 ms 216.239.58.53 (216.239.58.53)  46.529 ms 216.239.42.21 (216.239.42.21)  38.840 ms\n12  * * 216.239.40.61 (216.239.40.61)  33.088 ms\n13  * * *\n14  * * *\n15  * * *\n16  * * *\n17  * * *\n18  * * *\n19  * * *\n20  * * *\n21  * * *\n22  dns.google (8.8.8.8)  30.678 ms *  33.102 ms', 'cmd': 'traceroute 8.8.8.8', 'rc': 0, 'start': '2021-09-04 20:33:37.607286', 'stderr': '', 'delta': '0:00:16.197208', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'traceroute 8.8.8.8', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets', ' 1  gateway (192.168.255.1)  0.350 ms  0.480 ms  0.477 ms', ' 2  * * *', ' 3  * * *', ' 4  192.168.100.1 (192.168.100.1)  5.316 ms  5.512 ms  5.871 ms', ' 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  26.230 ms  26.051 ms  25.891 ms', ' 6  212.48.194.212 (212.48.194.212)  32.104 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  20.610 ms 212.48.194.212 (212.48.194.212)  20.333 ms', ' 7  188.254.2.6 (188.254.2.6)  41.142 ms 188.254.2.4 (188.254.2.4)  28.513 ms  40.641 ms', ' 8  87.226.194.47 (87.226.194.47)  36.696 ms  40.363 ms  54.830 ms', ' 9  74.125.244.132 (74.125.244.132)  40.008 ms 74.125.244.180 (74.125.244.180)  64.665 ms 74.125.244.132 (74.125.244.132)  31.627 ms', '10  72.14.232.85 (72.14.232.85)  45.303 ms 216.239.48.163 (216.239.48.163)  36.835 ms 72.14.232.85 (72.14.232.85)  28.408 ms', '11  142.251.61.221 (142.251.61.221)  39.709 ms 216.239.58.53 (216.239.58.53)  46.529 ms 216.239.42.21 (216.239.42.21)  38.840 ms', '12  * * 216.239.40.61 (216.239.40.61)  33.088 ms', '13  * * *', '14  * * *', '15  * * *', '16  * * *', '17  * * *', '18  * * *', '19  * * *', '20  * * *', '21  * * *', '22  dns.google (8.8.8.8)  30.678 ms *  33.102 ms'], 'stderr_lines': [], 'failed': False, 'item': '8.8.8.8', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
centralRouter              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouter                 : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

* промежуточный тест доступности 192.168.0.1


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.343 ms  0.259 ms  0.274 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  centralRouter (192.168.0.1)  0.045 ms  0.020 ms  0.020 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  0.311 ms  0.376 ms  0.375 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.1 (192.168.0.1), 30 hops max, 60 byte packets
 1  192.168.0.1 (192.168.0.1)  0.474 ms  0.473 ms  0.321 ms
```

</details>

* промежуточный тес доступности 192.168.0.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  centralServer (192.168.0.2)  0.060 ms  0.035 ms  0.036 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.0.2 (192.168.0.2)  0.309 ms  0.165 ms  0.177 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.396 ms  0.399 ms  0.425 ms
 2  192.168.0.2 (192.168.0.2)  3.763 ms  3.473 ms  3.317 ms
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.710 ms  0.193 ms  0.448 ms
 2  192.168.0.2 (192.168.0.2)  1.227 ms  1.050 ms  0.575 ms
```

</details>

* промежуточный тест доступности 192.168.255.2


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * 192.168.255.2 (192.168.255.2)  3.920 ms  3.634 ms
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  centralRouter (192.168.255.2)  0.036 ms  0.014 ms  0.015 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.432 ms * *
```

</details>

<details><summary>см. со стороны inetRouterSecond</summary>

```text
traceroute to 192.168.255.2 (192.168.255.2), 30 hops max, 60 byte packets
 1  192.168.255.2 (192.168.255.2)  0.580 ms * *
```

</details>

* промежуточный тест доступности 8.8.8.8 (это выход во вне)


<details><summary>см. со стороны centralServer</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.754 ms * *
 2  192.168.255.1 (192.168.255.1)  14.932 ms  14.771 ms  14.614 ms
 3  * * *
 4  * * *
 5  * * *
 6  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  21.081 ms  6.930 ms  10.850 ms
 7  212.48.194.212 (212.48.194.212)  10.007 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  10.092 ms  20.655 ms
 8  188.254.2.6 (188.254.2.6)  29.111 ms  31.261 ms  27.923 ms
 9  87.226.194.47 (87.226.194.47)  26.291 ms  33.148 ms  24.543 ms
10  74.125.244.132 (74.125.244.132)  34.101 ms 74.125.244.180 (74.125.244.180)  34.947 ms  38.694 ms
11  142.251.61.219 (142.251.61.219)  31.513 ms 72.14.232.85 (72.14.232.85)  45.623 ms 142.251.61.219 (142.251.61.219)  37.298 ms
12  142.251.51.187 (142.251.51.187)  36.279 ms 172.253.79.113 (172.253.79.113)  42.640 ms 172.253.51.185 (172.253.51.185)  40.743 ms
13  216.239.42.23 (216.239.42.23)  32.409 ms * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * dns.google (8.8.8.8)  45.674 ms *
```

</details>

<details><summary>см. со стороны centralRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.403 ms  0.225 ms  0.355 ms
 2  * * *
 3  * * *
 4  192.168.100.1 (192.168.100.1)  2.788 ms  3.360 ms  3.890 ms
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  13.227 ms  11.915 ms  11.801 ms
 6  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  40.781 ms  21.278 ms 212.48.194.212 (212.48.194.212)  20.997 ms
 7  188.254.2.4 (188.254.2.4)  29.079 ms  33.837 ms  33.564 ms
 8  87.226.194.47 (87.226.194.47)  33.659 ms  44.494 ms  34.480 ms
 9  74.125.244.180 (74.125.244.180)  44.119 ms  48.509 ms  47.131 ms
10  216.239.48.163 (216.239.48.163)  37.550 ms 72.14.232.85 (72.14.232.85)  33.173 ms 142.251.61.219 (142.251.61.219)  32.812 ms
11  142.251.51.187 (142.251.51.187)  53.500 ms  34.599 ms  34.361 ms
12  172.253.51.247 (172.253.51.247)  43.027 ms 216.239.47.173 (216.239.47.173)  44.606 ms 142.250.232.179 (142.250.232.179)  38.202 ms
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  dns.google (8.8.8.8)  56.473 ms * *
```

</details>

<details><summary>см. со стороны inetRouterSecond (все равно идет через inetRouter)</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.255.1)  0.350 ms  0.480 ms  0.477 ms
 2  * * *
 3  * * *
 4  192.168.100.1 (192.168.100.1)  5.316 ms  5.512 ms  5.871 ms
 5  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  26.230 ms  26.051 ms  25.891 ms
 6  212.48.194.212 (212.48.194.212)  32.104 ms pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  20.610 ms 212.48.194.212 (212.48.194.212)  20.333 ms
 7  188.254.2.6 (188.254.2.6)  41.142 ms 188.254.2.4 (188.254.2.4)  28.513 ms  40.641 ms
 8  87.226.194.47 (87.226.194.47)  36.696 ms  40.363 ms  54.830 ms
 9  74.125.244.132 (74.125.244.132)  40.008 ms 74.125.244.180 (74.125.244.180)  64.665 ms 74.125.244.132 (74.125.244.132)  31.627 ms
10  72.14.232.85 (72.14.232.85)  45.303 ms 216.239.48.163 (216.239.48.163)  36.835 ms 72.14.232.85 (72.14.232.85)  28.408 ms
11  142.251.61.221 (142.251.61.221)  39.709 ms 216.239.58.53 (216.239.58.53)  46.529 ms 216.239.42.21 (216.239.42.21)  38.840 ms
12  * * 216.239.40.61 (216.239.40.61)  33.088 ms
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  dns.google (8.8.8.8)  30.678 ms *  33.102 ms
```

</details>

<details><summary>см. со стороны inetRouter</summary>

```text
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (10.0.2.2)  0.553 ms  0.310 ms  0.232 ms
 2  * * *
 3  * * *
 4  mrsk-bras5.sz.ip.rostelecom.ru (212.48.195.203)  16.724 ms  16.630 ms  16.689 ms
 5  pos14-0-0-s16.E320-1-VLGD.nwtelecom.ru (212.48.194.218)  16.624 ms 212.48.194.212 (212.48.194.212)  16.640 ms  16.622 ms
 6  188.254.2.6 (188.254.2.6)  45.200 ms  51.196 ms 188.254.2.4 (188.254.2.4)  50.365 ms
 7  87.226.194.47 (87.226.194.47)  49.068 ms  49.298 ms  48.762 ms
 8  74.125.244.180 (74.125.244.180)  49.138 ms  48.905 ms 74.125.244.132 (74.125.244.132)  49.180 ms
 9  72.14.232.85 (72.14.232.85)  47.944 ms 142.251.61.219 (142.251.61.219)  48.391 ms 216.239.48.163 (216.239.48.163)  27.077 ms
10  216.239.49.113 (216.239.49.113)  32.377 ms 142.251.61.221 (142.251.61.221)  32.080 ms 142.250.56.15 (142.250.56.15)  30.485 ms
11  216.239.42.23 (216.239.42.23)  32.510 ms 142.250.232.179 (142.250.232.179)  39.846 ms *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * dns.google (8.8.8.8)  36.440 ms  36.398 ms
```

</details>
    
### Тук-тук-тук

Проверка дефолтного SSH доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
    # ECDSA key fingerprint is SHA256:N66NFgJ/P/VQ2eKrzP4kLUe0RbbzeQ/xA4rn/hHIGuw.
    # ECDSA key fingerprint is MD5:1c:0d:da:e0:59:07:f7:52:d4:bd:c4:93:06:9d:33:c1.
    # Are you sure you want to continue connecting (yes/no)? yes                    <--- yes
    # Warning: Permanently added '192.168.255.1' (ECDSA) to the list of known hosts.
    # Permission denied (publickey,gssapi-keyex,gssapi-with-mic).                   <--- omg
    exit
exit
```

Настройка парольного доступа

```shell
cd ../ansible
ansible-playbook playbooks/task_001_password_auth.yml > ../files/task_001_password_auth.txt
```


<details><summary>см. лог playbooks/task_001_password_auth.yml</summary>

```text

PLAY [Set up /etc/ssh/sshd_config PasswordAuthentication yes] ******************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | content] ********
changed: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it does not set up] ***
skipping: [inetRouter]

TASK [../roles/task_001_password_auth : /etc/ssh/sshd_config | PasswordAuthentication yes | if it was set up early] ***
changed: [inetRouter]

RUNNING HANDLER [../roles/task_001_password_auth : systemctl-restart-sshd] *****
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=4    changed=3    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   


```

</details>

Проверка работы парольного доступа

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    # vagrant@192.168.255.1's password: 
    # Last login: Sun Aug 29 19:48:43 2021 from 10.0.2.2
    # [vagrant@inetRouter ~]$  <-- OK
    exit
exit
```

```shell
cd ../ansible
```

Реализация "тук-тук-тук" на цели доступа

```shell
ansible-playbook playbooks/task_001_port_knocking_target.yml > ../files/task_001_port_knocking_target.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_target.yml</summary>

```text

PLAY [Configure port-knocking target] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Copy port-knocking rules file] ***
changed: [inetRouter]

TASK [../roles/task_001_port_knocking_target : Apply and save port-knocking rules] ***
changed: [inetRouter]

PLAY RECAP *********************************************************************
inetRouter                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

ПО для "тук-тук-тук" на клиенте, осуществляющем доступ

```shell
ansible-playbook playbooks/task_001_port_knocking_client.yml > ../files/task_001_port_knocking_client.txt
```


<details><summary>см. лог playbooks/task_001_port_knocking_client.yml</summary>

```text

PLAY [Set up port-knocking client program] *************************************

TASK [Gathering Facts] *********************************************************
ok: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Install Nmap] *******************
changed: [centralRouter]

TASK [../roles/task_001_port_knocking_client : Copy port knocking file for clients] ***
changed: [centralRouter]

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работоспособности "тук-тук-тук"

```shell
cd ../vm
vagrant ssh centralRouter
    ssh 192.168.255.1
    #   ssh: connect to host 192.168.255.1 port 22: Connection timed out    <--- бет тук-тук-тук не откроет
    ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.255.1
    #   vagrant@192.168.255.1's password:                                   <--- с тук-тук-тук открыл
    #   Last login: Sun Aug 29 22:33:38 2021 from 10.0.2.2
    #   [vagrant@inetRouter ~]$ 
    exit
exit  
```

Видоизменил [port_knocking.sh](./027_2/ansible/roles/task_001_port_knocking_client/files/port_knocking.sh)

<details><summary>см. port_knocking.sh</summary>

```shell
#!/bin/bash
# ./port_knocking.sh  192.168.255.1 8881 7777 9991 && ssh 192.168.0.1

# Проверка на переданный параметр
USAGE="SYNOPSIS: ./port_knocking.sh <TARGET_IP> <port_1> [<port_2> <port_3> ...]"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter TARGET_IP. "
    echo $USAGE
    exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, some knock-port id needed. "
    echo $USAGE
    exit 1
fi

TARGET_IP=$1
shift
for ARG in "$@"
do
  sudo nmap -Pn --max-retries 0 -p $ARG $TARGET_IP # !! SUDO - MUST BE
#  sudo ssh -o ConnectTimeout=1 $TARGET_IP -p $ARG
done
```

</details>

Замечание:
* port_knocking.sh требует установки nmap на клиенте, а можно иными? curl? или `ssh <IP> -p <PORT>` не вышло.
* port_knocking.sh необходим sudo для nmap, поведение c/без разнится, связано с правами на локальный сокет?

Развертка nginx

```shell
cd ../ansible
ansible-playbook playbooks/task_002_nginx.yml > ../files/task_002_nginx.txt
```


<details><summary>см. лог playbooks/task_002_nginx.yml</summary>

```text

PLAY [Deploy nginx] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [centralServer]

TASK [../roles/task_002_nginx : Install EPEL Repo package from standart repo] ***
changed: [centralServer]

TASK [../roles/task_002_nginx : Install nginx] *********************************
changed: [centralServer]

TASK [../roles/task_002_nginx : Configure nginx] *******************************
changed: [centralServer]

TASK [../roles/task_002_nginx : index.html] ************************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : start nginx] ************************
changed: [centralServer]

RUNNING HANDLER [../roles/task_002_nginx : restart nginx] **********************
changed: [centralServer]

PLAY RECAP *********************************************************************
centralServer              : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проброс порта 80 --> 8080

```shell
ansible-playbook playbooks/task_002_port_forwarding.yml > ../files/playbooks_task_002_port_forwarding.txt
```


<details><summary>см. лог playbooks/task_002_port_forwarding.yml</summary>

```text

PLAY [Configure port forwarding] ***********************************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables dnat] ***********************
changed: [inetRouterSecond]

TASK [../roles/task_002_port_forwarding : iptables dnat] ***********************
changed: [inetRouterSecond]

PLAY RECAP *********************************************************************
inetRouterSecond           : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 192.168.0.2:80 внутри сети

```shell
ansible-playbook playbooks/test_003_http_connectivity.yml > ../files/test_003_http_connectivity.txt
```


<details><summary>см. лог playbooks/test_003_http_connectivity.yml</summary>

```text

PLAY [Playbook of internal http connectivity tests] ****************************

TASK [Gathering Facts] *********************************************************
ok: [inetRouterSecond]
ok: [centralServer]
ok: [centralRouter]
fatal: [inetRouter]: UNREACHABLE! => {"changed": false, "msg": "Failed to connect to the host via ssh: ssh: connect to host 127.0.0.1 port 2222: Connection timed out", "unreachable": true}

TASK [../roles/test_003_http_connectivity : test | http | curl] ****************
changed: [inetRouterSecond]
changed: [centralRouter]
changed: [centralServer]

TASK [../roles/test_003_http_connectivity : test | http | index page content] ***
ok: [inetRouterSecond] => {
    "msg": "Hello from centralServer"
}
ok: [centralRouter] => {
    "msg": "Hello from centralServer"
}
ok: [centralServer] => {
    "msg": "Hello from centralServer"
}

PLAY RECAP *********************************************************************
centralRouter              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centralServer              : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
inetRouter                 : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0   
inetRouterSecond           : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Проверка работы 8080 извне сети

```shell
cd ../vm
curl -I 127.0.0.1:8080 > ../files/curl_localhost_8080.md
curl 127.0.0.1:8080 >> ../files/curl_localhost_8080.md
```
```text


HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Sat, 04 Sep 2021 19:42:16 GMT
Content-Type: text/html
Content-Length: 24
Last-Modified: Sat, 04 Sep 2021 19:41:02 GMT
Connection: keep-alive
ETag: "6133cbce-18"
Accept-Ranges: bytes

Hello from centralServer
```
