#  ZFS
__Домашнее задание__

Практические навыки работы с ZFS.

__Цель__:

Отрабатываем навыки работы с созданием томов export/import и установкой параметров.
* Определить алгоритм с наилучшим сжатием.
* Определить настройки pool’a 
* Найти сообщение от преподавателей

__Результат__: 
* список команд которыми получен результат с их выводами 
  
__1. Определить алгоритм с наилучшим сжатием__

Зачем: 
Отрабатываем навыки работы с созданием томов и установкой параметров. Находим наилучшее сжатие.

__Шаги__:
* определить какие алгоритмы сжатия поддерживает zfs (gzip gzip-N, zle lzjb, lz4)
* создать 4 файловых системы на каждой применить свой алгоритм сжатия.
  Для сжатия использовать либо текстовый файл, либо группу файлов:
  * либо скачать файл “Война и мир” и расположить на файловой системе 
  ```shell
    wget -O War_and_Peace.txt http://www.gutenberg.org/ebooks/2600.txt.utf-8 
  ```
  * либо скачать файл ядра распаковать и расположить на файловой системе

__Результат__:
* список команд которыми получен результат с их выводами
* вывод команды из которой видно какой из алгоритмов лучше 
  
__2. Определить настройки pool’a__

__Зачем__: 
Для переноса дисков между системами используется функция export/import. Отрабатываем навыки работы с файловой системой ZFS

__Шаги__:
* Загрузить архив с файлами локально. https://drive.google.com/open?id=1KRBNW33QWqbvbVHa3hLJivOAt60yukkg Распаковать.
* С помощью команды zfs import собрать pool ZFS.
* Командами zfs определить настройки
  * размер хранилища
  * тип pool
  * значение recordsize
  * какое сжатие используется
  * какая контрольная сумма используется Результат:
  * список команд которыми восстановили pool . Желательно с Output команд.
  * файл с описанием настроек settings

__3. Найти сообщение от преподавателей__

__Зачем__: 
* для бэкапа используются технологии snapshot. Snapshot можно передавать между хостами и восстанавливать с помощью send/receive. Отрабатываем навыки восстановления snapshot и переноса файла.

__Шаги__:
* Скопировать файл из удаленной директории. https://drive.google.com/file/d/1gH8gCL9y7Nd5Ti3IRmplZPF1XjzxeRAG/view?usp=sharing Файл был получен командой zfs send otus/storage@task2 > otus_task2.file
* Восстановить файл локально. zfs receive
* Найти зашифрованное сообщение в файле secret_message

__Результат__:
* список шагов которыми восстанавливали
* зашифрованное сообщение

## Результат

__Внимание__: здесь и далее команды запускаются внутри VM, то есть в терминале значится метка `[vagrant@lvm ~]$`, если не сказано иное.

Этапы:
- [](#1)
- [](#2)
- [](#3)
- [](#4)


Образ таков - [Vagrantfile](./004/src/Vagrantfile). 
```shell
  vagrant ssh server
```

```shell
lsblk
    NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
    sda      8:0    0  10G  0 disk 
    `-sda1   8:1    0  10G  0 part /
    sdb      8:16   0   1G  0 disk 
    sdc      8:32   0   1G  0 disk 
    sdd      8:48   0   1G  0 disk 
    sde      8:64   0   1G  0 disk 
    sdf      8:80   0   1G  0 disk 
    sdg      8:96   0   1G  0 disk 
#

```shell
 lsblk
    NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
    sda      8:0    0  10G  0 disk 
    `-sda1   8:1    0  10G  0 part /
    sdb      8:16   0   1G  0 disk 
    sdc      8:32   0   1G  0 disk 
    sdd      8:48   0   1G  0 disk 
    sde      8:64   0   1G  0 disk 
    sdf      8:80   0   1G  0 disk 
    sdg      8:96   0   1G  0 disk 

zfs set compression==gzip-9 my_fs


```

## 

Compression:
* on 
* off 
* lzjb 
* gzip 
* gzip-[1-9] 
* zle 
* lz4

```shell

sudo zpool create lzjb_drive sdb
sudo zpool create gzip_drive sdc
sudo zpool create gzip1_drive sdd
sudo zpool create gzip9_drive sde
sudo zpool create zle_drive sdf
sudo zpool create lz4_drive sdg

zpool list
    NAME          SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
    gzip1_drive   960M  94.5K   960M        -         -     0%     0%  1.00x    ONLINE  -
    gzip9_drive   960M   110K   960M        -         -     0%     0%  1.00x    ONLINE  -
    gzip_drive    960M  94.5K   960M        -         -     0%     0%  1.00x    ONLINE  -
    lz4_drive     960M  94.5K   960M        -         -     0%     0%  1.00x    ONLINE  -
    lzjb_drive    960M   104K   960M        -         -     0%     0%  1.00x    ONLINE  -
    zle_drive     960M  94.5K   960M        -         -     0%     0%  1.00x    ONLINE  -

sudo zfs set compression=lzjb lzjb_drive
sudo zfs set compression=gzip gzip_drive
sudo zfs set compression=gzip-1 gzip1_drive
sudo zfs set compression=gzip-9 gzip9_drive
sudo zfs set compression=zle lzjb_drive
sudo zfs set compression=lz4 lz4_drive

zpool list
    NAME          SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
    gzip1_drive   960M   120K   960M        -         -     0%     0%  1.00x    ONLINE  -
    gzip9_drive   960M   138K   960M        -         -     0%     0%  1.00x    ONLINE  -
    gzip_drive    960M   154K   960M        -         -     0%     0%  1.00x    ONLINE  -
    lz4_drive     960M   117K   960M        -         -     0%     0%  1.00x    ONLINE  -
    lzjb_drive    960M   166K   960M        -         -     0%     0%  1.00x    ONLINE  -
    zle_drive     960M  94.5K   960M        -         -     0%     0%  1.00x    ONLINE  -
                          ^
                      изменилось

pwd
    /home/vagrant
wget -O War_and_Peace.txt http://www.gutenberg.org/ebooks/2600.txt.utf-8 
    -bash: wget: command not found
curl -J -L https://www.gutenberg.org/cache/epub/2600/pg2600.txt --output War_and_Peace.txt
      % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                        Dload  Upload   Total   Spent    Left  Speed
      100 1181k  100 1181k    0     0   613k      0  0:00:01  0:00:01 --:--:--  612k

ls -lh War_and_Peace.txt 
    -rw-rw-r--. 1 vagrant vagrant 1.2M May 15 22:33 War_and_Peace.txt
 ls -l War_and_Peace.txt 
    -rw-rw-r--. 1 vagrant vagrant 1209374 May 15 22:33 War_and_Peace.txt

zfs list
    NAME          USED  AVAIL     REFER  MOUNTPOINT
    gzip1_drive    93K   832M       24K  /gzip1_drive
    gzip9_drive    93K   832M       24K  /gzip9_drive
    gzip_drive   94.5K   832M       24K  /gzip_drive
    lz4_drive      93K   832M       24K  /lz4_drive
    lzjb_drive     96K   832M       24K  /lzjb_drive
    zle_drive    85.5K   832M       24K  /zle_drive

sudo cp War_and_Peace.txt /gzip1_drive
sudo cp War_and_Peace.txt /gzip9_drive
sudo cp War_and_Peace.txt /gzip_drive
sudo cp War_and_Peace.txt /lz4_drive
sudo cp War_and_Peace.txt /lzjb_drive
sudo cp War_and_Peace.txt /zle_drive

zfs list
    NAME          USED  AVAIL     REFER  MOUNTPOINT
    gzip1_drive  1.25M   831M     1.18M  /gzip1_drive
    gzip9_drive  1.25M   831M     1.18M  /gzip9_drive
    gzip_drive   1.25M   831M     1.18M  /gzip_drive
    lz4_drive    1.25M   831M     1.18M  /lz4_drive
    lzjb_drive   1.25M   831M     1.18M  /lzjb_drive
    zle_drive    1.34M   831M     1.28M  /zle_drive
    
sudo ./War_and_Peace.txt 
sudo du -l ./War_and_Peace.txt | awk '{print $1}'             1184
sudo du -l /gzip1_drive/War_and_Peace.txt | awk '{print $1}'  1185
sudo du -l /gzip9_drive/War_and_Peace.txt | awk '{print $1}'  1184
sudo du -l /gzip_drive/War_and_Peace.txt | awk '{print $1}'   1184
sudo du -l /lz4_drive/War_and_Peace.txt | awk '{print $1}'    1185
sudo du -l /lzjb_drive/War_and_Peace.txt | awk '{print $1}'   1185
sudo du -l /zle_drive/War_and_Peace.txt | awk '{print $1}'    1283

```
