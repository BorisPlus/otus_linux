# Bash

__Домашнее задание__

написать скрипт для крона который раз в час присылает на заданную почту
* X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
* Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
* все ошибки c момента последнего запуска
* список всех кодов возврата с указанием их кол-ва с момента последнего запуска 
  
* в письме должно быть прописан обрабатываемый временной диапазон 
* должна быть реализована защита от мультизапуска

Критерии оценки:
* трапы и функции, а также sed и find +1 балл

Рекомендуем сдать до: 03.06.2021

## Исполненение

### Предисловие

При разработке Bash-скриптов придерживался
1) скрипты разрабатываются исключительно для данного формата [лог-файла](./010/access-4560-644067.log). При его изменении необходимо переписывать парсеры (это логично, универсальных не существует). Однако уже на данном этапе я хочу обратиь внимание на то, что именно парсеры надо переписывать, а не те модули, которые отвечают за отправку писем или сбор статистики (например, топ 5 ip-адресов или число встречаемости каждого http-статуста)
2) максимального НЕ дублирования кода (терпеть его не могу). Поэтому получение результата выглядит примерно как последовательное применение "фильтра" и "агрегации", например, 
```shell
get_data_at_hour | filter_for_ip | group_by_statistic | top_statistic
```
это
```shell
"фильтр данных за прошлый час"
  ---> "фильтр IP-адресов" 
    ---> "группировка (и сортировка по убыванию, я ее не отделял тут) по IP-адресам" 
      ---> "выборка top IP-адресов" 
```
Данный подход, как продемонстрировано, позволяет не столько "программировать", сколько "конструировать". Этап "фильтр данных за прошлый час" блок `get_data_at_hour` может быть просто заменен на выборку всех данных `cat ./access-4560-644067.log`. 


3) Алгоритм таков - по крону запускаем выборку из файла за прошлый час и далее ее обрабатываем. Однако, так как файл примера не динамический и не содержит данных за прошлый час, а содержит несколько чисел за август 2019 года, то сделаем поправку и выберем данные еще немного раньше (для 9 июня 2021 года 23:30 отступ на -15960 часа даст время 14/Aug/2019:23. Таким образом при настроенном кроне и отправке писем будет происходить выборка из лог-файла с таким запазданием, но будет достигнут эффект интерактивности.


4) Сведения о том, как за какой период отправлены данные (за прошлый час же) выглядят как `DATA AT HOUR 14/Aug/2019:23`

### Определение часа

__Заметка__: даты в лог-файле находятся в Eng-локали, поэтому необходим `LANG=en_EN`.

Вот как выглядит скрипт подсчета нужного для выборки часа (с учетом указанной выше поправки):
[get_hour.sh](./010/get_hour.sh)

<details><summary>см. get_hour.sh</summary>

```shell
get_hour() {
    corrective=15961
    formatted_hour=$(LANG=en_EN date -d "$corrective hour ago" +%d/%b/%Y:%H) #
    echo $formatted_hour
}

get_data_at_hour() {
    _LOG_FILE=${LOG_FILE}
    _AT_HOUR=${AT_HOUR}
    cat "${_LOG_FILE}" | grep "\[$_AT_HOUR:"
    exit 0
}

```

</details>


Вот как `get_hour` применяется для выборки сведений из лог-файла за период (обратите внимание, во всех процедурах происходит проверка на входные параметры - передан ли путь к файлу, указано ли сколько брать строк из ТОП):
[get_hour.usage.sh](./010/get_hour.usage.sh)

<details><summary>см. get_hour.usage.sh</summary>

```shell
. ./get_hour.sh

DEBUG=true
USAGE="SYNOPSIS: get_hour.test.sh LOG_FILE"
if [ -z "$1" ]
then
echo "Sorry, there is no first parameter LOG_FILE."
echo $USAGE
exit 1
fi

AT_HOUR=$(get_hour)
if $DEBUG
then
  echo SET AT HOUR AS $AT_HOUR
fi

LOG_FILE="${1}"
if $DEBUG
then
  echo USE LOG FILE $LOG_FILE
fi
get_data_at_hour
exit 0

```

</details>


Результат выборки сведений из лог-файла за период:
[get_hour.usage.sh.log](./010/get_hour.usage.sh.log)

<details><summary>см. get_hour.usage.sh.log</summary>

```properties
./get_hour.usage.sh ./access-4560-644067.log
SET AT HOUR AS 14/Aug/2019:23
USE LOG FILE ./access-4560-644067.log
62.75.198.172 - - [14/Aug/2019:23:15:46 +0300] "POST /wp-cron.php?doing_wp_cron=1565813746.0306749343872070312500 HTTP/1.1" 200 31 "https://dbadmins.ru/wp-cron.php?doing_wp_cron=1565813746.0306749343872070312500" "WordPress/5.0.4; https://dbadmins.ru"rt=0.339 uct="0.000" uht="0.339" urt="0.339"
209.124.74.244 - - [14/Aug/2019:23:15:46 +0300] "GET /wp-login.php HTTP/1.1" 200 1338 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.731 uct="0.000" uht="0.731" urt="0.731"
209.124.74.244 - - [14/Aug/2019:23:15:47 +0300] "POST /wp-login.php HTTP/1.1" 200 1721 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.303 uct="0.000" uht="0.199" urt="0.199"
209.124.74.244 - - [14/Aug/2019:23:15:48 +0300] "POST /xmlrpc.php HTTP/1.1" 200 292 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.357 uct="0.000" uht="0.246" urt="0.246"
172.104.242.173 - - [14/Aug/2019:23:22:13 +0300] "9\xCD\xC3V\x8C&\x12Dz/\xB7\xC0t\x96C\xE2" 400 173 "-" "-"rt=0.010 uct="-" uht="-" urt="-"
54.208.102.37 - - [14/Aug/2019:23:23:59 +0300] "GET / HTTP/1.1" 301 185 "http://dbadmins.ru/" "Mozilla/5.0 (compatible; DuckDuckGo-Favicons-Bot/1.0; +http://duckduckgo.com)"rt=0.000 uct="-" uht="-" urt="-"
54.208.102.37 - - [14/Aug/2019:23:24:00 +0300] "GET / HTTP/1.1" 200 14475 "https://dbadmins.ru/" "Mozilla/5.0 (compatible; DuckDuckGo-Favicons-Bot/1.0; +http://duckduckgo.com)"rt=0.273 uct="0.000" uht="0.188" urt="0.273"
54.208.102.37 - - [14/Aug/2019:23:24:00 +0300] "GET /favicon.ico HTTP/1.1" 200 7358 "https://dbadmins.ru/favicon.ico" "Mozilla/5.0 (compatible; DuckDuckGo-Favicons-Bot/1.0; +http://duckduckgo.com)"rt=0.000 uct="-" uht="-" urt="-"
87.250.233.75 - - [14/Aug/2019:23:24:32 +0300] "GET / HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
87.250.233.68 - - [14/Aug/2019:23:24:32 +0300] "GET / HTTP/1.1" 200 14475 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.263 uct="0.000" uht="0.180" urt="0.263"
93.158.167.130 - - [14/Aug/2019:23:31:56 +0300] "GET / HTTP/1.1" 404 169 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
167.86.96.137 - - [14/Aug/2019:23:31:58 +0300] "GET /wp-login.php HTTP/1.1" 200 1338 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.204 uct="0.000" uht="0.204" urt="0.204"
167.86.96.137 - - [14/Aug/2019:23:31:58 +0300] "POST /wp-login.php HTTP/1.1" 200 1721 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.212 uct="0.000" uht="0.193" urt="0.193"
167.86.96.137 - - [14/Aug/2019:23:31:58 +0300] "POST /xmlrpc.php HTTP/1.1" 200 292 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.259 uct="0.000" uht="0.245" urt="0.245"
5.255.251.4 - - [14/Aug/2019:23:38:25 +0300] "GET / HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
93.158.167.130 - - [14/Aug/2019:23:38:25 +0300] "GET / HTTP/1.1" 200 14475 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.274 uct="0.000" uht="0.189" urt="0.274"
209.17.96.74 - - [14/Aug/2019:23:44:04 +0300] "GET / HTTP/1.1" 301 5 "-" "Mozilla/5.0 (compatible; Nimbostratus-Bot/v1.3.2; http://cloudsystemnetworks.com)"rt=0.185 uct="0.000" uht="0.185" urt="0.185"
77.247.110.165 - - [14/Aug/2019:23:44:18 +0300] "HEAD /robots.txt HTTP/1.0" 404 0 "-" "-"rt=0.017 uct="-" uht="-" urt="-"
103.111.52.54 - - [14/Aug/2019:23:50:24 +0300] "GET /wp-login.php HTTP/1.1" 200 1338 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.199 uct="0.000" uht="0.199" urt="0.199"
103.111.52.54 - - [14/Aug/2019:23:50:26 +0300] "POST /wp-login.php HTTP/1.1" 200 1721 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.478 uct="0.000" uht="0.191" urt="0.191"
103.111.52.54 - - [14/Aug/2019:23:50:27 +0300] "POST /xmlrpc.php HTTP/1.1" 200 292 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0"rt=0.542 uct="0.000" uht="0.248" urt="0.248"

```

</details>


### Предварительно для использования

Скрипт выборки ТОП:
[top_statistic.sh](./010/top_statistic.sh)

<details><summary>см. top_statistic.sh</summary>

```shell
top_statistic() {
    head -n ${TOP}
}

```

</details>


Скрипт группировки (и сортировки по убыванию) выборки:
[group_by_statistic.sh](./010/group_by_statistic.sh)

<details><summary>см. group_by_statistic.sh</summary>

```shell
group_by_statistic() {
    sort | uniq -c | sort -rn
}

```

</details>


### X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта

Скрипт выборки IP-адресов:
[filter_for_ip.sh](./010/filter_for_ip.sh)

<details><summary>см. filter_for_ip.sh</summary>

```shell
filter_for_ip() {
    awk '{ print $1 }'
}

```

</details>


Реализация выборки IP-адресов:
[filter_for_ip.usage.sh](./010/filter_for_ip.usage.sh)

<details><summary>см. filter_for_ip.usage.sh</summary>

```shell
. ./filter_for_ip.sh

USAGE="SYNOPSIS: filter_for_ip.usage.sh LOG_FILE"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE. "
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi

echo 'FILTER FOR IP-ADDRESSES:'
get_data_at_hour | filter_for_ip

exit 0
```

</details>


Результат выборки IP-адресов:
[filter_for_ip.usage.sh.log](./010/filter_for_ip.usage.sh.log)

<details><summary>см. filter_for_ip.usage.sh.log</summary>

```properties
./filter_for_ip.usage.sh ./access-4560-644067.log

GET DATA OF HOUR 14/Aug/2019:23
FILTER FOR IP-ADDRESSES:
------------
62.75.198.172
209.124.74.244
209.124.74.244
209.124.74.244
172.104.242.173
54.208.102.37
54.208.102.37
54.208.102.37
87.250.233.75
87.250.233.68
93.158.167.130
167.86.96.137
167.86.96.137
167.86.96.137
5.255.251.4
93.158.167.130
209.17.96.74
77.247.110.165
103.111.52.54
103.111.52.54
103.111.52.54

```

</details>


Реализация выборки X (с наибольшим кол-вом запросов) IP адресов с указанием кол-ва запросов (применяется `группировка` ---> `топ`):
[top_of_group_by_statistic.usage.ip.sh](./010/top_of_group_by_statistic.usage.ip.sh)

<details><summary>см. top_of_group_by_statistic.usage.ip.sh</summary>

```shell
. ./filter_for_ip.sh
. ./group_by_statistic.sh
. ./top_statistic.sh

USAGE="SYNOPSIS: top_statistic.ip.usage.sh LOG_FILE TOP"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE. "
    echo $USAGE
    exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, there is no second parameter TOP."
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"
TOP=${2}

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi
echo TOP ${TOP}-COUNT IP-ADDRESSES
get_data_at_hour | filter_for_ip | group_by_statistic | top_statistic

exit 0
```

</details>


Результат выборки X (с наибольшим кол-вом запросов) IP адресов с указанием кол-ва запросов (применяется `группировка` ---> `топ`):
[top_of_group_by_statistic.usage.ip.sh.log](./010/top_of_group_by_statistic.usage.ip.sh.log)

<details><summary>см. top_of_group_by_statistic.usage.ip.sh.log</summary>

```properties
./top_of_group_by_statistic.usage.ip.sh ./access-4560-644067.log 10
GET DATA OF HOUR 14/Aug/2019:23
TOP 10-COUNT IP-ADDRESSES
      3 54.208.102.37
      3 209.124.74.244
      3 167.86.96.137
      3 103.111.52.54
      2 93.158.167.130
      1 87.250.233.75
      1 87.250.233.68
      1 77.247.110.165
      1 62.75.198.172
      1 5.255.251.4

```

</details>


### Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта

Под "адресом" решил принять URN, то что идет после доменного имени, для "склеивания с доменом", возможно применение `awk` без пробельного разделителя.

Скрипт выборки URN-адресов:
[filter_for_urn.sh](./010/filter_for_urn.sh)

<details><summary>см. filter_for_urn.sh</summary>

```shell
filter_for_urn() {
    awk 'BEGIN { FS = "\"" } ; {print $2}'| awk '{print $2}'
}

```

</details>


Реализация выборки URN-адресов:
[filter_for_urn.usage.sh](./010/filter_for_urn.usage.sh)

<details><summary>см. filter_for_urn.usage.sh</summary>

```shell
. ./filter_for_urn.sh

USAGE="SYNOPSIS: filter_for_uri.usage.sh LOG_FILE"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE. "
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi
echo 'FILTER FOR UNIFORM RESOURCE NAME:'
get_data_at_hour | filter_for_urn

exit 0
```

</details>


Результат выборки URN-адресов:
[filter_for_urn.usage.sh.log](./010/filter_for_urn.usage.sh.log)

<details><summary>см. filter_for_urn.usage.sh.log</summary>

```properties
GET DATA OF HOUR 14/Aug/2019:23
FILTER FOR UNIFORM RESOURCE NAME:
/wp-cron.php?doing_wp_cron=1565813746.0306749343872070312500
/wp-login.php
/wp-login.php
/xmlrpc.php

/
/
/favicon.ico
/
/
/
/wp-login.php
/wp-login.php
/xmlrpc.php
/
/
/
/robots.txt
/wp-login.php
/wp-login.php
/xmlrpc.php


```

</details>


Реализация выборки Y (с наибольшим кол-вом запросов) адресов с указанием кол-ва запросов (применяется `группировка` ---> `ТОП`):
[top_of_group_by_statistic.usage.urn.sh](./010/top_of_group_by_statistic.usage.urn.sh)

<details><summary>см. top_of_group_by_statistic.usage.urn.sh</summary>

```shell
. ./filter_for_urn.sh
. ./group_by_statistic.sh
. ./top_statistic.sh

USAGE="SYNOPSIS: top_statistic.urn.usage.sh LOG_FILE TOP"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE. "
    echo $USAGE
    exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, there is no second parameter TOP."
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"
TOP=${2}

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi
echo TOP ${TOP}-COUNT URN REQUEST TARGETS
get_data_at_hour | filter_for_urn | group_by_statistic | top_statistic

exit 0
```

</details>


Результат выборки:
[top_of_group_by_statistic.usage.urn.sh.log](./010/top_of_group_by_statistic.usage.urn.sh.log)

<details><summary>см. top_of_group_by_statistic.usage.urn.sh.log</summary>

```properties
./top_of_group_by_statistic.usage.urn.sh ./access-4560-644067.log 3
GET DATA OF HOUR 14/Aug/2019:23
TOP 3-COUNT URN REQUEST TARGETS
      8 /
      6 /wp-login.php
      3 /xmlrpc.php

```

</details>


### Все ошибки с момента последнего запуска

Решено, что результат выборки должен состоять именно из строк с ошибками, так как это максимально информативно.

Скрипт производит выборку всех строк, в ответах которых указаны HTTP-коды не входящие в диапазон 200-299 (допускаем, что все остальное HTTP-коды - это ошибки):
[filter_rows_with_error_status.sh](./010/filter_rows_with_error_status.sh)

<details><summary>см. filter_rows_with_error_status.sh</summary>

```shell
filter_rows_with_error_status() {
    awk 'BEGIN { FS = "\" "; OFS= "#"} ; {print $0,$2}' | awk 'BEGIN { FS = "#" }; { if (!(match($2,/2.*/))) { print $1 }}'
}

```

</details>


Реализация выборки:
[filter_rows_with_error_status.usage.sh](./010/filter_rows_with_error_status.usage.sh)

<details><summary>см. filter_rows_with_error_status.usage.sh</summary>

```shell
. ./filter_rows_with_error_status.sh

USAGE="SYNOPSIS: filter_rows_with_error_status.usage.sh LOG_FILE"
if [ -z "$1" ]
then
  echo "Sorry, there is no first parameter LOG_FILE."
  echo $USAGE
  exit 1
fi

LOG_FILE="${1}"

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "DATA AT HOUR" $AT_HOUR
fi
echo 'FILTER FOR NOT SUCCESS REQUESTS:'
get_data_at_hour | filter_rows_with_error_status

exit 0
```

</details>


Результат выборки:
[filter_rows_with_error_status.usage.sh.log](./010/filter_rows_with_error_status.usage.sh.log)

<details><summary>см. filter_rows_with_error_status.usage.sh.log</summary>

```properties
./filter_rows_with_error_status.usage.sh ./access-4560-644067.log
DATA AT HOUR 14/Aug/2019:23
FILTER FOR NOT SUCCESS REQUESTS:
172.104.242.173 - - [14/Aug/2019:23:22:13 +0300] "9\xCD\xC3V\x8C&\x12Dz/\xB7\xC0t\x96C\xE2" 400 173 "-" "-"rt=0.010 uct="-" uht="-" urt="-"
54.208.102.37 - - [14/Aug/2019:23:23:59 +0300] "GET / HTTP/1.1" 301 185 "http://dbadmins.ru/" "Mozilla/5.0 (compatible; DuckDuckGo-Favicons-Bot/1.0; +http://duckduckgo.com)"rt=0.000 uct="-" uht="-" urt="-"
87.250.233.75 - - [14/Aug/2019:23:24:32 +0300] "GET / HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
93.158.167.130 - - [14/Aug/2019:23:31:56 +0300] "GET / HTTP/1.1" 404 169 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
5.255.251.4 - - [14/Aug/2019:23:38:25 +0300] "GET / HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; YandexMetrika/2.0; +http://yandex.com/bots yabs01)"rt=0.000 uct="-" uht="-" urt="-"
209.17.96.74 - - [14/Aug/2019:23:44:04 +0300] "GET / HTTP/1.1" 301 5 "-" "Mozilla/5.0 (compatible; Nimbostratus-Bot/v1.3.2; http://cloudsystemnetworks.com)"rt=0.185 uct="0.000" uht="0.185" urt="0.185"
77.247.110.165 - - [14/Aug/2019:23:44:18 +0300] "HEAD /robots.txt HTTP/1.0" 404 0 "-" "-"rt=0.017 uct="-" uht="-" urt="-"

```

</details>


__Заметка про "конструирование", а не программирование__

Ничто не мешает применить к данному результату выборку ТОП-2 ошибок:
`get_data_at_hour | filter_rows_with_error_status | filter_for_http_code | group_by_statistic | top_statistic`
[top_of_group_by.usage.error_rows.sh](./010/top_of_group_by.usage.error_rows.sh)

<details><summary>см. top_of_group_by.usage.error_rows.sh</summary>

```shell
. ./filter_rows_with_error_status.sh
. ./filter_for_http_code.sh
. ./group_by_statistic.sh
. ./top_statistic.sh

USAGE="SYNOPSIS: top_of_group_by.usage.error_rows.sh LOG_FILE TOP"
if [ -z "$1" ]
then
  echo "Sorry, there is no first parameter LOG_FILE."
  echo $USAGE
  exit 1
fi

if [ -z "$2" ]
then
    echo "Sorry, there is no second parameter TOP."
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"
TOP=${2}

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "DATA AT HOUR" $AT_HOUR
fi
echo 'FILTER FOR NOT SUCCESS REQUESTS:'
get_data_at_hour | filter_rows_with_error_status | filter_for_http_code | group_by_statistic | top_statistic

exit 0
```

</details>


Результат выборки (ТОП-2 и ТОП-3):
[top_of_group_by.usage.error_rows.sh.log](./010/top_of_group_by.usage.error_rows.sh.log)

<details><summary>см. top_of_group_by.usage.error_rows.sh.log</summary>

```properties
./top_of_group_by.usage.error_rows.sh ./access-4560-644067.log 2

    DATA AT HOUR 14/Aug/2019:23
    FILTER FOR NOT SUCCESS REQUESTS:
          4 301
          2 404

./top_of_group_by.usage.error_rows.sh ./access-4560-644067.log 4

    DATA AT HOUR 14/Aug/2019:23
    FILTER FOR NOT SUCCESS REQUESTS:
          4 301
          2 404
          1 400

```

</details>


### Cписок ВСЕХ кодов возврата с указанием их кол-ва с момента последнего запуска 

Скрипт выборки HTTP-кодов:
[filter_for_http_code.sh](./010/filter_for_http_code.sh)

<details><summary>см. filter_for_http_code.sh</summary>

```shell
filter_for_http_code() {
    awk 'BEGIN { FS = "\"" } ; {print $3}' | awk '{print $1}'
}

```

</details>


Реализация выборки HTTP-кодов:
[filter_for_http_code.usage.sh](./010/filter_for_http_code.usage.sh)

<details><summary>см. filter_for_http_code.usage.sh</summary>

```shell
. ./filter_for_http_code.sh

USAGE="SYNOPSIS: filter_for_ip.usage.sh LOG_FILE"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE. "
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi

echo 'FILTER FOR HTTP-CODES:'
get_data_at_hour | filter_for_http_code

exit 0
```

</details>


Результат выборки HTTP-кодов:
[filter_for_http_code.usage.sh.log](./010/filter_for_http_code.usage.sh.log)

<details><summary>см. filter_for_http_code.usage.sh.log</summary>

```properties
./filter_for_http_code.usage.sh ./access-4560-644067.log
GET DATA OF HOUR 14/Aug/2019:23
FILTER FOR HTTP-CODES:
200
200
200
200
400
301
200
200
301
200
404
200
200
200
301
200
301
404
200
200
200

```

</details>


Реализация выборки HTTP-кодов с их группировкой:
[group_by_statistic.usage.http_code.sh](./010/group_by_statistic.usage.http_code.sh)

<details><summary>см. group_by_statistic.usage.http_code.sh</summary>

```shell
. ./group_by_statistic.sh
. ./filter_for_http_code.sh

USAGE="SYNOPSIS: top_statistic.usage.http_code.sh LOG_FILE"
if [ -z "$1" ]
then
    echo "Sorry, there is no first parameter LOG_FILE."
    echo $USAGE
    exit 1
fi

LOG_FILE="${1}"

. ./get_hour.sh
AT_HOUR=$(get_hour)
DEBUG=true
if $DEBUG
then
  echo "GET DATA OF HOUR" $AT_HOUR
fi
echo CALCULATE COUNT OF HTTP-STATUS CODES
get_data_at_hour | filter_for_http_code | group_by_statistic

exit 0
```

</details>


Результат выборки HTTP-кодов с их группировкой:
[group_by_statistic.usage.http_code.sh.log](./010/group_by_statistic.usage.http_code.sh.log)

<details><summary>см. group_by_statistic.usage.http_code.sh.log</summary>

```properties
./group_by_statistic.usage.http_code.sh ./access-4560-644067.log

GET DATA OF HOUR 14/Aug/2019:23
CALCULATE COUNT OF HTTP-STATUS CODES
     14 200
      4 301
      2 404
      1 400


```

</details>


### Реализация защиты от мультизапуска

Изящным решением на мой взгляд является [lockrun](http://unixwiz.net/tools/lockrun.html), описанный в статье https://habr.com/ru/post/114622/

### Реализация отправки Email

Из имевшихся способов отправки Email на внешние адреса электронной почты был выбран описанный в статье https://rtcamp.com/tutorials/linux/ubuntu-postfix-gmail-smtp/ подход. Допустим, что все настроено, тогда отравка письма выглядит так

```shell
echo "Message Body" | mail -s "Message Subject" recipient@example.com
```

То есть достаточно подать на вход ` | mail -s ...` необходимую выборку

```shell
<выборка> | mail -s "Message Subject" recipient@example.com
```
## Итог crontab

```shell
crontab -l

0 * * * * /usr/local/bin/lockrun --lockfile=/tmp/ip_top.lockrun -- /home/vagrant/top_of_group_by_statistic.usage.ip.sh ./access-4560-644067.log 10 | mail -s "ТОП-10 IP-адресов" recipient@example.com
0 * * * * /usr/local/bin/lockrun --lockfile=/tmp/urn_top.lockrun -- /home/vagrant/top_of_group_by_statistic.usage.urn.sh ./access-4560-644067.log 3 | mail -s "ТОП-10 URN-адресов" recipient@example.com
0 * * * * /usr/local/bin/lockrun --lockfile=/tmp/rows_with_error.lockrun -- /home/vagrant/filter_rows_with_error_status.usage.sh ./access-4560-644067.log | mail -s "Все ошибки" recipient@example.com
0 * * * * /usr/local/bin/lockrun --lockfile=/tmp/http_code.lockrun -- /home/vagrant/group_by_statistic.usage.http_code.sh ./access-4560-644067.log | mail -s "HTTP-коды" recipient@example.com
```
  