# Репликация Postgres

* настроить hot_standby репликацию с использованием слотов
* настроить правильное резервное копирование

Для сдачи работы присылаем ссылку на репозиторий, в котором должны обязательно быть 

* Vagranfile (2 машины)
* плейбук Ansible
* конфигурационные файлы postgresql.conf, pg_hba.conf и recovery.conf,
* конфиг barman, либо скрипт резервного копирования.

Команда "vagrant up" должна поднимать машины с настроенной репликацией и резервным копированием. 
Рекомендуется в README.md файл вложить результаты (текст или скриншоты) проверки работы репликации и резервного копирования.

Пример плейбука:
```text
    name: Установка postgres11
    hosts: master, slave
    become: yes
    roles:
        postgres_install

    name: Настройка master
    hosts: master
    become: yes
    roles:
        master-setup

    name: Настройка slave
    hosts: slave
    become: yes
    roles:
        slave-setup

    name: Создание тестовой БД
    hosts: master
    become: yes
    roles:
        create_test_db

    name: Настройка barman
    hosts: barman
    become: yes
    roles:
        barman_install tags:
        barman
```

## Исполнение

* https://habr.com/ru/post/213409/
```text
Hot standby — позволяет slave нодам обслуживать READ запросы для балансировки нагрузки, в отличии от warm standby, при котором slave сервер не обслуживает запросов клиентов, а только постоянно подтягивает себе с мастера актуальную базу. 
```

```shell
cd ../../
cd ./040/vm/
vagrant destroy -f
vagrant up
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../../
cd ./040/ansible/

```

## Настройка мастера

### Настройка мастера


<details><summary>см. pg_hba.conf</summary>

```text
# TYPE  DATABASE        USER            ADDRESS                 METHOD
# "local" is for Unix domain socket connections only
local   all             all                                         peer
# IPv4 local connections:
host    all             all                 192.168.40.10/32        md5
host    replication     replicator          192.168.40.10/32        md5
host    replication     replicator          192.168.40.11/32        md5

```

</details>


<details><summary>см. postgresql.conf</summary>

```text
listen_addresses = '192.168.40.10,localhost'
max_connections = 100
shared_buffers = 128MB
dynamic_shared_memory_type = posix
wal_level = hot_standby # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
# hot_standby = on # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
synchronous_commit = local
max_wal_size = 1GB
min_wal_size = 80MB
max_wal_senders = 2
wal_keep_segments = 10
max_replication_slots = 10
synchronous_standby_names = 'standby'
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 0
log_line_prefix = '%m [%p] '
log_timezone = 'UTC'
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
archive_mode = on		# enables archiving; off, on, or always
# archive_command = 'barman-wal-archive backup master %p'

```

</details>

```shell
ansible-playbook playbooks/master.yml --tags deploy > ../files/playbooks-master.yml.txt
```


<details><summary>см. лог выполнения `playbooks/master.yml`</summary>

```text

PLAY [Playbook of PostgreSQL master] *******************************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/master : Install PostgreSQL repo] *******************************
changed: [master]

TASK [../roles/master : Install PostgreSQL] ************************************
changed: [master]

TASK [../roles/master : Uninstall PostgreSQL] **********************************
ok: [master]

TASK [../roles/master : Remove PostgreSQL data dir] ****************************
changed: [master]

TASK [../roles/master : Init PostgreSQL] ***************************************
changed: [master]

TASK [../roles/master : Collect-pg.conf-files] *********************************
changed: [master] => (item=pg_hba.conf)
changed: [master] => (item=postgresql.conf)

TASK [../roles/master : Force restart PostgreSQL] ******************************
changed: [master]

TASK [../roles/master : Create PostgreSQL slot] ********************************
changed: [master]

TASK [../roles/master : Create PostgreSQL replicator user] *********************
changed: [master]

RUNNING HANDLER [../roles/master : restart-postgresql] *************************
changed: [master]

PLAY RECAP *********************************************************************
master                     : ok=11   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

### Настройка реплики


<details><summary>см. postgresql.conf</summary>

```text
listen_addresses = '192.168.40.11,localhost'
max_connections = 100
shared_buffers = 128MB
dynamic_shared_memory_type = posix
synchronous_commit = local
max_wal_size = 1GB
min_wal_size = 80MB
archive_mode = on
max_wal_senders = 2
wal_keep_segments = 10
max_replication_slots = 10
synchronous_standby_names = 'standby'
# wal_level = hot_standby # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
hot_standby = on # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 0
log_line_prefix = '%m [%p] '
log_timezone = 'UTC'
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

```

</details>


<details><summary>см. recovery.conf</summary>

```text
standby_mode = on
primary_conninfo = 'host=192.168.40.10 port=5432 user=replicator password=replicator'
primary_slot_name = 'pg_slot_replication'
trigger_file = '/tmp/trigger.192.168.40.10.5432'
```

</details>

```shell
ansible-playbook playbooks/replica.yml --tags deploy > ../files/playbooks-replica.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica.yml`</summary>

```text

PLAY [Playbook of PostgreSQL replica] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica : Install EPEL Repo package from standart repo] *********
changed: [replica]

TASK [../roles/replica : Install PostgreSQL repo] ******************************
changed: [replica]

TASK [../roles/replica : Uninstall PostgreSQL] *********************************
ok: [replica]

TASK [../roles/replica : Remove PostgreSQL data dir] ***************************
ok: [replica]

TASK [../roles/replica : Install PostgreSQL] ***********************************
changed: [replica]

TASK [../roles/replica : Init PostgreSQL] **************************************
changed: [replica]

TASK [../roles/replica : Force clear PostgreSQL data dir] **********************
changed: [replica]

TASK [../roles/replica : Create PostgreSQL data] *******************************
changed: [replica]

TASK [../roles/replica : Install python-pip for pexpect promt answering] *******
changed: [replica]

TASK [../roles/replica : Pip install pexpect] **********************************
changed: [replica]

TASK [../roles/replica : Clear PostgreSQL data dir] ****************************
changed: [replica]

TASK [../roles/replica : Copy database from master to slave] *******************
changed: [replica]

TASK [../roles/replica : Collect pg.conf-files] ********************************
changed: [replica] => (item=recovery.conf)
changed: [replica] => (item=postgresql.conf)

RUNNING HANDLER [../roles/replica : restart-postgresql] ************************
changed: [replica]

PLAY RECAP *********************************************************************
replica                    : ok=15   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

## Проверка работоспособности

### Что есть на реплике до какой-либо CRUD-"активности" на мастере

```shell
ansible-playbook playbooks/replica_check_before.yml > ../files/playbooks-replica_check_before.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica_check_before.yml`</summary>

```text

PLAY [Playbook of check replica before master activity] ************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica_check_before : PostgreSQL master checker] ***************
changed: [replica] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [replica] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [replica] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)

TASK [../roles/replica_check_before : Store check to file] *********************
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:32:26.038485', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-29 23:32:25.772734', 'stderr': '', 'delta': '0:00:00.265751', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:32:26.697617', 'stdout': '    schema_name     \n--------------------\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(6 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-29 23:32:26.563076', 'stderr': '', 'delta': '0:00:00.134541', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(6 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:32:27.338879', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(69 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-29 23:32:27.209093', 'stderr': '', 'delta': '0:00:00.129786', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(69 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
replica                    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Полученные результаты:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(6 строк)
```

</details>

<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(69 строк)
```

</details>

### Что есть на мастере и совершаем CRUD-"действия"

```shell
ansible-playbook playbooks/master_check_and_activity.yml > ../files/playbooks-master_check_and_activity.yml.txt
```


<details><summary>см. лог выполнения `playbooks/master_check_and_activity.yml`</summary>

```text

PLAY [Playbook of check master] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/master_check_and_activity : PostgreSQL master checker] **********
changed: [master] => (item=SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;)
changed: [master] => (item=SELECT * FROM pg_stat_replication;)
changed: [master] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [master] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [master] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)

TASK [../roles/master_check_and_activity : Store check to file] ****************
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:32:59.402661', 'stdout': ' application_name |   state   | sync_priority | sync_state \n------------------+-----------+---------------+------------\n walreceiver      | streaming |             0 | async\n(1 строка)', 'cmd': 'sudo -iu postgres psql -c "SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;"', 'rc': 0, 'start': '2021-10-29 23:32:59.118911', 'stderr': '', 'delta': '0:00:00.283750', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' application_name |   state   | sync_priority | sync_state ', '------------------+-----------+---------------+------------', ' walreceiver      | streaming |             0 | async', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:00.086560', 'stdout': '  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |        backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn | write_lag | flush_lag | replay_lag | sync_priority | sync_state \n-------+----------+------------+------------------+---------------+-----------------+-------------+------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------+-----------+------------+---------------+------------\n 17504 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       45988 | 2021-10-29 23:32:13.68041+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  |           |           |            |             0 | async\n(1 строка)', 'cmd': 'sudo -iu postgres psql -c "SELECT * FROM pg_stat_replication;"', 'rc': 0, 'start': '2021-10-29 23:32:59.955820', 'stderr': '', 'delta': '0:00:00.130740', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT * FROM pg_stat_replication;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |        backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn | write_lag | flush_lag | replay_lag | sync_priority | sync_state ', '-------+----------+------------+------------------+---------------+-----------------+-------------+------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------+-----------+------------+---------------+------------', ' 17504 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       45988 | 2021-10-29 23:32:13.68041+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  |           |           |            |             0 | async', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT * FROM pg_stat_replication;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:00.779231', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-29 23:33:00.622662', 'stderr': '', 'delta': '0:00:00.156569', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:01.431248', 'stdout': '    schema_name     \n--------------------\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(6 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-29 23:33:01.302194', 'stderr': '', 'delta': '0:00:00.129054', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(6 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:02.085434', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(69 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-29 23:33:01.958297', 'stderr': '', 'delta': '0:00:00.127137', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(69 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})

TASK [../roles/master_check_and_activity : PostgreSQL master activity] *********
changed: [master] => (item=DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;)
changed: [master] => (item=CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));)
changed: [master] => (item=INSERT INTO test_schema.test_table(value) VALUES ('first'),('second');)

TASK [../roles/master_check_and_activity : Store activity to file] *************
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:06.351266', 'stdout': 'CREATE SCHEMA', 'cmd': 'sudo -iu postgres psql -c "DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;"', 'rc': 0, 'start': '2021-10-29 23:33:06.216126', 'stderr': 'NOTICE:  schema "test_schema" does not exist, skipping', 'delta': '0:00:00.135140', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['CREATE SCHEMA'], 'stderr_lines': ['NOTICE:  schema "test_schema" does not exist, skipping'], 'failed': False, 'item': 'DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:07.032733', 'stdout': 'CREATE TABLE', 'cmd': 'sudo -iu postgres psql -c "CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));"', 'rc': 0, 'start': '2021-10-29 23:33:06.887606', 'stderr': '', 'delta': '0:00:00.145127', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['CREATE TABLE'], 'stderr_lines': [], 'failed': False, 'item': 'CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:07.698099', 'stdout': 'INSERT 0 2', 'cmd': 'sudo -iu postgres psql -c "INSERT INTO test_schema.test_table(value) VALUES (\'first\'),(\'second\');"', 'rc': 0, 'start': '2021-10-29 23:33:07.564173', 'stderr': '', 'delta': '0:00:00.133926', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "INSERT INTO test_schema.test_table(value) VALUES (\'first\'),(\'second\');"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['INSERT 0 2'], 'stderr_lines': [], 'failed': False, 'item': "INSERT INTO test_schema.test_table(value) VALUES ('first'),('second');", 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
master                     : ok=5    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

#### ... что есть на мастере


<details><summary>см. результат `SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication`</summary>

```text
-- SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;
 application_name |   state   | sync_priority | sync_state 
------------------+-----------+---------------+------------
 walreceiver      | streaming |             0 | async
(1 строка)
```

</details>

<details><summary>см. результат `SELECT * FROM pg_stat_replication`</summary>

```text
-- SELECT * FROM pg_stat_replication;
  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |        backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn | write_lag | flush_lag | replay_lag | sync_priority | sync_state 
-------+----------+------------+------------------+---------------+-----------------+-------------+------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------+-----------+------------+---------------+------------
 17504 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       45988 | 2021-10-29 23:32:13.68041+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  |           |           |            |             0 | async
(1 строка)
```

</details>

Полученные ниже результаты пригодятся для сравнения с изменениями на реплике после CRUD-"активности" на мастере:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(6 строк)
```

</details>

<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(69 строк)
```

</details>

#### ... совершаем CRUD-"действия" на мастере


<details><summary>см. лог выполнения `DROP SCHEMA IF EXISTS test_schema CASCADE ... CREATE SCHEMA test_schema`</summary>

```text
-- DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;
CREATE SCHEMA
```

</details>

<details><summary>см. лог выполнения `CREATE TABLE test_schema.test_table ...`</summary>

```text
-- CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));
CREATE TABLE
```

</details>

<details><summary>см. лог выполнения `INSERT INTO test_schema.test_table VALUES ...`</summary>

```text
-- INSERT INTO test_schema.test_table(value) VALUES ('first'),('second');
INSERT 0 2
```

</details>

### Что есть на реплике после CRUD-"активности" на мастере

```shell
ansible-playbook playbooks/replica_check_after.yml > ../files/playbooks-replica_check_after.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica_check_after.yml`</summary>

```text

PLAY [Playbook of check replica after master activity] *************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica_check_after : PostgreSQL master checker] ****************
changed: [replica] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [replica] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [replica] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)
changed: [replica] => (item=SELECT * FROM test_schema.test_table;)

TASK [../roles/replica_check_after : Store check to file] **********************
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:55.852908', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-29 23:33:55.686393', 'stderr': '', 'delta': '0:00:00.166515', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:56.505963', 'stdout': '    schema_name     \n--------------------\n test_schema\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(7 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-29 23:33:56.372916', 'stderr': '', 'delta': '0:00:00.133047', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' test_schema', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(7 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:57.195117', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n test_schema        | test_table\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(70 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-29 23:33:57.055762', 'stderr': '', 'delta': '0:00:00.139355', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' test_schema        | test_table', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(70 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})
changed: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:33:57.835558', 'stdout': ' id | value  \n----+--------\n  1 | first\n  2 | second\n(2 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT * FROM test_schema.test_table;"', 'rc': 0, 'start': '2021-10-29 23:33:57.709586', 'stderr': '', 'delta': '0:00:00.125972', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT * FROM test_schema.test_table;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' id | value  ', '----+--------', '  1 | first', '  2 | second', '(2 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT * FROM test_schema.test_table;', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
replica                    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Базы данных не изменились, так как не создавалось новых:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

Появились сведения о созданной на мастере схеме `test_schema`:


<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 test_schema
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(7 строк)
```

</details>

Появились сведения о созданной на мастере таблице `test_table` схемы `test_schema`:


<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 test_schema        | test_table
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(70 строк)
```

</details>

Появились реплицированные данные от мастера с таблицы `test_table` схемы `test_schema`:


<details><summary>см. результат `SELECT * FROM test_schema.test_table.txt`</summary>

```text
-- SELECT * FROM test_schema.test_table;
 id | value  
----+--------
  1 | first
  2 | second
(2 строки)
```

</details>

## Barman

### Дополнительно на мастере

```shell
ansible-playbook playbooks/barman_on_master.yml --tags deploy > ../files/playbooks-barman_on_master.yml.txt
```


<details><summary>см. лог выполнения `playbooks/barman_on_master.yml`</summary>

```text

PLAY [Playbook of PostgreSQL barman on master] *********************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/barman_on_master : Create PostgreSQL barman user] ***************
changed: [master] => (item=DROP USER IF EXISTS barman;)
changed: [master] => (item=CREATE USER barman SUPERUSER;)

TASK [../roles/barman_on_master : Create PostgreSQL streaming barman user] *****
changed: [master] => (item=CREATE USER streaming_barman REPLICATION;)
changed: [master] => (item=GRANT EXECUTE ON FUNCTION pg_start_backup(text, boolean, boolean) to streaming_barman;)
changed: [master] => (item=GRANT EXECUTE ON FUNCTION pg_stop_backup() to streaming_barman;)
changed: [master] => (item=GRANT EXECUTE ON FUNCTION pg_stop_backup(boolean, boolean) to streaming_barman;)
changed: [master] => (item=GRANT EXECUTE ON FUNCTION pg_switch_wal() to streaming_barman;)
changed: [master] => (item=GRANT EXECUTE ON FUNCTION pg_create_restore_point(text) to streaming_barman;)
changed: [master] => (item=GRANT pg_read_all_settings TO streaming_barman;)
changed: [master] => (item=GRANT pg_read_all_stats TO streaming_barman;)

TASK [../roles/barman_on_master : Collect PostgreSQL *.conf files] *************
changed: [master] => (item=pg_hba.conf)
changed: [master] => (item=postgresql.conf)

TASK [../roles/barman_on_master : Force restart PostgreSQL] ********************
changed: [master]

TASK [../roles/barman_on_master : Check local PostgreSQL access] ***************
changed: [master] => (item=psql -c 'SELECT version()' -U barman -h 127.0.0.1 postgres)
changed: [master] => (item=psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1)

TASK [../roles/barman_on_master : Store result of check local PostgreSQL access] ***
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:52:37.929853', 'stdout': '                                                 version                                                  \n----------------------------------------------------------------------------------------------------------\n PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n(1 строка)', 'cmd': "psql -c 'SELECT version()' -U barman -h 127.0.0.1 postgres", 'rc': 0, 'start': '2021-10-29 23:52:37.891152', 'stderr': '', 'delta': '0:00:00.038701', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': "psql -c 'SELECT version()' -U barman -h 127.0.0.1 postgres", 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['                                                 version                                                  ', '----------------------------------------------------------------------------------------------------------', ' PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': "psql -c 'SELECT version()' -U barman -h 127.0.0.1 postgres", 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:52:38.513522', 'stdout': '      systemid       | timeline |  xlogpos  | dbname \n---------------------+----------+-----------+--------\n 7024633752451234416 |        1 | 0/302B4B8 | \n(1 строка)', 'cmd': 'psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1', 'rc': 0, 'start': '2021-10-29 23:52:38.488641', 'stderr': '', 'delta': '0:00:00.024881', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['      systemid       | timeline |  xlogpos  | dbname ', '---------------------+----------+-----------+--------', ' 7024633752451234416 |        1 | 0/302B4B8 | ', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1', 'ansible_loop_var': 'item'})

TASK [../roles/barman_on_master : Install EPEL Repo package from standart repo] ***
changed: [master]

TASK [../roles/barman_on_master : Install Barman Client for backup with streaming] ***
changed: [master]

RUNNING HANDLER [../roles/barman_on_master : restart-postgresql] ***************
changed: [master]

PLAY RECAP *********************************************************************
master                     : ok=10   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Промежуточная проверка. Соединения __локально__ работают:


<details><summary>см. PSQL: barman SELECT version()</summary>

```text
-- psql -c 'SELECT version()' -U barman -h 127.0.0.1 postgres
                                                 version                                                  
----------------------------------------------------------------------------------------------------------
 PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit
(1 строка)
```

</details>


<details><summary>см. PSQL: streaming_barman IDENTIFY_SYSTEM</summary>

```text
-- psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1
      systemid       | timeline |  xlogpos  | dbname 
---------------------+----------+-----------+--------
 7024633752451234416 |        1 | 0/302B4B8 | 
(1 строка)
```

</details>

### На Barman-сервере

Я решил использовать вариант `streaming` режима (то есть не `Rsync via SSH`).

Подробная официальная документация:
* https://docs.pgbarman.org/release/2.15/

Но есть еще:
* https://medium.com/coderbunker/implement-backup-with-barman-bb0b44af71f9
* https://blog.dbi-services.com/postgresql-barman-rsync-method-vs-streaming-method/
* https://sidmid.ru/barman-%D0%BC%D0%B5%D0%BD%D0%B5%D0%B4%D0%B6%D0%B5%D1%80-%D0%B1%D1%8D%D0%BA%D0%B0%D0%BF%D0%BE%D0%B2-%D0%B4%D0%BB%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%BE%D0%B2-postgresql/
* https://habr.com/ru/company/yoomoney/blog/333844/
* http://innerlife.io/ru/fault-tolerant-postgresql-cluster-part4-2/
* https://virtbox.blogspot.com/2013/11/barman-postgresql-backup-and-recovery.html
* https://oguridatabasetech.com/2018/02/06/barman-error-impossible-to-start-the-backup-check-the-log-for-more-details/
* https://postgrespro.ru/list/thread-id/2371354
* https://itectec.com/database/postgresql-error-receiving-wal-files-with-barman/

Это привожу все потому, что у меня НЕ ВЫХОДИТ Ансиблом автоматизировать деплой и не выходит как-либо получить бекап.
Подробно ниже.

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags install-postgresql > ../files/playbooks-barman_on_backup-install-postgresql.yml.txt
```


<details><summary>см. лог выполнения `playbooks/barman_on_backup.yml --tags install-postgresql`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Install PostgreSQL repo] *********************
ok: [backup]

TASK [../roles/barman_on_backup : Install PostgreSQL server] *******************
ok: [backup]

TASK [../roles/barman_on_backup : Remote access check] *************************
changed: [backup] => (item=psql -c 'SELECT version()' -U barman -h 192.168.40.10 postgres)
changed: [backup] => (item=psql -U streaming_barman -h 192.168.40.10 -c "IDENTIFY_SYSTEM" replication=1)

TASK [../roles/barman_on_backup : Store remote access check] *******************
changed: [backup -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:53:43.109494', 'stdout': '                                                 version                                                  \n----------------------------------------------------------------------------------------------------------\n PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n(1 строка)', 'cmd': "psql -c 'SELECT version()' -U barman -h 192.168.40.10 postgres", 'rc': 0, 'start': '2021-10-29 23:53:43.045344', 'stderr': '', 'delta': '0:00:00.064150', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': "psql -c 'SELECT version()' -U barman -h 192.168.40.10 postgres", 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['                                                 version                                                  ', '----------------------------------------------------------------------------------------------------------', ' PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': "psql -c 'SELECT version()' -U barman -h 192.168.40.10 postgres", 'ansible_loop_var': 'item'})
changed: [backup -> localhost] => (item={'changed': True, 'end': '2021-10-29 23:53:43.699676', 'stdout': '      systemid       | timeline |  xlogpos  | dbname \n---------------------+----------+-----------+--------\n 7024633752451234416 |        1 | 0/4000098 | \n(1 строка)', 'cmd': 'psql -U streaming_barman -h 192.168.40.10 -c "IDENTIFY_SYSTEM" replication=1', 'rc': 0, 'start': '2021-10-29 23:53:43.670554', 'stderr': '', 'delta': '0:00:00.029122', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'psql -U streaming_barman -h 192.168.40.10 -c "IDENTIFY_SYSTEM" replication=1', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['      systemid       | timeline |  xlogpos  | dbname ', '---------------------+----------+-----------+--------', ' 7024633752451234416 |        1 | 0/4000098 | ', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'psql -U streaming_barman -h 192.168.40.10 -c "IDENTIFY_SYSTEM" replication=1', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
backup                     : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Кстати, у barman именно сервер PostgreSQL в зависимостях, одним psql не обойтись.

В рамках роли выше проведена промежуточная проверка. Соединения __удаленно__ работают:


<details><summary>см. PSQL: barman SELECT version()</summary>

```text
-- psql -c 'SELECT version()' -U barman -h 192.168.40.10 postgres
                                                 version                                                  
----------------------------------------------------------------------------------------------------------
 PostgreSQL 11.13 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit
(1 строка)
```

</details>


<details><summary>см. PSQL: streaming_barman IDENTIFY_SYSTEM</summary>

```text
-- psql -U streaming_barman -h 127.0.0.1 -c "IDENTIFY_SYSTEM" replication=1
      systemid       | timeline |  xlogpos  | dbname 
---------------------+----------+-----------+--------
 7024633752451234416 |        1 | 0/302B4B8 | 
(1 строка)
```

</details>

Установим и настроим барман


<details><summary>см. общий конфиг `barman.conf`</summary>

```text
[barman]
active = true
barman_user = barman
barman_home = /var/lib/barman
configuration_files_directory = /etc/barman.d
log_file = /var/log/barman/barman.log
log_level = INFO
compression = gzip
retention_policy = REDUNDANCY 3
immediate_checkpoint = true
last_backup_maximum_age = 4 DAYS
minimum_redundancy = 1

```

</details>


<details><summary>см. конфиг подопечного сервера `pg.conf`</summary>

```text
[pg]
description =  "PostgreSQL Streaming Backup"
conninfo = host=192.168.40.10 user=barman dbname=postgres
backup_method = postgres

streaming_conninfo = host=192.168.40.10 user=streaming_barman dbname=postgres
streaming_archiver = on
slot_name = barman

```

</details>

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags install-and-configure-barman > ../files/playbooks-barman_on_backup-install-and-configure-barman.yml.txt
```


<details><summary>см. лог выполнения `playbooks/barman_on_backup.yml --tags install-and-configure-barman`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Install EPEL Repo package from standart repo] ***
ok: [backup]

TASK [../roles/barman_on_backup : Yum install Barman requirements] *************
ok: [backup] => (item=postgresql11-libs.x86_64)

TASK [../roles/barman_on_backup : Install Barman package] **********************
ok: [backup]

TASK [../roles/barman_on_backup : Update PATH - /etc/environment - not bug, just feature - for pg_receivexlog OK] ***
changed: [backup]

TASK [../roles/barman_on_backup : Update PATH - ~/.* - not bug, just feature - for pg_receivexlog OK] ***
changed: [backup]

TASK [../roles/barman_on_backup : Configure barman] ****************************
ok: [backup] => (item=/etc/barman.conf)
ok: [backup] => (item=/etc/barman.d/pg.conf)

TASK [../roles/barman_on_backup : Create barman slot] **************************
changed: [backup]

TASK [../roles/barman_on_backup : Barman Cron as timed serviсe] ****************
changed: [backup] => (item=barman-cron.service)
changed: [backup] => (item=barman-cron.timer)

TASK [../roles/barman_on_backup : systemctl start barman-cron.timer] ***********
changed: [backup]

TASK [../roles/barman_on_backup : Check barman cron as timed serviсe] **********
changed: [backup]

TASK [../roles/barman_on_backup : Store barman cron as timed serviсe check] ****
changed: [backup -> localhost]

TASK [../roles/barman_on_backup : Barman check] ********************************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman check pg`] *****************
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman check pg\nexit 0 # because may be fail\n",
        "delta": "0:00:00.590807",
        "end": "2021-10-29 23:54:31.154369",
        "failed": false,
        "rc": 0,
        "start": "2021-10-29 23:54:30.563562",
        "stderr": "",
        "stderr_lines": [],
        "stdout": "Server pg:\n\tWAL archive: FAILED (please make sure WAL shipping is setup)\n\tPostgreSQL: OK\n\tsuperuser or standard user with backup privileges: OK\n\tPostgreSQL streaming: OK\n\twal_level: OK\n\treplication slot: FAILED (slot 'barman' not initialised: is 'receive-wal' running?)\n\tdirectories: OK\n\tretention policy settings: OK\n\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)\n\tcompression settings: OK\n\tfailed backups: OK (there are 0 failed backups)\n\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)\n\tpg_basebackup: OK\n\tpg_basebackup compatible: OK\n\tpg_basebackup supports tablespaces mapping: OK\n\tsystemid coherence: OK (no system Id stored on disk)\n\tpg_receivexlog: OK\n\tpg_receivexlog compatible: OK\n\treceive-wal running: FAILED (See the Barman log file for more details)\n\tarchiver errors: OK",
        "stdout_lines": [
            "Server pg:",
            "\tWAL archive: FAILED (please make sure WAL shipping is setup)",
            "\tPostgreSQL: OK",
            "\tsuperuser or standard user with backup privileges: OK",
            "\tPostgreSQL streaming: OK",
            "\twal_level: OK",
            "\treplication slot: FAILED (slot 'barman' not initialised: is 'receive-wal' running?)",
            "\tdirectories: OK",
            "\tretention policy settings: OK",
            "\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)",
            "\tcompression settings: OK",
            "\tfailed backups: OK (there are 0 failed backups)",
            "\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)",
            "\tpg_basebackup: OK",
            "\tpg_basebackup compatible: OK",
            "\tpg_basebackup supports tablespaces mapping: OK",
            "\tsystemid coherence: OK (no system Id stored on disk)",
            "\tpg_receivexlog: OK",
            "\tpg_receivexlog compatible: OK",
            "\treceive-wal running: FAILED (See the Barman log file for more details)",
            "\tarchiver errors: OK"
        ]
    }
}

TASK [../roles/barman_on_backup : Barman switch-wal force archive] *************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman switch-wal --force --archive pg`] ***
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman switch-wal --force --archive pg\nexit 0 # because may be fail\n",
        "delta": "0:00:30.753896",
        "end": "2021-10-29 23:55:02.564228",
        "failed": false,
        "rc": 0,
        "start": "2021-10-29 23:54:31.810332",
        "stderr": "ERROR: The WAL file 000000010000000000000004 has not been received in 30 seconds",
        "stderr_lines": [
            "ERROR: The WAL file 000000010000000000000004 has not been received in 30 seconds"
        ],
        "stdout": "The WAL file 000000010000000000000004 has been closed on server 'pg'\nWaiting for the WAL file 000000010000000000000004 from server 'pg' (max: 30 seconds)",
        "stdout_lines": [
            "The WAL file 000000010000000000000004 has been closed on server 'pg'",
            "Waiting for the WAL file 000000010000000000000004 from server 'pg' (max: 30 seconds)"
        ]
    }
}

PLAY RECAP *********************************************************************
backup                     : ok=16   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Сервис  `barman-cron` 


<details><summary>см. код `barman-cron.service`</summary>

```text
[Unit]
Description=Barman cron
Wants=barman-cron.timer

[Service]
User=barman
Type=oneshot
ExecStart=/usr/bin/barman cron

[Install]
WantedBy=multi-user.target
```

</details>


<details><summary>см. код `barman-cron.timer`</summary>

```text
[Unit]
Description=Barman cron scheduled
Requires=barman-cron.service

[Timer]
Unit=barman-cron.service
OnUnitActiveSec=60

[Install]
WantedBy=timers.target
```

</details>

работает:


<details><summary>см. лог работы `barman-cron.service`</summary>

```text
-- journalctl -u barman-cron
-- Logs begin at Пт 2021-10-29 22:59:54 UTC, end at Пт 2021-10-29 23:54:29 UTC. --
окт 29 23:54:28 backup systemd[1]: Starting Barman cron...
окт 29 23:54:28 backup barman[19118]: Starting WAL archiving for server pg
окт 29 23:54:28 backup barman[19118]: Starting streaming archiver for server pg
окт 29 23:54:28 backup systemd[1]: Started Barman cron.
```

</details>

Но в ходе выполнения есть ошибки

```shell
"stderr_lines": [
    "ERROR: The WAL file 000000010000000000000004 has not been received in 30 seconds"
],
"stdout_lines": [
    "The WAL file 000000010000000000000004 has been closed on server 'pg'",
    "Waiting for the WAL file 000000010000000000000006 from server 'pg' (max: 30 seconds)"
]
```

Однако подробнее в `barman check pg`

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags barman-check > ../files/barman-check-001.txt
```

прошел c ошибками


<details><summary>см. лог выполнения `barman-check`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Barman check] ********************************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman check pg`] *****************
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman check pg\nexit 0 # because may be fail\n",
        "delta": "0:00:01.102180",
        "end": "2021-10-30 00:02:28.957402",
        "failed": false,
        "rc": 0,
        "start": "2021-10-30 00:02:27.855222",
        "stderr": "",
        "stderr_lines": [],
        "stdout": "Server pg:\n\tWAL archive: FAILED (please make sure WAL shipping is setup)\n\tPostgreSQL: OK\n\tsuperuser or standard user with backup privileges: OK\n\tPostgreSQL streaming: OK\n\twal_level: OK\n\treplication slot: FAILED (slot 'barman' not initialised: is 'receive-wal' running?)\n\tdirectories: OK\n\tretention policy settings: OK\n\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)\n\tcompression settings: OK\n\tfailed backups: OK (there are 0 failed backups)\n\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)\n\tpg_basebackup: OK\n\tpg_basebackup compatible: OK\n\tpg_basebackup supports tablespaces mapping: OK\n\tsystemid coherence: OK (no system Id stored on disk)\n\tpg_receivexlog: OK\n\tpg_receivexlog compatible: OK\n\treceive-wal running: FAILED (See the Barman log file for more details)\n\tarchiver errors: OK",
        "stdout_lines": [
            "Server pg:",
            "\tWAL archive: FAILED (please make sure WAL shipping is setup)",
            "\tPostgreSQL: OK",
            "\tsuperuser or standard user with backup privileges: OK",
            "\tPostgreSQL streaming: OK",
            "\twal_level: OK",
            "\treplication slot: FAILED (slot 'barman' not initialised: is 'receive-wal' running?)",
            "\tdirectories: OK",
            "\tretention policy settings: OK",
            "\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)",
            "\tcompression settings: OK",
            "\tfailed backups: OK (there are 0 failed backups)",
            "\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)",
            "\tpg_basebackup: OK",
            "\tpg_basebackup compatible: OK",
            "\tpg_basebackup supports tablespaces mapping: OK",
            "\tsystemid coherence: OK (no system Id stored on disk)",
            "\tpg_receivexlog: OK",
            "\tpg_receivexlog compatible: OK",
            "\treceive-wal running: FAILED (See the Barman log file for more details)",
            "\tarchiver errors: OK"
        ]
    }
}

PLAY RECAP *********************************************************************
backup                     : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

выдержка:

```shell
barman check pg | grep FAILED

    WAL archive: FAILED (please make sure WAL shipping is setup)
    replication slot: FAILED (slot 'barman' not initialised: is 'receive-wal' running?)
    backup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)
    minimum redundancy requirements: FAILED (have 0 backups, expected at least 1)
    receive-wal running: FAILED (See the Barman log file for more details)
```

Дадим полезную нагрузку WAL:

```shell
ansible-playbook playbooks/master_activity.yml > ../files/playbooks-master_activity.yml.txt
```


<details><summary>см. лог выполнения `playbooks/master_activity.yml`</summary>

```text

PLAY [Playbook of activity master] *********************************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/master_activity : PostgreSQL master activity] *******************
changed: [master] => (item=1)
changed: [master] => (item=2)
changed: [master] => (item=3)
changed: [master] => (item=4)
changed: [master] => (item=5)
changed: [master] => (item=6)
changed: [master] => (item=7)
changed: [master] => (item=8)
changed: [master] => (item=9)
changed: [master] => (item=10)

PLAY RECAP *********************************************************************
master                     : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Повторим отдельно принудительный сбор

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags barman-force-switch-wal > ../files/barman-force-switch-wal-001.txt
```


<details><summary>см. лог выполнения `barman-force-switch-wal`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Barman switch-wal force archive] *************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman switch-wal --force --archive pg`] ***
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman switch-wal --force --archive pg\nexit 0 # because may be fail\n",
        "delta": "0:00:30.720946",
        "end": "2021-10-30 00:04:50.526839",
        "failed": false,
        "rc": 0,
        "start": "2021-10-30 00:04:19.805893",
        "stderr": "ERROR: The WAL file 000000010000000000000005 has not been received in 30 seconds",
        "stderr_lines": [
            "ERROR: The WAL file 000000010000000000000005 has not been received in 30 seconds"
        ],
        "stdout": "The WAL file 000000010000000000000005 has been closed on server 'pg'\nWaiting for the WAL file 000000010000000000000005 from server 'pg' (max: 30 seconds)",
        "stdout_lines": [
            "The WAL file 000000010000000000000005 has been closed on server 'pg'",
            "Waiting for the WAL file 000000010000000000000005 from server 'pg' (max: 30 seconds)"
        ]
    }
}

PLAY RECAP *********************************************************************
backup                     : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Как видим, есть ошибки

```shell
"stderr_lines": [
    "ERROR: The WAL file 000000010000000000000006 has not been received in 30 seconds"
],
"stdout_lines": [
    "The WAL file 000000010000000000000006 has been closed on server 'pg'",
    "Waiting for the WAL file 000000010000000000000006 from server 'pg' (max: 30 seconds)"
]
```
И ситуация не поменялась.

А вот дальше - магия. Запускаем `barman cron pg` - а это то, что уже и так запущено в службе и периодически

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags barman-cron
```

и повторим забор wal (тоже самое делалось и ранее в ходе `--tags install-and-configure-barman`)

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags barman-force-switch-wal > ../files/barman-force-switch-wal-002.txt
```

O, чудо. Ошибки исполнения `barman switch-wal --force --archive pg` исчезли


<details><summary>см. лог выполнения `barman-force-switch-wal`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Barman switch-wal force archive] *************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman switch-wal --force --archive pg`] ***
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman switch-wal --force --archive pg\nexit 0 # because may be fail\n",
        "delta": "0:00:04.622894",
        "end": "2021-10-30 00:07:53.265261",
        "failed": false,
        "rc": 0,
        "start": "2021-10-30 00:07:48.642367",
        "stderr": "",
        "stderr_lines": [],
        "stdout": "The WAL file 000000010000000000000006 has been closed on server 'pg'\nWaiting for the WAL file 000000010000000000000006 from server 'pg' (max: 30 seconds)\nProcessing xlog segments from streaming for pg\n\t000000010000000000000006",
        "stdout_lines": [
            "The WAL file 000000010000000000000006 has been closed on server 'pg'",
            "Waiting for the WAL file 000000010000000000000006 from server 'pg' (max: 30 seconds)",
            "Processing xlog segments from streaming for pg",
            "\t000000010000000000000006"
        ]
    }
}

PLAY RECAP *********************************************************************
backup                     : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Выдержка:

```text
The WAL file t000000010000000000000006 has been closed on server 'pg'
Waiting for the WAL file t000000010000000000000006 from server 'pg' (max: 30 seconds)
Processing xlog segments from streaming for pg
t000000010000000000000006
```

При этом и в чеке 

```shell
ansible-playbook playbooks/barman_on_backup.yml --tags barman-check > ../files/barman-check-002.txt
```


<details><summary>см. лог выполнения `barman-check`</summary>

```text

PLAY [Playbook of PostgreSQL barman on backup] *********************************

TASK [Gathering Facts] *********************************************************
ok: [backup]

TASK [../roles/barman_on_backup : Barman check] ********************************
changed: [backup]

TASK [../roles/barman_on_backup : result of `barman check pg`] *****************
ok: [backup] => {
    "msg": {
        "changed": true,
        "cmd": "barman check pg\nexit 0 # because may be fail\n",
        "delta": "0:00:00.702828",
        "end": "2021-10-30 00:09:16.446698",
        "failed": false,
        "rc": 0,
        "start": "2021-10-30 00:09:15.743870",
        "stderr": "",
        "stderr_lines": [],
        "stdout": "Server pg:\n\tPostgreSQL: OK\n\tsuperuser or standard user with backup privileges: OK\n\tPostgreSQL streaming: OK\n\twal_level: OK\n\treplication slot: OK\n\tdirectories: OK\n\tretention policy settings: OK\n\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)\n\tcompression settings: OK\n\tfailed backups: OK (there are 0 failed backups)\n\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)\n\tpg_basebackup: OK\n\tpg_basebackup compatible: OK\n\tpg_basebackup supports tablespaces mapping: OK\n\tsystemid coherence: OK (no system Id stored on disk)\n\tpg_receivexlog: OK\n\tpg_receivexlog compatible: OK\n\treceive-wal running: OK\n\tarchiver errors: OK",
        "stdout_lines": [
            "Server pg:",
            "\tPostgreSQL: OK",
            "\tsuperuser or standard user with backup privileges: OK",
            "\tPostgreSQL streaming: OK",
            "\twal_level: OK",
            "\treplication slot: OK",
            "\tdirectories: OK",
            "\tretention policy settings: OK",
            "\tbackup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)",
            "\tcompression settings: OK",
            "\tfailed backups: OK (there are 0 failed backups)",
            "\tminimum redundancy requirements: FAILED (have 0 backups, expected at least 1)",
            "\tpg_basebackup: OK",
            "\tpg_basebackup compatible: OK",
            "\tpg_basebackup supports tablespaces mapping: OK",
            "\tsystemid coherence: OK (no system Id stored on disk)",
            "\tpg_receivexlog: OK",
            "\tpg_receivexlog compatible: OK",
            "\treceive-wal running: OK",
            "\tarchiver errors: OK"
        ]
    }
}

PLAY RECAP *********************************************************************
backup                     : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

теперь нет обшибок с WAL, а только связанное с бекапом (это также сохранится и при перезагрузке системы, будет FAILED и потом самодиагностируется в OK)

Выдержка:

```shell
Server pg:
    ...
    backup maximum age: FAILED (interval provided: 4 days, latest backup age: No available backups)
    minimum redundancy requirements: FAILED (have 0 backups, expected at least 1)
    ...
```

Кроме того, все эти действия не позволяют делать `backup`, точнее он просто виснет

```shell
sudo su - barman

barman backup pg
    Starting backup using postgres method for server pg in /var/lib/barman/pg/base/20211030T001134
    Backup start at LSN: 0/7000060 (000000010000000000000007, 00000060)
    Starting backup copy via pg_basebackup for 20211030T001134
```
... и долгая-долгая тишина... вроде как, ничего не происходит.

Итог. Я не понимаю:
1) почему у меня не работает бекап, точнее он запускается, но не останавливается. 
2) почему нужно крон запустить не в сервисе изначально, а просто в терминале.

## Разный шлак на память

```shell

cd ../../
cd ./040/vm/
vagrant destroy -f
vagrant up
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../../
cd ./040/ansible/
ansible-playbook playbooks/master.yml --tags deploy > ../files/playbooks-master.yml.txt
ansible-playbook playbooks/replica.yml --tags deploy > ../files/playbooks-replica.yml.txt
ansible-playbook playbooks/replica_check_before.yml > ../files/playbooks-replica_check_before.yml.txt
ansible-playbook playbooks/master_check_and_activity.yml > ../files/playbooks-master_check_and_activity.yml.txt
ansible-playbook playbooks/replica_check_after.yml > ../files/playbooks-replica_check_after.yml.txt

ansible-playbook playbooks/barman_on_master.yml --tags deploy > ../files/playbooks-barman_on_master.yml.txt
 
ansible-playbook playbooks/barman_on_backup.yml --tags install-postgresql-repo > ../files/playbooks-barman_on_master-install-postgresql-repo.yml.txt
ansible-playbook playbooks/barman_on_backup.yml --tags install-postgresql-server > ../files/playbooks-barman_on_master-install-postgresql-server.yml.txt
ansible-playbook playbooks/barman_on_backup.yml --tags remote-access-check > ../files/playbooks-barman_on_master-remote-access-check.yml.txt
 
ansible-playbook playbooks/barman_on_backup.yml --tags install-epel-repo > ../files/playbooks-barman_on_master-install-epel-repo.yml.txt
ansible-playbook playbooks/barman_on_backup.yml --tags yum-barman-requirements > ../files/playbooks-barman_on_master-yum-barman-requirements.yml.txt
ansible-playbook playbooks/barman_on_backup.yml --tags install-barman-package > ../files/playbooks-barman_on_master-install-barman-package.yml.txt
ansible-playbook playbooks/barman_on_backup.yml --tags copy-config-files
ansible-playbook playbooks/barman_on_backup.yml --tags create-barman-slot
ansible-playbook playbooks/barman_on_backup.yml --tags add-path
ansible-playbook playbooks/barman_on_backup.yml --tags barman-cron-service
ansible-playbook playbooks/master_activity.yml # полезная нагрузка WAL
#ansible-playbook playbooks/barman_on_backup.yml --tags barman-switch-wal
ansible-playbook playbooks/barman_on_backup.yml --tags barman-force-switch-wal


* * * * * export PATH=$PATH:/usr/pgsql-9.6/bin; barman cron >/dev/null 2>&1



barman check pg

cd ../../
./details.py 040.details.md 0




psql postgresql://192.168.40.10:5432/postgres?sslmode=require
psql -H 192.168.40.10:5432 -U postgres -W

# su - postgres
# psql template1
# CREATE USER replication WITH PASSWORD 'replication';
# GRANT ALL PRIVILEGES ON DATABASE "postgres" to replication;
# GRANT ALL PRIVILEGES ON DATABASE "postgres" to 'replication';
CREATE USER replication REPLICATION LOGIN CONNECTION LIMIT 5 ENCRYPTED PASSWORD 'ident';"

sudo -u postgres psql
CREATE DATABASE test;
CREATE USER test WITH ENCRYPTED PASSWORD 'test';
GRANT ALL PRIVILEGES ON DATABASE test TO test;
psql -h 192.168.40.10 -U test -d test 


CREATE USER replication REPLICATION LOGIN CONNECTION LIMIT 5 ENCRYPTED PASSWORD 'replication';"

ошибка: не удалось подключиться к серверу: Нет маршрута до узла
        Он действительно работает по адресу "192.168.40.10"
         и принимает TCP-соединения (порт 5432)?

netstat -nlp | grep 5432

systemctl stop postgresql-11
systemctl start postgresql-11
sudo service postgresql-11 restart

psql -h 192.168.40.10 -U replication -d replication -W
psql -h 192.168.40.10 -U test -d test -W

lsof -i | grep 'post'

Тогда вы можете узнать, какой порт слушает.
psql -U postgres -p "port_in_use"

ansible-playbook playbooks/master.yml   --tags collect-pg.conf-files
ansible-playbook playbooks/replica.yml  --tags collect-pg.conf-files
ansible-playbook playbooks/master.yml   --tags deploy
ansible-playbook playbooks/replica.yml  --tags install-epel-repo
ansible-playbook playbooks/replica.yml  --tags install-postgresql
ansible-playbook playbooks/replica.yml  --tags create-postgresql-data-dir
ansible-playbook playbooks/replica.yml  --tags install-python3-pip
ansible-playbook playbooks/replica.yml  --tags install-python3-pexpect
ansible-playbook playbooks/replica.yml  --tags copy-master-data
ansible-playbook playbooks/master.yml   --tags collect-pg.conf-files


SELECT datname FROM pg_database;
SELECT schema_name FROM information_schema.schemata;
SELECT schemaname, tablename FROM pg_catalog.pg_tables;
SELECT * FROM public.testtable;
\c test 

```

## Заместки

* pexpect==3.3 - очень важно именно такая версия, так как в репе 2.*
* generic/centos7 - плохой дистрибутив для реплицирования PostgreSQL, что-то с недоступностью по 5432




ansible-playbook playbooks/barman_on_backup.yml --tags deploy
ansible-playbook playbooks/barman_on_backup.yml --tags step-001
ansible-playbook playbooks/barman_on_backup.yml --tags precheck-barman
ansible-playbook playbooks/barman_on_backup.yml --tags precheck-replicator-barman
ansible-playbook playbooks/barman_on_backup.yml --tags install-barman
ansible-playbook playbooks/barman_on_backup.yml --tags configure-barman
ansible-playbook playbooks/barman_on_backup.yml --tags copy-config-files
ansible-playbook playbooks/barman_on_master.yml
ansible-playbook playbooks/barman_on_backup.yml --tags copy-config-files
precheck_replicator_barman



su - barman
barman receive-wal --create-slot pg
barman switch-wal --force --archive pg
barman check pg
yum repolist
yum repolist enabled

yum --disablerepo="*" --enablerepo='2ndquadrant-dl-default-release-pg11/7/x86_64' install barman

 yum install postgresql11-libs.x86_64


Actually the given URL also says in the System requirements section:

    Linux/Unix
    Python >= 3.4
    Python modules:
        argcomplete
        argh >= 0.21.2
        psycopg2 >= 2.4.2
        python-dateutil
        setuptools
    PostgreSQL >= 8.3
    rsync >= 3.0.4 (optional for PostgreSQL >= 9.2)

barman cron

ssh -o "StrictHostKeyChecking no" postgres@192.168.40.10


sudo yum -y install barman
yum provides audit2allow

yum install policycoreutils-python

 sudo audit2allow -a
* * * * * echo $(date '+%Y-%m-%d') >> /var/lib/barman/1.txt

#============= sshd_t ==============
allow sshd_t postgresql_db_t:file read;

sudo audit2allow -a -M pg_ssh
sudo  semodule -i  pg_ssh.pp

#!!!! The file '/var/lib/pgsql/.ssh/authorized_keys' is mislabeled on your system.  
#!!!! Fix with $ restorecon -R -v /var/lib/pgsql/.ssh/authorized_keys
allow sshd_t postgresql_db_t:file open;

#!!!! This avc is allowed in the current policy
allow sshd_t postgresql_db_t:file read;

#!!!! The file '/var/lib/pgsql/.ssh/authorized_keys' is mislabeled on your system.  
#!!!! Fix with $ restorecon -R -v /var/lib/pgsql/.ssh/authorized_keys
allow sshd_t postgresql_db_t:file getattr;

#!!!! This avc is allowed in the current policy
allow sshd_t postgresql_db_t:file { open read };
[vagrant@master ~]$ sudo audit2allow -a -M pg_ssh


barman cron
* * * * * export PATH=$PATH:/usr/pgsql-9.6/bin; barman cron >/dev/null 2>&1

 sudo su - barman
Last login: Вт окт 26 19:42:21 UTC 2021 on pts/0
-bash-4.2$ barman cron

barman backup pg --wait

 sudo su - postgres
-bash-4.2$ psql
psql (11.13)
Type "help" for help.

postgres=# select * from pg_replication_slots;
      slot_name      | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn 
---------------------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------
 pg_slot_replication |        | physical  |        |          | f         | t      |      21626 |      |              | 0/B01FA90   | 
(1 row)

* * * * * export PATH=$PATH:/usr/pgsql-11/bin; barman cron >/dev/null 2>&1
barman switch-xlog --force --archive
------------------

   66  export PATH=$PATH:/usr/pgsql-11/bin/
   67  echo $PATH
   68  barman receive-wal pg
   69  barman check pg
   70  barman switch-wal --force --archive pg
   71  barman receive-wal pg
   72  barman switch-xlog --force --archive
   73  barman switch-xlog --force --archive pg
   74  barman check pg
   75  history


30 23 * * * /usr/bin/barman backup clust_dvdrental

systemctl status barman-cron
systemctl status barman-cron.timer
systemctl stop barman-cron.timer
systemctl start barman-cron.timer
 sudo journalctl -u  barman-cron


 sudo su - barman
barman receive-wal --create-slot pg
barman cron
barman switch-wal --force --archive pg
barman backup pg
barman check pg
barman switch-wal pg

yum repolist
yum repolist enabled
```