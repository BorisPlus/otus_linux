# Репликация Postgres

* настроить hot_standby репликацию с использованием слотов
* настроить правильное резервное копирование

Для сдачи работы присылаем ссылку на репозиторий, в котором должны обязательно быть 

* Vagranfile (2 машины)
* плейбук Ansible
* конфигурационные файлы postgresql.conf, pg_hba.conf и recovery.conf,
* конфиг barman, либо скрипт резервного копирования.

Команда "vagrant up" должна поднимать машины с настроенной репликацией и резервным копированием. 
Рекомендуется в README.md файл вложить результаты (текст или скриншоты) проверки работы репликации и резервного копирования.

Пример плейбука:
```text
    name: Установка postgres11
    hosts: master, slave
    become: yes
    roles:
        postgres_install

    name: Настройка master
    hosts: master
    become: yes
    roles:
        master-setup

    name: Настройка slave
    hosts: slave
    become: yes
    roles:
        slave-setup

    name: Создание тестовой БД
    hosts: master
    become: yes
    roles:
        create_test_db

    name: Настройка barman
    hosts: barman
    become: yes
    roles:
        barman_install tags:
        barman
```

## Исполнение

* https://habr.com/ru/post/213409/
```text
Hot standby — позволяет slave нодам обслуживать READ запросы для балансировки нагрузки, в отличии от warm standby, при котором slave сервер не обслуживает запросов клиентов, а только постоянно подтягивает себе с мастера актуальную базу. 
```

```shell
cd ../../
cd ./040/vm/
vagrant destroy -f
vagrant up
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../../
cd ./040/ansible/

```

## Настройка мастера

### Настройка мастера

```shell
ansible-playbook playbooks/master.yml --tags deploy > ../files/playbooks-master.yml.txt
```


<details><summary>см. лог выполнения `playbooks/master.yml`</summary>

```text

PLAY [Playbook of PostgreSQL master] *******************************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/master : Install PostgreSQL repo] *******************************
changed: [master]

TASK [../roles/master : Install PostgreSQL] ************************************
changed: [master]

TASK [../roles/master : Uninstall PostgreSQL] **********************************
ok: [master]

TASK [../roles/master : Remove PostgreSQL data dir] ****************************
changed: [master]

TASK [../roles/master : Init PostgreSQL] ***************************************
changed: [master]

TASK [../roles/master : Collect-pg.conf-files] *********************************
changed: [master] => (item=pg_hba.conf)
changed: [master] => (item=postgresql.conf)

TASK [../roles/master : Force restart PostgreSQL] ******************************
changed: [master]

TASK [../roles/master : Create PostgreSQL slot] ********************************
changed: [master]

TASK [../roles/master : Create PostgreSQL replicator user] *********************
changed: [master]

RUNNING HANDLER [../roles/master : restart-postgresql] *************************
changed: [master]

PLAY RECAP *********************************************************************
master                     : ok=11   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>


<details><summary>см. pg_hba.conf</summary>

```text
# TYPE  DATABASE        USER            ADDRESS                 METHOD
# "local" is for Unix domain socket connections only
local   all             all                                         peer
# IPv4 local connections:
host    all             all                 192.168.40.10/32        md5
host    replication     replicator          192.168.40.10/32        md5
host    replication     replicator          192.168.40.11/32        md5

```

</details>


<details><summary>см. postgresql.conf</summary>

```text
listen_addresses = '192.168.40.10,localhost'
max_connections = 100
shared_buffers = 128MB
dynamic_shared_memory_type = posix
wal_level = hot_standby # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
# hot_standby = on # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
synchronous_commit = local
max_wal_size = 1GB
min_wal_size = 80MB
archive_mode = on
max_wal_senders = 2
wal_keep_segments = 10
max_replication_slots = 10
synchronous_standby_names = 'standby'
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 0
log_line_prefix = '%m [%p] '
log_timezone = 'UTC'
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

```

</details>

### Настройка реплики

```shell
ansible-playbook playbooks/replica.yml --tags deploy > ../files/playbooks-replica.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica.yml`</summary>

```text

PLAY [Playbook of PostgreSQL replica] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica : Install EPEL Repo package from standart repo] *********
changed: [replica]

TASK [../roles/replica : Install PostgreSQL repo] ******************************
changed: [replica]

TASK [../roles/replica : Uninstall PostgreSQL] *********************************
ok: [replica]

TASK [../roles/replica : Remove PostgreSQL data dir] ***************************
ok: [replica]

TASK [../roles/replica : Install PostgreSQL] ***********************************
changed: [replica]

TASK [../roles/replica : Init PostgreSQL] **************************************
changed: [replica]

TASK [../roles/replica : Force clear PostgreSQL data dir] **********************
changed: [replica]

TASK [../roles/replica : Create PostgreSQL data] *******************************
changed: [replica]

TASK [../roles/replica : Install python-pip for pexpect promt answering] *******
changed: [replica]

TASK [../roles/replica : Pip install pexpect] **********************************
changed: [replica]

TASK [../roles/replica : Clear PostgreSQL data dir] ****************************
changed: [replica]

TASK [../roles/replica : Copy database from master to slave] *******************
changed: [replica]

TASK [../roles/replica : Collect pg.conf-files] ********************************
changed: [replica] => (item=recovery.conf)
changed: [replica] => (item=postgresql.conf)

RUNNING HANDLER [../roles/replica : restart-postgresql] ************************
changed: [replica]

PLAY RECAP *********************************************************************
replica                    : ok=15   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>


<details><summary>см. postgresql.conf</summary>

```text
listen_addresses = '192.168.40.11,localhost'
max_connections = 100
shared_buffers = 128MB
dynamic_shared_memory_type = posix
synchronous_commit = local
max_wal_size = 1GB
min_wal_size = 80MB
archive_mode = on
max_wal_senders = 2
wal_keep_segments = 10
max_replication_slots = 10
synchronous_standby_names = 'standby'
# wal_level = hot_standby # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
hot_standby = on # ВАЖНО В КОНТЕКСТЕ ЗАДАЧИ
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 0
log_line_prefix = '%m [%p] '
log_timezone = 'UTC'
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

```

</details>


<details><summary>см. recovery.conf</summary>

```text
standby_mode = on
primary_conninfo = 'host=192.168.40.10 port=5432 user=replicator password=replicator'
primary_slot_name = 'pg_slot_replication'
trigger_file = '/tmp/trigger.192.168.40.10.5432'
```

</details>

## Проверка работоспособности

### Что есть на реплике до какой-либо CRUD-"активности" на мастере

```shell
ansible-playbook playbooks/replica_check_before.yml > ../files/playbooks-replica_check_before.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica_check_before.yml`</summary>

```text

PLAY [Playbook of check replica before master activity] ************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica_check_before : PostgreSQL master checker] ***************
changed: [replica] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [replica] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [replica] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)

TASK [../roles/replica_check_before : Store check to file] *********************
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:38.649711', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-18 20:11:38.476141', 'stderr': '', 'delta': '0:00:00.173570', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:39.524054', 'stdout': '    schema_name     \n--------------------\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(6 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-18 20:11:39.367608', 'stderr': '', 'delta': '0:00:00.156446', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(6 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:40.320534', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(69 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-18 20:11:40.189656', 'stderr': '', 'delta': '0:00:00.130878', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(69 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
replica                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Полученные результаты:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(6 строк)
```

</details>

<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(69 строк)
```

</details>

### Что есть на мастере и совершаем CRUD-"действия"

```shell
ansible-playbook playbooks/master_check_and_activity.yml > ../files/playbooks-master_check_and_activity.yml.txt
```


<details><summary>см. лог выполнения `playbooks/master_check_and_activity.yml`</summary>

```text

PLAY [Playbook of check master] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [master]

TASK [../roles/master_check_and_activity : PostgreSQL master checker] **********
changed: [master] => (item=SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;)
changed: [master] => (item=SELECT * FROM pg_stat_replication;)
changed: [master] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [master] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [master] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)

TASK [../roles/master_check_and_activity : Store check to file] ****************
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:48.435402', 'stdout': ' application_name |   state   | sync_priority | sync_state \n------------------+-----------+---------------+------------\n walreceiver      | streaming |             0 | async\n(1 строка)', 'cmd': 'sudo -iu postgres psql -c "SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;"', 'rc': 0, 'start': '2021-10-18 20:11:48.054731', 'stderr': '', 'delta': '0:00:00.380671', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' application_name |   state   | sync_priority | sync_state ', '------------------+-----------+---------------+------------', ' walreceiver      | streaming |             0 | async', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;', 'ansible_loop_var': 'item'})
changed: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:49.274929', 'stdout': '  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn |    write_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state \n-------+----------+------------+------------------+---------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------------+-----------------+-----------------+---------------+------------\n 29591 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       36518 | 2021-10-18 20:11:34.034496+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  | 00:00:00.074319 | 00:00:00.074321 | 00:00:00.074326 |             0 | async\n(1 строка)', 'cmd': 'sudo -iu postgres psql -c "SELECT * FROM pg_stat_replication;"', 'rc': 0, 'start': '2021-10-18 20:11:49.136105', 'stderr': '', 'delta': '0:00:00.138824', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT * FROM pg_stat_replication;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn |    write_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state ', '-------+----------+------------+------------------+---------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------------+-----------------+-----------------+---------------+------------', ' 29591 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       36518 | 2021-10-18 20:11:34.034496+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  | 00:00:00.074319 | 00:00:00.074321 | 00:00:00.074326 |             0 | async', '(1 строка)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT * FROM pg_stat_replication;', 'ansible_loop_var': 'item'})
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:50.151123', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-18 20:11:49.950080', 'stderr': '', 'delta': '0:00:00.201043', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:50.868821', 'stdout': '    schema_name     \n--------------------\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(6 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-18 20:11:50.728438', 'stderr': '', 'delta': '0:00:00.140383', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(6 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:51.714962', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(69 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-18 20:11:51.583661', 'stderr': '', 'delta': '0:00:00.131301', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(69 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})

TASK [../roles/master_check_and_activity : PostgreSQL master activity] *********
changed: [master] => (item=DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;)
changed: [master] => (item=CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));)
changed: [master] => (item=INSERT INTO test_schema.test_table VALUES (1,'first'),(2,'second');)

TASK [../roles/master_check_and_activity : Store activity to file] *************
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:56.305663', 'stdout': 'CREATE SCHEMA', 'cmd': 'sudo -iu postgres psql -c "DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;"', 'rc': 0, 'start': '2021-10-18 20:11:56.174755', 'stderr': 'NOTICE:  schema "test_schema" does not exist, skipping', 'delta': '0:00:00.130908', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['CREATE SCHEMA'], 'stderr_lines': ['NOTICE:  schema "test_schema" does not exist, skipping'], 'failed': False, 'item': 'DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;', 'ansible_loop_var': 'item'})
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:57.188783', 'stdout': 'CREATE TABLE', 'cmd': 'sudo -iu postgres psql -c "CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));"', 'rc': 0, 'start': '2021-10-18 20:11:57.050231', 'stderr': '', 'delta': '0:00:00.138552', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['CREATE TABLE'], 'stderr_lines': [], 'failed': False, 'item': 'CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));', 'ansible_loop_var': 'item'})
ok: [master -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:11:57.950772', 'stdout': 'INSERT 0 2', 'cmd': 'sudo -iu postgres psql -c "INSERT INTO test_schema.test_table VALUES (1,\'first\'),(2,\'second\');"', 'rc': 0, 'start': '2021-10-18 20:11:57.780628', 'stderr': '', 'delta': '0:00:00.170144', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "INSERT INTO test_schema.test_table VALUES (1,\'first\'),(2,\'second\');"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['INSERT 0 2'], 'stderr_lines': [], 'failed': False, 'item': "INSERT INTO test_schema.test_table VALUES (1,'first'),(2,'second');", 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
master                     : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

#### ... что есть на мастере


<details><summary>см. результат `SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication`</summary>

```text
-- SELECT application_name, state, sync_priority, sync_state FROM pg_stat_replication;
 application_name |   state   | sync_priority | sync_state 
------------------+-----------+---------------+------------
 walreceiver      | streaming |             0 | async
(1 строка)
```

</details>

<details><summary>см. результат `SELECT * FROM pg_stat_replication`</summary>

```text
-- SELECT * FROM pg_stat_replication;
  pid  | usesysid |  usename   | application_name |  client_addr  | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn |    write_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state 
-------+----------+------------+------------------+---------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-----------------+-----------------+-----------------+---------------+------------
 29591 |    16384 | replicator | walreceiver      | 192.168.40.11 |                 |       36518 | 2021-10-18 20:11:34.034496+00 |              | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  | 00:00:00.074319 | 00:00:00.074321 | 00:00:00.074326 |             0 | async
(1 строка)
```

</details>

Полученные ниже результаты пригодятся для сравнения с изменениями на реплике после CRUD-"активности" на мастере:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(6 строк)
```

</details>

<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(69 строк)
```

</details>

#### ... совершаем CRUD-"действия" на мастере


<details><summary>см. лог выполнения `DROP SCHEMA IF EXISTS test_schema CASCADE ... CREATE SCHEMA test_schema`</summary>

```text
-- DROP SCHEMA IF EXISTS test_schema CASCADE; CREATE SCHEMA test_schema;
CREATE SCHEMA
```

</details>

<details><summary>см. лог выполнения `CREATE TABLE test_schema.test_table ...`</summary>

```text
-- CREATE TABLE test_schema.test_table(id serial primary key, value varchar(50));
CREATE TABLE
```

</details>

<details><summary>см. лог выполнения `INSERT INTO test_schema.test_table VALUES ...`</summary>

```text
-- INSERT INTO test_schema.test_table VALUES (1,'first'),(2,'second');
INSERT 0 2
```

</details>

### Что есть на реплике после CRUD-"активности" на мастере

```shell
ansible-playbook playbooks/replica_check_after.yml > ../files/playbooks-replica_check_after.yml.txt
```


<details><summary>см. лог выполнения `playbooks/replica_check_after.yml`</summary>

```text

PLAY [Playbook of check replica after master activity] *************************

TASK [Gathering Facts] *********************************************************
ok: [replica]

TASK [../roles/replica_check_after : PostgreSQL master checker] ****************
changed: [replica] => (item=SELECT datname AS database_name FROM pg_database;)
changed: [replica] => (item=SELECT schema_name FROM information_schema.schemata;)
changed: [replica] => (item=SELECT schemaname, tablename FROM pg_catalog.pg_tables;)
changed: [replica] => (item=SELECT * FROM test_schema.test_table;)

TASK [../roles/replica_check_after : Store check to file] **********************
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:12:05.985099', 'stdout': ' database_name \n---------------\n postgres\n template1\n template0\n(3 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'rc': 0, 'start': '2021-10-18 20:12:05.844163', 'stderr': '', 'delta': '0:00:00.140936', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT datname AS database_name FROM pg_database;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' database_name ', '---------------', ' postgres', ' template1', ' template0', '(3 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT datname AS database_name FROM pg_database;', 'ansible_loop_var': 'item'})
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:12:06.700549', 'stdout': '    schema_name     \n--------------------\n test_schema\n information_schema\n public\n pg_catalog\n pg_toast_temp_1\n pg_temp_1\n pg_toast\n(7 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'rc': 0, 'start': '2021-10-18 20:12:06.558260', 'stderr': '', 'delta': '0:00:00.142289', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schema_name FROM information_schema.schemata;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['    schema_name     ', '--------------------', ' test_schema', ' information_schema', ' public', ' pg_catalog', ' pg_toast_temp_1', ' pg_temp_1', ' pg_toast', '(7 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schema_name FROM information_schema.schemata;', 'ansible_loop_var': 'item'})
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:12:07.453570', 'stdout': '     schemaname     |        tablename        \n--------------------+-------------------------\n test_schema        | test_table\n pg_catalog         | pg_statistic\n pg_catalog         | pg_foreign_table\n pg_catalog         | pg_authid\n pg_catalog         | pg_user_mapping\n pg_catalog         | pg_subscription\n pg_catalog         | pg_largeobject\n pg_catalog         | pg_type\n pg_catalog         | pg_attribute\n pg_catalog         | pg_proc\n pg_catalog         | pg_class\n pg_catalog         | pg_attrdef\n pg_catalog         | pg_constraint\n pg_catalog         | pg_inherits\n pg_catalog         | pg_index\n pg_catalog         | pg_operator\n pg_catalog         | pg_opfamily\n pg_catalog         | pg_opclass\n pg_catalog         | pg_am\n pg_catalog         | pg_amop\n pg_catalog         | pg_amproc\n pg_catalog         | pg_language\n pg_catalog         | pg_largeobject_metadata\n pg_catalog         | pg_aggregate\n pg_catalog         | pg_statistic_ext\n pg_catalog         | pg_rewrite\n pg_catalog         | pg_trigger\n pg_catalog         | pg_event_trigger\n pg_catalog         | pg_description\n pg_catalog         | pg_cast\n pg_catalog         | pg_enum\n pg_catalog         | pg_namespace\n pg_catalog         | pg_conversion\n pg_catalog         | pg_depend\n pg_catalog         | pg_database\n pg_catalog         | pg_db_role_setting\n pg_catalog         | pg_tablespace\n pg_catalog         | pg_pltemplate\n pg_catalog         | pg_auth_members\n pg_catalog         | pg_shdepend\n pg_catalog         | pg_shdescription\n pg_catalog         | pg_ts_config\n pg_catalog         | pg_ts_config_map\n pg_catalog         | pg_ts_dict\n pg_catalog         | pg_ts_parser\n pg_catalog         | pg_ts_template\n pg_catalog         | pg_extension\n pg_catalog         | pg_foreign_data_wrapper\n pg_catalog         | pg_foreign_server\n pg_catalog         | pg_policy\n pg_catalog         | pg_replication_origin\n pg_catalog         | pg_default_acl\n pg_catalog         | pg_init_privs\n pg_catalog         | pg_seclabel\n pg_catalog         | pg_shseclabel\n pg_catalog         | pg_collation\n pg_catalog         | pg_partitioned_table\n pg_catalog         | pg_range\n pg_catalog         | pg_transform\n pg_catalog         | pg_sequence\n pg_catalog         | pg_publication\n pg_catalog         | pg_publication_rel\n pg_catalog         | pg_subscription_rel\n information_schema | sql_features\n information_schema | sql_implementation_info\n information_schema | sql_languages\n information_schema | sql_packages\n information_schema | sql_parts\n information_schema | sql_sizing\n information_schema | sql_sizing_profiles\n(70 строк)', 'cmd': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'rc': 0, 'start': '2021-10-18 20:12:07.297741', 'stderr': '', 'delta': '0:00:00.155829', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT schemaname, tablename FROM pg_catalog.pg_tables;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': ['     schemaname     |        tablename        ', '--------------------+-------------------------', ' test_schema        | test_table', ' pg_catalog         | pg_statistic', ' pg_catalog         | pg_foreign_table', ' pg_catalog         | pg_authid', ' pg_catalog         | pg_user_mapping', ' pg_catalog         | pg_subscription', ' pg_catalog         | pg_largeobject', ' pg_catalog         | pg_type', ' pg_catalog         | pg_attribute', ' pg_catalog         | pg_proc', ' pg_catalog         | pg_class', ' pg_catalog         | pg_attrdef', ' pg_catalog         | pg_constraint', ' pg_catalog         | pg_inherits', ' pg_catalog         | pg_index', ' pg_catalog         | pg_operator', ' pg_catalog         | pg_opfamily', ' pg_catalog         | pg_opclass', ' pg_catalog         | pg_am', ' pg_catalog         | pg_amop', ' pg_catalog         | pg_amproc', ' pg_catalog         | pg_language', ' pg_catalog         | pg_largeobject_metadata', ' pg_catalog         | pg_aggregate', ' pg_catalog         | pg_statistic_ext', ' pg_catalog         | pg_rewrite', ' pg_catalog         | pg_trigger', ' pg_catalog         | pg_event_trigger', ' pg_catalog         | pg_description', ' pg_catalog         | pg_cast', ' pg_catalog         | pg_enum', ' pg_catalog         | pg_namespace', ' pg_catalog         | pg_conversion', ' pg_catalog         | pg_depend', ' pg_catalog         | pg_database', ' pg_catalog         | pg_db_role_setting', ' pg_catalog         | pg_tablespace', ' pg_catalog         | pg_pltemplate', ' pg_catalog         | pg_auth_members', ' pg_catalog         | pg_shdepend', ' pg_catalog         | pg_shdescription', ' pg_catalog         | pg_ts_config', ' pg_catalog         | pg_ts_config_map', ' pg_catalog         | pg_ts_dict', ' pg_catalog         | pg_ts_parser', ' pg_catalog         | pg_ts_template', ' pg_catalog         | pg_extension', ' pg_catalog         | pg_foreign_data_wrapper', ' pg_catalog         | pg_foreign_server', ' pg_catalog         | pg_policy', ' pg_catalog         | pg_replication_origin', ' pg_catalog         | pg_default_acl', ' pg_catalog         | pg_init_privs', ' pg_catalog         | pg_seclabel', ' pg_catalog         | pg_shseclabel', ' pg_catalog         | pg_collation', ' pg_catalog         | pg_partitioned_table', ' pg_catalog         | pg_range', ' pg_catalog         | pg_transform', ' pg_catalog         | pg_sequence', ' pg_catalog         | pg_publication', ' pg_catalog         | pg_publication_rel', ' pg_catalog         | pg_subscription_rel', ' information_schema | sql_features', ' information_schema | sql_implementation_info', ' information_schema | sql_languages', ' information_schema | sql_packages', ' information_schema | sql_parts', ' information_schema | sql_sizing', ' information_schema | sql_sizing_profiles', '(70 строк)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT schemaname, tablename FROM pg_catalog.pg_tables;', 'ansible_loop_var': 'item'})
ok: [replica -> localhost] => (item={'changed': True, 'end': '2021-10-18 20:12:08.402707', 'stdout': ' id | value  \n----+--------\n  1 | first\n  2 | second\n(2 строки)', 'cmd': 'sudo -iu postgres psql -c "SELECT * FROM test_schema.test_table;"', 'rc': 0, 'start': '2021-10-18 20:12:08.230044', 'stderr': '', 'delta': '0:00:00.172663', 'invocation': {'module_args': {'creates': None, 'executable': None, '_uses_shell': True, 'strip_empty_ends': True, '_raw_params': 'sudo -iu postgres psql -c "SELECT * FROM test_schema.test_table;"', 'removes': None, 'argv': None, 'warn': False, 'chdir': None, 'stdin_add_newline': True, 'stdin': None}}, 'stdout_lines': [' id | value  ', '----+--------', '  1 | first', '  2 | second', '(2 строки)'], 'stderr_lines': [], 'failed': False, 'item': 'SELECT * FROM test_schema.test_table;', 'ansible_loop_var': 'item'})

PLAY RECAP *********************************************************************
replica                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

Базы данных неизменны, так как не создавалось новых:


<details><summary>см. результат `SELECT datname AS databases FROM pg_database`</summary>

```text
-- SELECT datname AS database_name FROM pg_database;
 database_name 
---------------
 postgres
 template1
 template0
(3 строки)
```

</details>

Появились сведения о созданной на мастере схеме `test_schema`:


<details><summary>см. результат `SELECT schema_name FROM information_schema.schemata`</summary>

```text
-- SELECT schema_name FROM information_schema.schemata;
    schema_name     
--------------------
 test_schema
 information_schema
 public
 pg_catalog
 pg_toast_temp_1
 pg_temp_1
 pg_toast
(7 строк)
```

</details>

Появились сведения о созданной на мастере таблице `test_table` схемы `test_schema`:


<details><summary>см. результат `SELECT schemaname, tablename FROM pg_catalog.pg_tables`</summary>

```text
-- SELECT schemaname, tablename FROM pg_catalog.pg_tables;
     schemaname     |        tablename        
--------------------+-------------------------
 test_schema        | test_table
 pg_catalog         | pg_statistic
 pg_catalog         | pg_foreign_table
 pg_catalog         | pg_authid
 pg_catalog         | pg_user_mapping
 pg_catalog         | pg_subscription
 pg_catalog         | pg_largeobject
 pg_catalog         | pg_type
 pg_catalog         | pg_attribute
 pg_catalog         | pg_proc
 pg_catalog         | pg_class
 pg_catalog         | pg_attrdef
 pg_catalog         | pg_constraint
 pg_catalog         | pg_inherits
 pg_catalog         | pg_index
 pg_catalog         | pg_operator
 pg_catalog         | pg_opfamily
 pg_catalog         | pg_opclass
 pg_catalog         | pg_am
 pg_catalog         | pg_amop
 pg_catalog         | pg_amproc
 pg_catalog         | pg_language
 pg_catalog         | pg_largeobject_metadata
 pg_catalog         | pg_aggregate
 pg_catalog         | pg_statistic_ext
 pg_catalog         | pg_rewrite
 pg_catalog         | pg_trigger
 pg_catalog         | pg_event_trigger
 pg_catalog         | pg_description
 pg_catalog         | pg_cast
 pg_catalog         | pg_enum
 pg_catalog         | pg_namespace
 pg_catalog         | pg_conversion
 pg_catalog         | pg_depend
 pg_catalog         | pg_database
 pg_catalog         | pg_db_role_setting
 pg_catalog         | pg_tablespace
 pg_catalog         | pg_pltemplate
 pg_catalog         | pg_auth_members
 pg_catalog         | pg_shdepend
 pg_catalog         | pg_shdescription
 pg_catalog         | pg_ts_config
 pg_catalog         | pg_ts_config_map
 pg_catalog         | pg_ts_dict
 pg_catalog         | pg_ts_parser
 pg_catalog         | pg_ts_template
 pg_catalog         | pg_extension
 pg_catalog         | pg_foreign_data_wrapper
 pg_catalog         | pg_foreign_server
 pg_catalog         | pg_policy
 pg_catalog         | pg_replication_origin
 pg_catalog         | pg_default_acl
 pg_catalog         | pg_init_privs
 pg_catalog         | pg_seclabel
 pg_catalog         | pg_shseclabel
 pg_catalog         | pg_collation
 pg_catalog         | pg_partitioned_table
 pg_catalog         | pg_range
 pg_catalog         | pg_transform
 pg_catalog         | pg_sequence
 pg_catalog         | pg_publication
 pg_catalog         | pg_publication_rel
 pg_catalog         | pg_subscription_rel
 information_schema | sql_features
 information_schema | sql_implementation_info
 information_schema | sql_languages
 information_schema | sql_packages
 information_schema | sql_parts
 information_schema | sql_sizing
 information_schema | sql_sizing_profiles
(70 строк)
```

</details>

Реплицированные данные от мастера с таблицы `test_table` схемы `test_schema`:


<details><summary>см. результат `SELECT * FROM test_schema.test_table.txt`</summary>

```text
-- SELECT * FROM test_schema.test_table;
 id | value  
----+--------
  1 | first
  2 | second
(2 строки)
```

</details>


## Шлак
```shell

cd ../../
cd ./040/vm/
vagrant destroy -f
vagrant up
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../../
cd ./040/ansible/
ansible-playbook playbooks/master.yml --tags deploy > ../files/playbooks-master.yml.txt
ansible-playbook playbooks/replica.yml --tags deploy > ../files/playbooks-replica.yml.txt
ansible-playbook playbooks/replica_check_before.yml > ../files/playbooks-replica_check_before.yml.txt
ansible-playbook playbooks/master_check_and_activity.yml > ../files/playbooks-master_check_and_activity.yml.txt
ansible-playbook playbooks/replica_check_after.yml > ../files/playbooks-replica_check_after.yml.txt
cd ../../
./details.py 040.details.md 0

```

```text

psql postgresql://192.168.40.10:5432/postgres?sslmode=require
psql -H 192.168.40.10:5432 -U postgres -W

# su - postgres
# psql template1
# CREATE USER replication WITH PASSWORD 'replication';
# GRANT ALL PRIVILEGES ON DATABASE "postgres" to replication;
# GRANT ALL PRIVILEGES ON DATABASE "postgres" to 'replication';
CREATE USER replication REPLICATION LOGIN CONNECTION LIMIT 5 ENCRYPTED PASSWORD 'ident';"

sudo -u postgres psql
CREATE DATABASE test;
CREATE USER test WITH ENCRYPTED PASSWORD 'test';
GRANT ALL PRIVILEGES ON DATABASE test TO test;
psql -h 192.168.40.10 -U test -d test 


CREATE USER replication REPLICATION LOGIN CONNECTION LIMIT 5 ENCRYPTED PASSWORD 'replication';"

ошибка: не удалось подключиться к серверу: Нет маршрута до узла
        Он действительно работает по адресу "192.168.40.10"
         и принимает TCP-соединения (порт 5432)?

netstat -nlp | grep 5432

systemctl stop postgresql-11
systemctl start postgresql-11
sudo service postgresql-11 restart

psql -h 192.168.40.10 -U replication -d replication -W
psql -h 192.168.40.10 -U test -d test -W

lsof -i | grep 'post'

Тогда вы можете узнать, какой порт слушает.
psql -U postgres -p "port_in_use"

ansible-playbook playbooks/master.yml   --tags collect-pg.conf-files
ansible-playbook playbooks/replica.yml  --tags collect-pg.conf-files
ansible-playbook playbooks/master.yml   --tags deploy
ansible-playbook playbooks/replica.yml  --tags install-epel-repo
ansible-playbook playbooks/replica.yml  --tags install-postgresql
ansible-playbook playbooks/replica.yml  --tags create-postgresql-data-dir
ansible-playbook playbooks/replica.yml  --tags install-python3-pip
ansible-playbook playbooks/replica.yml  --tags install-python3-pexpect
ansible-playbook playbooks/replica.yml  --tags copy-master-data
ansible-playbook playbooks/master.yml   --tags collect-pg.conf-files


SELECT datname FROM pg_database;
SELECT schema_name FROM information_schema.schemata;
SELECT schemaname, tablename FROM pg_catalog.pg_tables;
SELECT * FROM public.testtable;
\c test 

```

## Заместки

* pexpect==3.3 - очень важно именно такая версия, так как в репе 2.*
* generic/centos7 - плохой дистрибутив для реплицирования PostgreSQL, что-то с недоступностью по 5432

