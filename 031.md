#  VPN

Между двумя виртуалками поднять vpn в режимах
* tun;
* tap; 
* Прочуствовать разницу.

Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке

## Исполнение

Я добился того, что:
* стенд разворачивается автоматом с нужными конфигами, генерацией ключей (кроме их подписывания - об это ниже)
* имеется проверка на работоспособность:
  * статус `systemctl ...`
  * лог `/var/log/...`
  * интерфейс `tun0`

Текущая настройка идет в `tun`, считая что для связи между хоставми необходима маршрутизация, то есть сетефой уровень связности (L3).
В `tap` возможно объединить только при наличии канальной связности устройств (L2).

### Разворачивание сервера

```shell
cd 031/vm/
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
```

```shell
ansible-playbook playbooks/generate_vpn_server_certs.yml > ../files/generate_vpn_server_certs.yml.txt
```

Обратите внимание на итоговый вывод `playbooks/generate_vpn_server_certs.yml`.


<details><summary>см. лог `playbooks/generate_vpn_server_certs.yml`</summary>

```text

PLAY [Playbook of generate vpn-server certs] ***********************************

TASK [Gathering Facts] *********************************************************
ok: [server]

TASK [../roles/generate_vpn_server_certs : Install EPEL Repo package from standart repo] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : Install Wget] ***********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : EasyRSA deploy commands] ************
ok: [server] => {
    "msg": "rm -f /home/vagrant/common/temp/\nmkdir -p /home/vagrant/common/temp/\ntouch /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\nwget -O /home/vagrant/common/temp/EasyRSA-3.0.8.tgz https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz\ntar -C /home/vagrant/common/temp/ -xzvf /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\nmv /home/vagrant/common/temp/EasyRSA-3.0.8 /home/vagrant/common/temp/easyrsa\nrm -f /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\n"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA deploy] *********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : Copy "vars" file to guest] **********
ok: [server]

TASK [../roles/generate_vpn_server_certs : EasyRSA - Init PKI] *****************
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\n\n\nWARNING!!!\n\nYou are about to remove the EASYRSA_PKI at: /home/vagrant/common/temp/easyrsa/pki\nand initialize a fresh PKI here.\n\nType the word 'yes' to continue, or any other input to abort.\n  Confirm removal: \ninit-pki complete; you may now create a CA or requests.\nYour newly created PKI dir is: /home/vagrant/common/temp/easyrsa/pki"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - Build Auth Center CERT] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nEnter New CA Key Passphrase: \nRe-Enter New CA Key Passphrase: \n\nCA creation complete and you may now import and sign cert requests.\nYour new CA certificate file for publishing is at:\n//home/vagrant/common/temp/easyrsa/pki/ca.crt"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - DH] ***********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nDH parameters of size 2048 created at /home/vagrant/common/temp/easyrsa/pki/dh.pem"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - prepare Server side CERT] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nKeypair and certificate request completed. Your files are:\nreq: /home/vagrant/common/temp/easyrsa/pki/reqs/server.req\nkey: /home/vagrant/common/temp/easyrsa/pki/private/server.key"
}

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "!!! ALERT !!!\nSo, now you need run command 'cd /home/vagrant/common/temp/ && ./easyrsa/easyrsa sign-req server server' at guest terminal, for:\n* /home/vagrant/common/temp/easyrsa/pki/issued/server.req\n* /home/vagrant/common/temp/easyrsa/pki/issued/server.crt\n"
}

PLAY RECAP *********************************************************************
server                     : ok=15   changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

К сожалению, команда `sign-req` не автоматизируема, что связано с невозможностью осуществления автоматического ввода ответа на вопросы утилиты по факту ключевой фразы к корневому сертификату центра авторизации

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req server server # <--- вот тут вводим неавтоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_server.yml > ../files/configure_openvpn_server.yml.txt
```


<details><summary>см. лог `playbooks/configure_openvpn_server.yml`</summary>

```text

PLAY [Configure openvpn server] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [server]

TASK [../roles/configure_openvpn_server : Install EPEL Repo package from standart repo] ***
ok: [server]

TASK [../roles/configure_openvpn_server : Install Openvpn] *********************
changed: [server]

TASK [../roles/configure_openvpn_server : Copy "server.conf" file] *************
changed: [server]

TASK [../roles/configure_openvpn_server : Create openvpn directories] **********
changed: [server]

TASK [../roles/configure_openvpn_server : Generate tc.key] *********************
changed: [server]

TASK [../roles/configure_openvpn_server : Collect server keys dirs /etc/openvpn/keys/] ***
changed: [server] => (item=private)
changed: [server] => (item=issued)

TASK [../roles/configure_openvpn_server : Collect server keys /etc/openvpn/keys/] ***
changed: [server] => (item=ca.crt)
changed: [server] => (item=dh.pem)
changed: [server] => (item=issued/server.crt)
changed: [server] => (item=private/server.key)
changed: [server] => (item=tc.key)

RUNNING HANDLER [../roles/configure_openvpn_server : systemctl-restart-openvpn] ***
changed: [server]

PLAY RECAP *********************************************************************
server                     : ok=9    changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

### Демонстрация работоспособности сервера

```shell
ansible-playbook playbooks/check_openvpn_server.yml  > ../files/check_openvpn_server.yml.txt
```


<details><summary>см. лог `systemctl status openvpn@server.service`</summary>

```text
● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server
   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)
   Active: active (running) since Чт 2021-09-23 22:00:18 UTC; 9s ago
 Main PID: 30787 (openvpn)
   Status: "Initialization Sequence Completed"
   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service
           └─30787 /usr/sbin/openvpn --cd /etc/openvpn/ --config server.conf
```

</details>


<details><summary>см. лог `sudo cat /var/log/openvpn_openvpn.log`</summary>

```text
OpenVPN CLIENT LIST
Updated,Thu Sep 23 22:00:18 2021
Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since
ROUTING TABLE
Virtual Address,Common Name,Real Address,Last Ref
GLOBAL STATS
Max bcast/mcast queue length,0
END
```

</details>


<details><summary>см. лог `sudo cat /var/log/openvpn_openvpn-status.log`</summary>

```text
Thu Sep 23 22:00:18 2021 WARNING: file '/etc/openvpn/keys/private/server.key' is group or others accessible
Thu Sep 23 22:00:18 2021 WARNING: file '/etc/openvpn/keys/tc.key' is group or others accessible
Thu Sep 23 22:00:18 2021 OpenVPN 2.4.11 x86_64-redhat-linux-gnu [Fedora EPEL patched] [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 21 2021
Thu Sep 23 22:00:18 2021 library versions: OpenSSL 1.0.2k-fips  26 Jan 2017, LZO 2.06
Thu Sep 23 22:00:18 2021 Diffie-Hellman initialized with 2048 bit key
Thu Sep 23 22:00:18 2021 Outgoing Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Thu Sep 23 22:00:18 2021 Incoming Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Thu Sep 23 22:00:18 2021 ROUTE_GATEWAY 10.0.2.2/255.255.255.0 IFACE=eth0 HWADDR=52:54:00:4d:77:d3
Thu Sep 23 22:00:18 2021 TUN/TAP device tun0 opened
Thu Sep 23 22:00:18 2021 TUN/TAP TX queue length set to 100
Thu Sep 23 22:00:18 2021 /sbin/ip link set dev tun0 up mtu 1500
Thu Sep 23 22:00:18 2021 /sbin/ip addr add dev tun0 local 172.16.10.1 peer 172.16.10.2
Thu Sep 23 22:00:18 2021 /sbin/ip route add 172.16.10.0/24 via 172.16.10.2
Thu Sep 23 22:00:18 2021 Could not determine IPv4/IPv6 protocol. Using AF_INET
Thu Sep 23 22:00:18 2021 Socket Buffers: R=[212992->212992] S=[212992->212992]
Thu Sep 23 22:00:18 2021 UDPv4 link local (bound): [AF_INET]192.168.31.1:1194
Thu Sep 23 22:00:18 2021 UDPv4 link remote: [AF_UNSPEC]
Thu Sep 23 22:00:18 2021 GID set to nobody
Thu Sep 23 22:00:18 2021 UID set to nobody
Thu Sep 23 22:00:18 2021 MULTI: multi_init called, r=256 v=256
Thu Sep 23 22:00:18 2021 IFCONFIG POOL: base=172.16.10.4 size=62, ipv6=0
Thu Sep 23 22:00:18 2021 IFCONFIG POOL LIST
Thu Sep 23 22:00:18 2021 Initialization Sequence Completed
```

</details>

### Клиент

```shell
ansible-playbook playbooks/generate_vpn_client_certs.yml  > ../files/generate_vpn_client_certs.yml.txt
```

Опять, так как `sign-req` не автоматизируема:

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req client client # <--- вот тут вводим не автоматизируемые ответы
```

```shell
exit
cd ../ansible
ansible-playbook playbooks/configure_openvpn_client.yml > ../files/configure_openvpn_client.yml.txt
```


<details><summary>см. лог `playbooks/configure_openvpn_server.yml`</summary>

```text

PLAY [Configure openvpn client] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [client]

TASK [../roles/configure_openvpn_client : Install EPEL Repo package from standart repo] ***
changed: [client]

TASK [../roles/configure_openvpn_client : Install Openvpn] *********************
changed: [client]

TASK [../roles/configure_openvpn_client : Copy "client.conf" file] *************
changed: [client]

TASK [../roles/configure_openvpn_client : Collect client keys dirs /etc/openvpn/] ***
changed: [client] => (item=private)
changed: [client] => (item=issued)

TASK [../roles/configure_openvpn_client : Collect client keys /etc/openvpn/] ***
changed: [client] => (item=ca.crt)
changed: [client] => (item=tc.key)
changed: [client] => (item=private/client.key)
changed: [client] => (item=issued/client.crt)

RUNNING HANDLER [../roles/configure_openvpn_client : systemctl-restart-openvpn] ***
changed: [client]

PLAY RECAP *********************************************************************
client                     : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>


### Демонстрация работоспособности клиента

```shell
ansible-playbook playbooks/check_openvpn_client.yml  > ../files/check_openvpn_client.yml.txt
```


<details><summary>см. лог `ip add show tun0`</summary>

```text
4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
    link/none 
    inet 172.16.10.6 peer 172.16.10.5/32 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::bdb4:2c04:dfbf:3c27/64 scope link flags 800 
       valid_lft forever preferred_lft forever
```

</details>


<details><summary>см. лог `systemctl status openvpn@client.service.txt`</summary>

```text
● openvpn@client.service - OpenVPN Robust And Highly Flexible Tunneling Application On client
   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)
   Active: active (running) since Чт 2021-09-23 22:02:27 UTC; 6s ago
 Main PID: 29479 (openvpn)
   Status: "Initialization Sequence Completed"
   CGroup: /system.slice/system-openvpn.slice/openvpn@client.service
           └─29479 /usr/sbin/openvpn --cd /etc/openvpn/ --config client.conf
```

</details>

## RAS

```shell
ansible-playbook playbooks/ras.yml > ../files/playbooks_ras.yml.txt
```


<details><summary>см. лог `ansible-playbook playbooks/ras.yml`</summary>

```text

PLAY [RAS] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [server]

TASK [../roles/ras : Install EPEL Repo package from standart repo] *************
ok: [server]

TASK [../roles/ras : NGINX | Install NGINX package from EPEL Repo] *************
changed: [server]

TASK [../roles/ras : NGINX | Create RAS Nginx index page] **********************
changed: [server]

TASK [../roles/ras : Collect client keys for remote access (part 1)] ***********
changed: [server]

TASK [../roles/ras : Collect client keys for remote access (part 2)] ***********
changed: [server] => (item=ca.crt)
changed: [server] => (item=tc.key)
changed: [server] => (item=dh.pem)
changed: [server] => (item=private/client.key)
changed: [server] => (item=issued/client.crt)

RUNNING HANDLER [../roles/ras : start nginx] ***********************************
changed: [server]

RUNNING HANDLER [../roles/ras : restart nginx] *********************************
changed: [server]

PLAY RECAP *********************************************************************
server                     : ok=8    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>


Проверка локальной работы не смотрящего во внешний мир веб-сервера
```shell
cd ../vm
vagrant ssh server
[vagrant@server ~]$ curl 127.0.0.1:80
Hello from RAS :)
[vagrant@server ~]$ exit
```

## Шлак RAS

Ключи для клиента RAS
```shell
ls -l guest/temp/ras_client/*
  -rw-r--r-- 1 b b 1172 сен 23 22:19 guest/temp/ras_client/ca.crt
  -rw-r--r-- 1 b b  636 сен 23 22:22 guest/temp/ras_client/tc.key
  guest/temp/ras_client/issued:
  итого 8
  -rw-r--r-- 1 b b 4425 сен 23 22:23 client.crt
  guest/temp/ras_client/private:
  итого 4
  -rw-r--r-- 1 b b 1704 сен 23 22:22 client.key
```


```shell
cd ../vm
vagrant ssh server
sudo su
echo 'net.ipv4.conf.all.forwarding=1'  > /etc/sysctl.conf
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
sysctl -p /etc/sysctl.conf
systemctl restart network.service

iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X


iptables -A INPUT -i eth1 -p udp --dport 1194 -j ACCEPT
iptables -A INPUT -i tun+ -j ACCEPT
iptables -A OUTPUT -o tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -t nat -A POSTROUTING -s 172.16.10.0/24 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

iptables -A FORWARD -i tun0 -o eth1 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth1 -o tun0 -m state --state ESTABLISHED,RELATED -j ACCEPT

iptables -A INPUT -i eth1 -p udp --dport 1194 -j ACCEPT
iptables -A FORWARD -p udp --j ACCEPT 

iptables -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT


iptables -t nat -A POSTROUTING -s 192.168.31.0/24 -j MASQUERADE

echo '' > /etc/openvpn/client/ras_client.conf
nano /etc/openvpn/client/ras_client.conf

remote 127.0.0.1 1194
client
resolv-retry infinite
nobind
proto udp
dev tun0
comp-lzo
ca client/ca.crt
cert client/issued/client.crt
key client/private/client.key
tls-client
tls-auth client/tc.key 1
float
keepalive 10 120
persist-key
persist-tun
verb 3



remote 127.0.0.1 1194
tls-client
remote-cert-tls server
nobind
proto udp
dev tun0
pull
resolv-retry infinite
comp-lzo
ca client/ca.crt
cert client/issued/client.crt
key client/private/client.key
persist-tun
persist-key
verb 3
route-method exe
route-delay 2



cp -r /home/b/pycharm_projects_2021_2/otus_linux/031/vm/guest/temp/ras_client/* /etc/openvpn/client/



cd /etc/openvpn
sudo openvpn --config /etc/openvpn/client/ras_client.conf

sudo nmap -sU 127.0.0.01 -p 1194
Starting Nmap 7.70 ( https://nmap.org ) at 2021-09-24 01:07 MSK
Nmap scan report for localhost (127.0.0.1)
Host is up.

PORT     STATE         SERVICE
1194/udp open|filtered openvpn

ip route replace 172.16.10.0/24 dev eth1
systemctl stop firewalld
systemctl disable firewalld

setenforce 0
```