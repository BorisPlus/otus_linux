#  VPN

Между двумя виртуалками поднять vpn в режимах
* tun;
* tap; 
* Прочуствовать разницу.

Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке

## Исполнение

### Разворачивание сервера

```shell
cd 031/vm/
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
```

```shell
ansible-playbook playbooks/generate_vpn_server_certs.yml > ../files/generate_vpn_server_certs.yml.txt
```
Обрпте на итоговый вывод

<details><summary>см. лог `playbooks/generate_vpn_server_certs.yml`</summary>

```text

PLAY [Playbook of generate vpn-server certs] ***********************************

TASK [Gathering Facts] *********************************************************
ok: [server]

TASK [../roles/generate_vpn_server_certs : Install EPEL Repo package from standart repo] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : Install Wget] ***********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : EasyRSA deploy commands] ************
ok: [server] => {
    "msg": "rm -f /home/vagrant/common/temp/\nmkdir -p /home/vagrant/common/temp/\ntouch /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\nwget -O /home/vagrant/common/temp/EasyRSA-3.0.8.tgz https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz\ntar -C /home/vagrant/common/temp/ -xzvf /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\nmv /home/vagrant/common/temp/EasyRSA-3.0.8 /home/vagrant/common/temp/easyrsa\nrm -f /home/vagrant/common/temp/EasyRSA-3.0.8.tgz\n"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA deploy] *********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : Copy "vars" file to guest] **********
changed: [server]

TASK [../roles/generate_vpn_server_certs : EasyRSA - Init PKI] *****************
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\n\ninit-pki complete; you may now create a CA or requests.\nYour newly created PKI dir is: /home/vagrant/common/temp/easyrsa/pki"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - Build Auth Center CERT] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nEnter New CA Key Passphrase: \nRe-Enter New CA Key Passphrase: \n\nCA creation complete and you may now import and sign cert requests.\nYour new CA certificate file for publishing is at:\n//home/vagrant/common/temp/easyrsa/pki/ca.crt"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - DH] ***********************
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nDH parameters of size 2048 created at /home/vagrant/common/temp/easyrsa/pki/dh.pem"
}

TASK [../roles/generate_vpn_server_certs : EasyRSA - prepare Server side CERT] ***
changed: [server]

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "\nNote: using Easy-RSA configuration from: /home/vagrant/common/temp/easyrsa/vars\nUsing SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017\n\nKeypair and certificate request completed. Your files are:\nreq: /home/vagrant/common/temp/easyrsa/pki/reqs/server.req\nkey: /home/vagrant/common/temp/easyrsa/pki/private/server.key"
}

TASK [../roles/generate_vpn_server_certs : debuggins] **************************
ok: [server] => {
    "msg": "!!! ALERT !!!\nSo, now you need run command 'cd /home/vagrant/common/temp/ && ./easyrsa/easyrsa sign-req server server' at guest terminal, for:\n* /home/vagrant/common/temp/easyrsa/pki/issued/server.req\n* /home/vagrant/common/temp/easyrsa/pki/issued/server.crt\n"
}

PLAY RECAP *********************************************************************
server                     : ok=15   changed=8    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

К сожалению, команда `sign-req` не автоматизируема, что связано с невозможностью осуществления автоматического ввода ответа на вопросы утилиты по факту ключевой фразы к корневому серитифкату центра авторизазации
```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req server server # <--- вот тут вводим не автоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_server.yml > ../files/configure_openvpn_server.yml.txt
```


<details><summary>см. лог `playbooks/configure_openvpn_server.yml`</summary>

```text

PLAY [Configure openvpn server] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [server]

TASK [../roles/configure_openvpn_server : Install EPEL Repo package from standart repo] ***
ok: [server]

TASK [../roles/configure_openvpn_server : Install Openvpn] *********************
changed: [server]

TASK [../roles/configure_openvpn_server : Copy "server.conf" file] *************
changed: [server]

TASK [../roles/configure_openvpn_server : Create openvpn directories] **********
changed: [server]

TASK [../roles/configure_openvpn_server : Generate tc.key] *********************
changed: [server]

TASK [../roles/configure_openvpn_server : Collect server keys dirs /etc/openvpn/keys/] ***
changed: [server] => (item=private)
changed: [server] => (item=issued)

TASK [../roles/configure_openvpn_server : Collect server keys /etc/openvpn/keys/] ***
changed: [server] => (item=ca.crt)
changed: [server] => (item=dh.pem)
changed: [server] => (item=issued/server.crt)
changed: [server] => (item=private/server.key)
changed: [server] => (item=tc.key)

RUNNING HANDLER [../roles/configure_openvpn_server : systemctl-restart-openvpn] ***
changed: [server]

PLAY RECAP *********************************************************************
server                     : ok=9    changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>

### Демонстрация работоспособности сервера

```shell
ansible-playbook playbooks/check_openvpn_server.yml  > ../files/check_openvpn_server.yml.txt
```


<details><summary>см. лог `systemctl status openvpn@server.service`</summary>

```text
● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server
   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; disabled; vendor preset: disabled)
   Active: active (running) since Сб 2021-09-18 20:30:45 UTC; 40min ago
 Main PID: 5599 (openvpn)
   Status: "Initialization Sequence Completed"
   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service
           └─5599 /usr/sbin/openvpn --cd /etc/openvpn/ --config server.conf
```

</details>


<details><summary>см. лог `sudo cat /var/log/openvpn_openvpn.log`</summary>

```text
OpenVPN CLIENT LIST
Updated,Sat Sep 18 21:10:07 2021
Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since
yes,192.168.31.2:39284,8680,8352,Sat Sep 18 20:48:20 2021
ROUTING TABLE
Virtual Address,Common Name,Real Address,Last Ref
172.16.10.6,yes,192.168.31.2:39284,Sat Sep 18 20:48:20 2021
GLOBAL STATS
Max bcast/mcast queue length,0
END
```

</details>


<details><summary>см. лог `sudo cat /var/log/openvpn_openvpn-status.log`</summary>

```text
Sat Sep 18 20:30:45 2021 WARNING: file '/etc/openvpn/keys/private/server.key' is group or others accessible
Sat Sep 18 20:30:45 2021 WARNING: file '/etc/openvpn/keys/tc.key' is group or others accessible
Sat Sep 18 20:30:45 2021 OpenVPN 2.4.11 x86_64-redhat-linux-gnu [Fedora EPEL patched] [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 21 2021
Sat Sep 18 20:30:45 2021 library versions: OpenSSL 1.0.2k-fips  26 Jan 2017, LZO 2.06
Sat Sep 18 20:30:45 2021 Diffie-Hellman initialized with 2048 bit key
Sat Sep 18 20:30:45 2021 Outgoing Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Sat Sep 18 20:30:45 2021 Incoming Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Sat Sep 18 20:30:45 2021 ROUTE_GATEWAY 10.0.2.2/255.255.255.0 IFACE=eth0 HWADDR=52:54:00:4d:77:d3
Sat Sep 18 20:30:45 2021 TUN/TAP device tun0 opened
Sat Sep 18 20:30:45 2021 TUN/TAP TX queue length set to 100
Sat Sep 18 20:30:45 2021 /sbin/ip link set dev tun0 up mtu 1500
Sat Sep 18 20:30:45 2021 /sbin/ip addr add dev tun0 local 172.16.10.1 peer 172.16.10.2
Sat Sep 18 20:30:45 2021 /sbin/ip route add 172.16.10.0/24 via 172.16.10.2
Sat Sep 18 20:30:45 2021 Could not determine IPv4/IPv6 protocol. Using AF_INET
Sat Sep 18 20:30:45 2021 Socket Buffers: R=[212992->212992] S=[212992->212992]
Sat Sep 18 20:30:45 2021 UDPv4 link local (bound): [AF_INET]192.168.31.1:1194
Sat Sep 18 20:30:45 2021 UDPv4 link remote: [AF_UNSPEC]
Sat Sep 18 20:30:45 2021 GID set to nobody
Sat Sep 18 20:30:45 2021 UID set to nobody
Sat Sep 18 20:30:45 2021 MULTI: multi_init called, r=256 v=256
Sat Sep 18 20:30:45 2021 IFCONFIG POOL: base=172.16.10.4 size=62, ipv6=0
Sat Sep 18 20:30:45 2021 IFCONFIG POOL LIST
Sat Sep 18 20:30:45 2021 Initialization Sequence Completed
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 TLS: Initial packet from [AF_INET]192.168.31.2:39284, sid=f4d1c784 9c516433
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 VERIFY OK: depth=1, CN=Easy-RSA CA
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 VERIFY OK: depth=0, CN=yes
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_VER=2.4.11
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_PLAT=linux
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_PROTO=2
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_NCP=2
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_CIPHERS=AES-256-GCM:AES-128-GCM:BF-CBC
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_LZ4=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_LZ4v2=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_LZO=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_COMP_STUB=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_COMP_STUBv2=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 peer info: IV_TCPNL=1
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 Control Channel: TLSv1.2, cipher TLSv1/SSLv3 ECDHE-RSA-AES256-GCM-SHA384, 2048 bit RSA
Sat Sep 18 20:48:20 2021 192.168.31.2:39284 [yes] Peer Connection Initiated with [AF_INET]192.168.31.2:39284
Sat Sep 18 20:48:20 2021 yes/192.168.31.2:39284 MULTI_sva: pool returned IPv4=172.16.10.6, IPv6=(Not enabled)
Sat Sep 18 20:48:20 2021 yes/192.168.31.2:39284 MULTI: Learn: 172.16.10.6 -> yes/192.168.31.2:39284
Sat Sep 18 20:48:20 2021 yes/192.168.31.2:39284 MULTI: primary virtual IP for yes/192.168.31.2:39284: 172.16.10.6
Sat Sep 18 20:48:21 2021 yes/192.168.31.2:39284 PUSH: Received control message: 'PUSH_REQUEST'
Sat Sep 18 20:48:21 2021 yes/192.168.31.2:39284 SENT CONTROL [yes]: 'PUSH_REPLY,route 172.16.10.0 255.255.255.0,topology net30,ping 10,ping-restart 120,ifconfig 172.16.10.6 172.16.10.5,peer-id 0,cipher AES-256-GCM' (status=1)
Sat Sep 18 20:48:21 2021 yes/192.168.31.2:39284 Data Channel: using negotiated cipher 'AES-256-GCM'
Sat Sep 18 20:48:21 2021 yes/192.168.31.2:39284 Outgoing Data Channel: Cipher 'AES-256-GCM' initialized with 256 bit key
Sat Sep 18 20:48:21 2021 yes/192.168.31.2:39284 Incoming Data Channel: Cipher 'AES-256-GCM' initialized with 256 bit key
```

</details>

### Клиент

```shell
ansible-playbook playbooks/generate_vpn_client_certs.yml  > ../files/generate_vpn_client_certs.yml.txt
```

Так как `sign-req` не автоматизируема:

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req client client # <--- вот тут вводим не автоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_client.yml > ../files/configure_openvpn_client.yml.txt
```


<details><summary>см. лог `playbooks/configure_openvpn_server.yml`</summary>

```text

PLAY [Configure openvpn client] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [client]

TASK [../roles/configure_openvpn_client : Install EPEL Repo package from standart repo] ***
ok: [client]

TASK [../roles/configure_openvpn_client : Install Openvpn] *********************
ok: [client]

TASK [../roles/configure_openvpn_client : Copy "client.conf" file] *************
ok: [client]

TASK [../roles/configure_openvpn_client : Collect client keys dirs /etc/openvpn/] ***
changed: [client] => (item=private)
changed: [client] => (item=issued)

TASK [../roles/configure_openvpn_client : Collect client keys /etc/openvpn/] ***
ok: [client] => (item=ca.crt)
ok: [client] => (item=tc.key)
ok: [client] => (item=private/client.key)
ok: [client] => (item=issued/client.crt)

PLAY RECAP *********************************************************************
client                     : ok=6    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


```

</details>


### Демонстрация работоспособности клиента

```shell
ansible-playbook playbooks/check_openvpn_client.yml  > ../files/check_openvpn_client.yml.txt
```


<details><summary>см. лог `ip add show tun0`</summary>

```text
4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
    link/none 
    inet 172.16.10.6 peer 172.16.10.5/32 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::f465:f426:9424:c9c/64 scope link flags 800 
       valid_lft forever preferred_lft forever
```

</details>


<details><summary>см. лог `systemctl status openvpn@client.service.txt`</summary>

```text
● openvpn@client.service - OpenVPN Robust And Highly Flexible Tunneling Application On client
   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; disabled; vendor preset: disabled)
   Active: active (running) since Сб 2021-09-18 20:48:20 UTC; 23min ago
 Main PID: 9334 (openvpn)
   Status: "Initialization Sequence Completed"
   CGroup: /system.slice/system-openvpn.slice/openvpn@client.service
           └─9334 /usr/sbin/openvpn --cd /etc/openvpn/ --config client.conf
```

</details>
