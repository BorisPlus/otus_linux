Настраиваем центральный сервер для сбора логов

    в вагранте поднимаем 2 машины web и log
    на web поднимаем nginx
    на log настраиваем центральный лог сервер на любой системе на выбор

    journald;
    rsyslog;
    elk.

    настраиваем аудит, следящий за изменением конфигов нжинкса

Все критичные логи с web должны собираться и локально и удаленно. 
Все логи с nginx должны уходить на удаленный сервер (локально только критичные). 
Логи аудита должны также уходить на удаленную систему.

Формат сдачи ДЗ - vagrant + ansible

    развернуть еще машину elk

    таким образом настроить 2 центральных лог системы elk и какую либо еще;
    в elk должны уходить только логи нжинкса;
    во вторую систему все остальное.

Критерии оценки:

Статус "Принято" ставится, если присылаете логи скриншоты без вагранта.

Задание со звездочкой выполняется по желанию.

##

https://www.rsyslog.com/doc/v8-stable/configuration/filters.html
https://habr.com/ru/post/321262/
https://www.rsyslog.com/doc/v8-stable/configuration/properties.html
https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#using-role-dependencies
https://www.k-max.name/linux/rsyslog-na-debian-nastrojka-servera/

##  Ansible

```shell
$ pwd
    /**/otus_linux/023
$ cd vm/
$ vagrant up
$ vagrant status
    Current machine states:
    
    hw023web                  running (virtualbox)
    hw023log                  running (virtualbox)
    
    This environment represents multiple VMs. The VMs are all listed
    above with their current state. For more information about a specific
    VM, run `vagrant status NAME`.


$ vagrant ssh-config hw023web
    
    Host hw023web
      HostName 127.0.0.1
      User vagrant
      Port 2222
      UserKnownHostsFile /dev/null
      StrictHostKeyChecking no
      PasswordAuthentication no
      IdentityFile **/otus_linux/023/vm/.vagrant/machines/hw023web/virtualbox/private_key
      IdentitiesOnly yes
      LogLevel FATAL

$ vagrant ssh-config hw023log
    Host hw023log
      HostName 127.0.0.1
      User vagrant
      Port 2200
      UserKnownHostsFile /dev/null
      StrictHostKeyChecking no
      PasswordAuthentication no
      IdentityFile **/otus_linux/023/vm/.vagrant/machines/hw023log/virtualbox/private_key
      IdentitiesOnly yes
      LogLevel FATAL

$ cd ../ansible/

$ cat ./inventories/hosts 
    [hw023web]
    nginx ansible_host=127.0.0.1 ansible_port=2222 ansible_private_key_file=../vm/.vagrant/machines/hw023web/virtualbox/private_key
    [hw023log]
    vagrant ansible_host=127.0.0.1 ansible_port=2200 ansible_private_key_file=../vm/.vagrant/machines/hw023log/virtualbox/private_key

$ ansible hw023web -m command -a "uname -r"
    vagrant | CHANGED | rc=0 >>
    3.10.0-1127.el7.x86_64
    
$ ansible hw023web -m command -a "hostname"
    vagrant | CHANGED | rc=0 >>
    hw023log

$ ansible-playbook playbooks/init-client.yml --list-tags
  playbook: playbooks/init-client.yml
  play #1 (hw023web): Playbook of client initialization TAGS: []
      TASK TAGS: [add-epel-repo, configure-file-change-audit, configure-nginx, configure-rsyslog-for-critical-only, configure-rsyslog-for-nginx, install-nginx]

$ ansible-playbook playbooks/init-client.yml --tags configure-rsyslog-for-critical-level-and-higher
$ ansible-playbook playbooks/init-client.yml --tags add-epel-repo
$ ansible-playbook playbooks/init-client.yml --tags install-nginx
$ ansible-playbook playbooks/init-client.yml --tags configure-nginx
$ ansible-playbook playbooks/init-client.yml --tags configure-rsyslog-for-nginx
$ ansible-playbook playbooks/init-client.yml --tags configure-file-change-audit

$ ansible-playbook playbooks/init-server.yml --list-tags
  playbook: playbooks/init-server.yml
  play #1 (hw023log): Playbook of server initialization TAGS: []
      TASK TAGS: [configure-rsyslog-logs-accept, enable-rsyslog-formatting, enable-rsyslog-tcp]

$ ansible-playbook playbooks/init-server.yml --tags enable-rsyslog-tcp
$ ansible-playbook playbooks/init-server.yml --tags enable-rsyslog-formatting
$ ansible-playbook playbooks/init-server.yml --tags configure-rsyslog-logs-accept


$ ansible-playbook playbooks/deploy.yml
    PLAY [Playbook of application deploy] *************************************************************************************************************************************************************
    TASK [Gathering Facts] ****************************************************************************************************************************************************************************
    ok: [vagrant]
    TASK [../roles/deploy : NGINX | Install NGINX package from EPEL Repo] *****************************************************************************************************************************
    changed: [vagrant]
    TASK [../roles/deploy : NGINX | Create NGINX config file from template] ***************************************************************************************************************************
    changed: [vagrant]
    RUNNING HANDLER [../roles/deploy : restart nginx] *************************************************************************************************************************************************
    changed: [vagrant]
    RUNNING HANDLER [../roles/deploy : reload nginx] **************************************************************************************************************************************************
    changed: [vagrant]
    PLAY RECAP ****************************************************************************************************************************************************************************************
    vagrant                    : ok=5    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  

curl -I http://192.168.23.80:8080

    HTTP/1.1 200 OK
    Server: nginx/1.20.1
    Date: Thu, 22 Jul 2021 19:10:56 GMT
    Content-Type: text/html
    Content-Length: 4833
    Last-Modified: Fri, 16 May 2014 15:12:48 GMT
    Connection: keep-alive
    ETag: "53762af0-12e1"
    Accept-Ranges: bytes


```