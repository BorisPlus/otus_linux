# Сбор и анализ логов

__Домашнее задание__:
Настраиваем центральный сервер для сбора логов:
- в вагранте поднимаем 2 машины `web` и `log`
- на `web` поднимаем `nginx`
- на `log` настраиваем центральный лог сервер на любой системе на выбор:
 * journald;
 * rsyslog;
 * elk.
- настраиваем аудит, следящий за изменением конфигов `nginx` 

Пояснение:
- все критичные логи с `web` должны собираться и локально и удаленно. 
- все логи с `nginx` должны уходить на удаленный сервер (локально только критичные). 
- логи аудита должны также уходить на удаленную систему.

Формат сдачи ДЗ - vagrant + ansible

Задание со звездочкой:
- развернуть еще машину elk
- таким образом настроить 2 центральных лог системы elk и какую либо еще;
- в elk должны уходить только логи нжинкса;
- во вторую систему все остальное.

__Критерии оценки__:
Статус "Принято" ставится, если присылаете логи скриншоты без вагранта.

## Мои примечания

### Настраиваем аудит, следящий за изменением конфигов `nginx`

При решении задачи первоначально реализовал фиксирование факта изменения файла '/etc/nginx/nginx.conf'. Реализованный сервис 

[template]:[пример аудита №1](./023/ansible/roles/client/templates/audit.just_for_example/file_change_audit.service)

по циклу мониторит контрольную сумму этого файла и при ее изменении вносит соответствующую запись в свой лог файл. Скрипт проверки - универсальный, 

[template]:[скрипт проверки](./023/ansible/roles/client/templates/audit.just_for_example/file_change_audit.sh)

ему в качестве параметра может быть передан любой файл. 

Однако, возможно поднять локальный Git-репозиторий непосредственно в директории '/etc/nginx/', делать периодические коммиты (по расписанию), фиксируя "разницу" между текущим состоянием файлов и их образцами тут же в репозитории. Данный Git-подход лучше, так как:
- осуществляет аудит не отдельного файла '/etc/nginx/nginx.conf', а всех так или иначе конфигурационных.
- сообщения об отличиях (`git diff`) имеют более информативный вид: "старая версия > новая версия", чем констотация лишь факта изменения; 
- работает по расписанию и не грузит "лишними" обращениями диск.

Этот вариант в итоге реализоваy в ДЗ. Как и в примере выше скрипт универсальный и теоретически может быть применен в отношении любой директории, имеющей Git-репозиторий.
 
[template]:[path_contents_change_audit.sh](./023/ansible/roles/client/templates/audit/etc_rsyslog.d/path_contents_change_audit_log.conf.j2)

[template]:[path_contents_change_audit.env](./023/ansible/roles/client/templates/audit/systemd/nginx-conf-path-contents-change-audit.env)

[template]:[nginx_conf_path_contents_change_audit.service](./023/ansible/roles/client/templates/audit/systemd/nginx-conf-path-contents-change-audit.service)

[template]:[nginx_conf_path_contents_change_audit.timer](.023/ansible/roles/client/templates/audit/systemd/nginx-conf-path-contents-change-audit.timer)


Вместе с тем, ни первый, ни второй подходы не решают проблемы "возможного" появления промежуточной версии __нерабочей__ конфигурации, которая не будет учтена аудитом, так как аудит не успеет ее зафиксировать. 

_Вопрос_: возможно ли на файл\директорию "повесить" триггер, чтоб гарантированно все обращения пользователей к нему\ей ловить?

### центральный лог сервер на любой системе на выбор

Решил выбрать `rsyslog`:
- https://www.rsyslog.com/doc/v8-stable/configuration/filters.html
- https://www.rsyslog.com/doc/v8-stable/configuration/properties.html
- https://www.k-max.name/linux/rsyslog-na-debian-nastrojka-servera/
- https://habr.com/ru/post/321262/

Однако для этого пункта в последующем попробую `ELK`, но в связке 'LogStash -> MongoDb'. Мне не очень понятно задействование "тяжеловесного" `ElasticSearch` для хранения логов, пусть и имеющего из коробки восхитительный механизм полнотекстового поиска. Часто ли вы задействуете именно полнотекстовый поиск при поиске по логу или вам достаточно базовых операций поиска по тексту?

## Исполнение

### Vagrant + Ansible

Поднимаем "чистые" `Vagrant` виртуалки, смотрим параметры, прописываем в `Ansible`, разворачиваем инфраструктуру в `Vagrant` исключительно через `Ansible`.

#### Vagrant: "чистые" `web` и `log`

__Подзадача:__
- в вагранте поднимаем 2 машины `web` и `log`

__Решение:__
- [template]:[Vagrantfile "чистых" виртуалок](./023/vm/Vagrantfile)

```shell
$ pwd
 /**/otus_linux/023
$ cd vm/
$ vagrant up
 ...
$ vagrant status
    
    Current machine states:
    hw023web running (virtualbox)
    hw023log running (virtualbox)
    This environment represents multiple VMs. The VMs are all listed
    above with their current state. For more information about a specific
    VM, run `vagrant status NAME`.

$ vagrant ssh-config hw023web
    
    Host hw023web
    HostName 127.0.0.1
    User vagrant
    Port 2222
    UserKnownHostsFile /dev/null
    StrictHostKeyChecking no
    PasswordAuthentication no
    IdentityFile **/otus_linux/023/vm/.vagrant/machines/hw023web/virtualbox/private_key
    IdentitiesOnly yes
    LogLevel FATAL

$ vagrant ssh-config hw023log
    
    Host hw023log
    HostName 127.0.0.1
    User vagrant
    Port 2200
    UserKnownHostsFile /dev/null
    StrictHostKeyChecking no
    PasswordAuthentication no
    IdentityFile **/otus_linux/023/vm/.vagrant/machines/hw023log/virtualbox/private_key
    IdentitiesOnly yes
    LogLevel FATAL
```

#### Ansible

```shell
$ pwd
    /**/otus_linux/023/vm
  
$ cd ../ansible/

$ ansible hw023web -m command -a "uname -r"
    vagrant | CHANGED | rc=0 >>
    3.10.0-1127.el7.x86_64
 
$ ansible hw023log -m command -a "uname -r"
    vagrant | CHANGED | rc=0 >>
    3.10.0-1127.el7.x86_64
 
$ ansible hw023web -m command -a "hostname"
    vagrant | CHANGED | rc=0 >>
    hw023web
 
$ ansible hw023log -m command -a "hostname"
    vagrant | CHANGED | rc=0 >>
    hw023log
 
$ cat ./inventories/hosts 

    [hw023web]
    nginx ansible_host=127.0.0.1 ansible_port=2222 ansible_private_key_file=../vm/.vagrant/machines/hw023web/virtualbox/private_key
    [hw023log]
    vagrant ansible_host=127.0.0.1 ansible_port=2200 ansible_private_key_file=../vm/.vagrant/machines/hw023log/virtualbox/private_key

$ ansible-playbook playbooks/client.yml --list-tags

    playbook: playbooks/client.yml
    play #1 (hw023web): Playbook of client initialization TAGS: []
    TASK TAGS: [  <-- вывод отформатирован исключительно для удобства восприятияреализованного
        
        configure-rsyslog-for-critical-severity-only,
                 
        nginx-deploy,
            add-epel-repository, 
            install-nginx,
            configure-nginx, 
            
        git-deploy,
            install-git-repository, <-- стандартно очень старая версия 1.8.3.1, 
                                        мне же необходима git version >= 2.20
            install-git,
            init-git-on-nginx-config, 
            
        audit-deploy,
            configure-path-contents-change-audit-environment, 
            configure-path-contents-change-audit-shell, 
            configure-path-contents-change-audit-shell-x, 
            configure-path-contents-change-audit-service, 
            configure-path-contents-change-audit-timer, 
            configure-path-contents-change-audit-timer-on, 
    ]
```

__Подзадача:__
- все критичные логи с (машины) `web` должны собираться и локально и удаленно. 

__Решение:__
- если коротко, это реализует `*.=crit @@192.168.23.90:514`:

```shell
$ ansible-playbook playbooks/client.yml --tags configure-rsyslog-for-critical-only

   PLAY [Playbook of client initialization] 
   TASK [Gathering Facts] 
   ok: [nginx]
   TASK [../roles/client : Rsyslog | Configure facility with security levels of critical only] 
   changed: [nginx]
   RUNNING HANDLER [../roles/client : restart rsyslog] 
   changed: [nginx]
   PLAY RECAP 
   nginx : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 
```

__Подзадача:__
- на `web` поднимаем `nginx`;
- все логи с `nginx` должны уходить на удаленный сервер (локально только критичные). 

__Решение:__
- согласно [документации](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/) в `nginx` встроен механизм отправки логов на центральный сервер:
```text
    ...
    access_log syslog:server=192.168.23.90:514,tag=nginx,severity=info; <-- все уходит на центральный лог сервер
                                                                            (я всё же исключил степень debug, оставив 
                                                                            info, notice, warn, error, crit, alert, emerg) 
    error_log /var/log/nginx/error.log crit;
    ...
```

```shell
$ ansible-playbook playbooks/client.yml --tags nginx-deploy
    
    PLAY [Playbook of client initialization] ***********************************************************************************
    TASK [Gathering Facts] *****************************************************************************************************
    ok: [nginx]
    TASK [../roles/client : Install EPEL Repo package from standart repo] *************************************************
    changed: [nginx]
    TASK [../roles/client : NGINX | Install NGINX package from EPEL Repo] *************************************************
    changed: [nginx]
    TASK [../roles/client : NGINX | Create NGINX config file from template] ***********************************************
    changed: [nginx]
    RUNNING HANDLER [../roles/client : restart nginx] *********************************************************************
    changed: [nginx]
    RUNNING HANDLER [../roles/client : reload nginx] **********************************************************************
    changed: [nginx]
    PLAY RECAP *****************************************************************************************************************
    nginx                      : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```

__Подзадача:__
- настраиваем аудит, следящий за изменением конфигов `nginx` 
- логи аудита должны также уходить на удаленную систему.

__Решение:__
- о реализованном подходе к организации системы аудита с использованием Git я писал выше.

```shell
$ ansible-playbook playbooks/client.yml --tags audit-deploy
    
    PLAY [Playbook of client initialization] ***********************************************************************************
    TASK [Gathering Facts] *****************************************************************************************************
    ok: [nginx]
    TASK [../roles/client : Rsyslog self-written monitoring | Path contents change audit | Service] ***********************
    changed: [nginx]
    TASK [../roles/client : Rsyslog self-written monitoring | Path contents change audit | Timer] *************************
    changed: [nginx]
    TASK [../roles/client : Rsyslog self-written monitoring | Path contents change audit | Environment] *******************
    changed: [nginx]
    TASK [../roles/client : Rsyslog self-written monitoring | Path contents change audit | Shell] *************************
    changed: [nginx]
    PLAY RECAP *****************************************************************************************************************
    nginx                      : ok=5    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

```

```shell
$ ansible-playbook playbooks/server.yml --list-tags
    playbook: playbooks/server.yml
    play #1 (hw023log): Playbook of server initialization TAGS: []
    TASK TAGS: [ <-- вывод отформатирован исключительно для удобства восприятия реализованного
        rsyslog-configure,
            rsyslog-change-log-formatting, 
            rsyslog-enable-tcp, 
            rsyslog-rules-configure
    ]

$ ansible-playbook playbooks/server.yml --tags rsyslog-configure
      
    PLAY [Playbook of server initialization] ***********************************************************************************
    TASK [Gathering Facts] *****************************************************************************************************
    ok: [vagrant]
    TASK [../roles/server : Rsyslog | Configure TCP | Enable ModLoad imtcp] ***********************************************
    changed: [vagrant]
    TASK [../roles/server : Rsyslog | Configure TCP | Enable InputTCPServerRun 514] ***************************************
    changed: [vagrant]
    TASK [../roles/server : Rsyslog | Configure log template formatting] **************************************************
    changed: [vagrant]
    TASK [../roles/server : Rsyslog | Config content] *********************************************************************
    changed: [vagrant]
    TASK [../roles/server : Rsyslog | Configure rules] ********************************************************************
    changed: [vagrant]
    RUNNING HANDLER [../roles/server : restart rsyslog] *******************************************************************
    changed: [vagrant]
    PLAY RECAP *****************************************************************************************************************
    vagrant                    : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
    
```

## Проверка

| Последовательность| ------------- |:-------------:| -----:|
| без разницы| vagrant ssh hw023web | vagrant ssh hw023log |
| col 2 is      | ls /var/log/rsyslog/      |   $12 |
| col 2 is      | No such file or directory      |   $12 |
| zebra stripes | are neat      |    $1 |

```shell


curl -I http://192.168.23.80:8080

 HTTP/1.1 200 OK
 Server: nginx/1.20.1
 Date: Thu, 22 Jul 2021 19:10:56 GMT
 Content-Type: text/html
 Content-Length: 4833
 Last-Modified: Fri, 16 May 2014 15:12:48 GMT
 Connection: keep-alive
 ETag: "53762af0-12e1"
 Accept-Ranges: bytes


```

https://nginx.org/en/docs/syslog.html
Severity of error messages is determined by nginx, thus the parameter is ignored in the error_log directive. 