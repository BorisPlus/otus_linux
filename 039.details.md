# MySQL: Backup + Репликация 

В материалах приложены ссылки на вагрант для репликации и дамп базы bet.dmp
Базу развернуть на мастере и настроить так, чтобы реплицировались таблицы:
* | bookmaker          |
* | competition        |
* | market             |
* | odds               |
* | outcome
* Настроить GTID репликацию x варианты которые принимаются к сдаче
  * рабочий вагрантафайл
  * скрины или логи SHOW TABLES
  * конфиги
  * пример в логе изменения строки и появления строки на реплике

https://www.percona.com/doc/percona-server/5.7/installation/yum_repo.html#installing-percona-server-from-percona-yum-repository
* yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm
* yum list | grep percona
* sudo dnf module disable mysql

## Исполнение

__Замечание 1__: при автоматизированном запуске команды восстановления базы на слейве у меня возникала ошибка `ERROR 3546 (HY000) at line 24: @@GLOBAL.GTID_PURGED cannot be changed: the added gtid set must not overlap with @@GLOBAL.GTID_EXECUTED`, как выяснилось, необходим запуск:
```sqlite-psql
RESET MASTER;
SOURCE /home/vagrant/common/master.sql;
...
```
__Замечание 2__: Возможно из-за особенностей Centos или VM, возникла необходимость указания конктерных интерфейсов работы MySQL (приложил в файл `00-bindaddress.cnf`)
```properties
[mysqld]
{% if inventory_hostname == 'master' %}
bind-address=192.168.39.10
{% else %}
bind-address=192.168.39.11
{% endif %}
```

__Замечание 3__: Абсолютно все по разворачиванию и тестированию делает Ansible. Последнюю версию Перконы он тоже выбирает "сам".

Вот, что на Мастере

```shell
ansible-playbook playbooks/master.yml > ../files/master.yml.txt
```

Вот, что на Реплике

[details]:[лог `playbooks/master.yml`](./039/files/master.yml.txt)

```shell
ansible-playbook playbooks/replica.yml > ../files/replica.yml.txt
```

[details]:[лог `playbooks/replica.yml`](./039/files/replica.yml.txt)

## Демонстрация работоспособности

### Изначальное состояние Реплики

```shell
ansible-playbook playbooks/replica_check_before.yml > ../files/replica_check_before.yml.txt
```

[details]:[show slave status](./039/files/replica_before-show_slave_status.txt)

[details]:[show tables](./039/files/replica_before-slave_show_tables.txt)

[details]:[select * from bookmaker](./039/files/replica_before-select_from_bookmaker.txt)

### Активные действия на Мастере

```shell
ansible-playbook playbooks/master_check.yml > ../files/master_check.yml.txt
```


[details]:[выборка на Мастере после вставки](./039/files/master_check-select_after_insert.txt)

[details]:[show binlog events](./039/files/master_check-show_binlog_events.txt)

[details]:[show master status](./039/files/master_check-show_master_status.txt)

### Итоговое состояние Реплики после активности на Мастере

```shell
ansible-playbook playbooks/replica_check_after.yml > ../files/replica_check_after.yml.txt
```

[details]:[show slave status](./039/files/replica_after-show_slave_status.txt)

[details]:[show tables](./039/files/replica_after-slave_show_tables.txt)

[details]:[значение gtid_executed](./039/files/replica_after-gtid_executed.txt)

[details]:[select * from bookmaker](./039/files/replica_after-select_from_bookmaker.txt)
