#  VPN

Между двумя виртуалками поднять vpn в режимах
* tun;
* tap; 
* Прочуствовать разницу.

Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке

## Исполнение

Я добился того, что:
* стенд разворачивается автоматом с нужными конфигами, генерацией ключей (кроме их подписывания - об это ниже)
* имеется проверка на работоспособность:
  * статус `systemctl ...`
  * лог `/var/log/...`
  * интерфейс `tun0`

Текущая настройка идет в `tun`, считая что для связи между хоставми необходима маршрутизация, то есть сетефой уровень связности (L3).
В `tap` возможно объединить только при наличии канальной связности устройств (L2).

### Разворачивание сервера

```shell
cd 031/vm/
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
```

```shell
ansible-playbook playbooks/generate_vpn_server_certs.yml > ../files/generate_vpn_server_certs.yml.txt
```
Обрпте на итоговый вывод
[details --no-link]:[лог `playbooks/generate_vpn_server_certs.yml`](./031/files/generate_vpn_server_certs.yml.txt)

К сожалению, команда `sign-req` не автоматизируема, что связано с невозможностью осуществления автоматического ввода ответа на вопросы утилиты по факту ключевой фразы к корневому серитифкату центра авторизазации
```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req server server # <--- вот тут вводим не автоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_server.yml > ../files/configure_openvpn_server.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_server.yml.txt)

### Демонстрация работоспособности сервера

```shell
ansible-playbook playbooks/check_openvpn_server.yml  > ../files/check_openvpn_server.yml.txt
```

[details --no-link]:[лог `systemctl status openvpn@server.service`](./031/files/server-systemctl-status-openvpn@server.service.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn-status.log.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn-status.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn.log.txt)

### Клиент

```shell
ansible-playbook playbooks/generate_vpn_client_certs.yml  > ../files/generate_vpn_client_certs.yml.txt
```

Так как `sign-req` не автоматизируема:

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req client client # <--- вот тут вводим не автоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_client.yml > ../files/configure_openvpn_client.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_client.yml.txt)


### Демонстрация работоспособности клиента

```shell
ansible-playbook playbooks/check_openvpn_client.yml  > ../files/check_openvpn_client.yml.txt
```

[details --no-link]:[лог `ip add show tun0`](./031/files/client-_sbin_ip-add-show-tun0.txt)

[details --no-link]:[лог `systemctl status openvpn@client.service.txt`](./031/files/client-systemctl-status-openvpn@client.service.txt)
