#  VPN

Между двумя виртуалками поднять vpn в режимах
* tun;
* tap; 
* Прочуствовать разницу.

Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке

## Исполнение

Я добился того, что:
* стенд разворачивается автоматом с нужными конфигами, генерацией ключей (кроме их подписывания - об это ниже)
* имеется проверка на работоспособность:
  * статус `systemctl ...`
  * лог `/var/log/...`
  * интерфейс `tun0`

Текущая настройка идет в `tun`, считая что для связи между хоставми необходима маршрутизация, то есть сетефой уровень связности (L3).
В `tap` возможно объединить только при наличии канальной связности устройств (L2).

### Разворачивание сервера

```shell
cd 031/vm/
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
```

```shell
ansible-playbook playbooks/generate_vpn_server_certs.yml > ../files/generate_vpn_server_certs.yml.txt
```

Обратите внимание на итоговый вывод `playbooks/generate_vpn_server_certs.yml`.

[details --no-link]:[лог `playbooks/generate_vpn_server_certs.yml`](./031/files/generate_vpn_server_certs.yml.txt)

К сожалению, команда `sign-req` не автоматизируема, что связано с невозможностью осуществления автоматического ввода ответа на вопросы утилиты по факту ключевой фразы к корневому сертификату центра авторизации

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req server server # <--- вот тут вводим неавтоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_server.yml > ../files/configure_openvpn_server.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_server.yml.txt)

### Демонстрация работоспособности сервера

```shell
ansible-playbook playbooks/check_openvpn_server.yml  > ../files/check_openvpn_server.yml.txt
```

[details --no-link]:[лог `systemctl status openvpn@server.service`](./031/files/server-systemctl-status-openvpn@server.service.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn-status.log.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn-status.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn.log.txt)

### Клиент

```shell
ansible-playbook playbooks/generate_vpn_client_certs.yml  > ../files/generate_vpn_client_certs.yml.txt
```

Опять, так как `sign-req` не автоматизируема:

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req client client # <--- вот тут вводим не автоматизируемые ответы
```

```shell
exit
cd ../ansible
ansible-playbook playbooks/configure_openvpn_client.yml > ../files/configure_openvpn_client.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_client.yml.txt)


### Демонстрация работоспособности клиента

```shell
ansible-playbook playbooks/check_openvpn_client.yml  > ../files/check_openvpn_client.yml.txt
```

[details --no-link]:[лог `ip add show tun0`](./031/files/client-_sbin_ip-add-show-tun0.txt)

[details --no-link]:[лог `systemctl status openvpn@client.service.txt`](./031/files/client-systemctl-status-openvpn@client.service.txt)

## RAS

```shell
ansible-playbook playbooks/ras.yml > ../files/playbooks_ras.yml.txt
```

[details --no-link]:[лог `ansible-playbook playbooks/ras.yml`](./031/files/playbooks_ras.yml.txt)


Проверка локальной работы не смотрящего во внешний мир веб-сервера
```shell
cd ../vm
vagrant ssh server
[vagrant@server ~]$ curl 127.0.0.1:80
Hello from RAS :)
[vagrant@server ~]$ exit
```

## Шлак RAS

Ключи для клиента RAS
```shell
ls -l guest/temp/ras_client/*
  -rw-r--r-- 1 b b 1172 сен 23 22:19 guest/temp/ras_client/ca.crt
  -rw-r--r-- 1 b b  636 сен 23 22:22 guest/temp/ras_client/tc.key
  guest/temp/ras_client/issued:
  итого 8
  -rw-r--r-- 1 b b 4425 сен 23 22:23 client.crt
  guest/temp/ras_client/private:
  итого 4
  -rw-r--r-- 1 b b 1704 сен 23 22:22 client.key
```


```shell
cd ../vm
vagrant ssh server
sudo su
echo 'net.ipv4.conf.all.forwarding=1'  > /etc/sysctl.conf
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
sysctl -p /etc/sysctl.conf
systemctl restart network.service

iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X


iptables -A INPUT -i eth1 -p udp --dport 1194 -j ACCEPT
iptables -A INPUT -i tun+ -j ACCEPT
iptables -A OUTPUT -o tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -t nat -A POSTROUTING -s 172.16.10.0/24 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

iptables -A FORWARD -i tun0 -o eth1 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth1 -o tun0 -m state --state ESTABLISHED,RELATED -j ACCEPT

iptables -A INPUT -i eth1 -p udp --dport 1194 -j ACCEPT
iptables -A FORWARD -p udp --j ACCEPT 

iptables -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT


iptables -t nat -A POSTROUTING -s 192.168.31.0/24 -j MASQUERADE

echo '' > /etc/openvpn/client/ras_client.conf
nano /etc/openvpn/client/ras_client.conf

remote 127.0.0.1 1194
client
resolv-retry infinite
nobind
proto udp
dev tun0
comp-lzo
ca client/ca.crt
cert client/issued/client.crt
key client/private/client.key
tls-client
tls-auth client/tc.key 1
float
keepalive 10 120
persist-key
persist-tun
verb 3



remote 127.0.0.1 1194
tls-client
remote-cert-tls server
nobind
proto udp
dev tun0
pull
resolv-retry infinite
comp-lzo
ca client/ca.crt
cert client/issued/client.crt
key client/private/client.key
persist-tun
persist-key
verb 3
route-method exe
route-delay 2



cp -r /home/b/pycharm_projects_2021_2/otus_linux/031/vm/guest/temp/ras_client/* /etc/openvpn/client/



cd /etc/openvpn
sudo openvpn --config /etc/openvpn/client/ras_client.conf

sudo nmap -sU 127.0.0.01 -p 1194
Starting Nmap 7.70 ( https://nmap.org ) at 2021-09-24 01:07 MSK
Nmap scan report for localhost (127.0.0.1)
Host is up.

PORT     STATE         SERVICE
1194/udp open|filtered openvpn

ip route replace 172.16.10.0/24 dev eth1
systemctl stop firewalld
systemctl disable firewalld

setenforce 0
```