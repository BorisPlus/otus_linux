#  VPN

Между двумя виртуалками поднять vpn в режимах
* tun;
* tap; 
* Прочуствовать разницу.

Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке

## Исполнение

Я добился того, что:
* стенд разворачивается автоматом с нужными конфигами, генерацией ключей (кроме их подписывания - об это ниже)
* имеется проверка на работоспособность:
  * статус `systemctl ...`
  * лог `/var/log/...`
  * интерфейс `tun0`

Текущая настройка идет в `tun`, считая что для связи между хоставми необходима маршрутизация, то есть сетефой уровень связности (L3).
В `tap` возможно объединить только при наличии канальной связности устройств (L2).

### Разворачивание сервера

```shell
cd 031/vm/
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
```

```shell
ansible-playbook playbooks/generate_vpn_server_certs.yml > ../files/generate_vpn_server_certs.yml.txt
```

Обратите внимание на итоговый вывод `playbooks/generate_vpn_server_certs.yml`.

[details --no-link]:[лог `playbooks/generate_vpn_server_certs.yml`](./031/files/generate_vpn_server_certs.yml.txt)

К сожалению, команда `sign-req` не автоматизируема, что связано с невозможностью осуществления автоматического ввода ответа на вопросы утилиты по факту ключевой фразы к корневому сертификату центра авторизации

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req server server # <--- вот тут вводим неавтоматизируемые ответы

exit
```

```shell
cd ../ansible
ansible-playbook playbooks/configure_openvpn_server.yml > ../files/configure_openvpn_server.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_server.yml.txt)

### Демонстрация работоспособности сервера

```shell
ansible-playbook playbooks/check_openvpn_server.yml  > ../files/check_openvpn_server.yml.txt
```

[details --no-link]:[лог `systemctl status openvpn@server.service`](./031/files/server-systemctl-status-openvpn@server.service.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn-status.log.txt)

[details --no-link]:[лог `sudo cat /var/log/openvpn_openvpn-status.log`](./031/files/server-sudo-cat-_var_log_openvpn_openvpn.log.txt)

### Клиент

```shell
ansible-playbook playbooks/generate_vpn_client_certs.yml  > ../files/generate_vpn_client_certs.yml.txt
```

Опять, так как `sign-req` не автоматизируема:

```shell
cd ../vm
vagrant ssh server
```

Это внутри виртуалки `server`:

```shell
cd /home/vagrant/common/temp/easyrsa/ 
./easyrsa sign-req client client # <--- вот тут вводим не автоматизируемые ответы
```

```shell
exit
cd ../ansible
ansible-playbook playbooks/configure_openvpn_client.yml > ../files/configure_openvpn_client.yml.txt
```

[details --no-link]:[лог `playbooks/configure_openvpn_server.yml`](./031/files/configure_openvpn_client.yml.txt)


### Демонстрация работоспособности клиента

```shell
ansible-playbook playbooks/check_openvpn_client.yml  > ../files/check_openvpn_client.yml.txt
```

[details --no-link]:[лог `ip add show tun0`](./031/files/client-_sbin_ip-add-show-tun0.txt)

[details --no-link]:[лог `systemctl status openvpn@client.service.txt`](./031/files/client-systemctl-status-openvpn@client.service.txt)

## RAS

```shell
ansible-playbook playbooks/ras.yml > ../files/playbooks_ras.yml.txt
```

[details --no-link]:[лог `ansible-playbook playbooks/ras.yml`](./031/files/playbooks_ras.yml.txt)


Проверка локальной работы не смотрящего во внешний мир веб-сервера
```shell
cd ../vm

vagrant ssh server

curl 127.0.0.1:80
    Hello from RAS :)

## Пытаюсь найти причину неконнекта к RAS

sudo su
echo 'net.ipv4.conf.all.forwarding=1'  > /etc/sysctl.conf
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
sysctl -p /etc/sysctl.conf
systemctl restart network.service
systemctl stop firewalld
systemctl disable firewalld
setenforce 0

exit
```

Локальный лог

```shell

cp -r .../otus_linux/031/vm/guest/temp/ras_client/* /etc/openvpn/client/

echo '' > /etc/openvpn/client/ras_client.conf
nano /etc/openvpn/client/ras_client.conf

remote 127.0.0.1 1194
client
resolv-retry infinite
nobind
proto udp
dev tun0
comp-lzo
ca client/ca.crt
cert client/issued/client.crt
key client/private/client.key
tls-client
tls-auth client/tc.key 1
float
keepalive 10 120
persist-key
persist-tun
verb 3


root@b:/etc/openvpn# sudo openvpn --config /etc/openvpn/client/ras_client.conf

Fri Sep 24 02:20:42 2021 WARNING: file 'client/private/client.key' is group or others accessible
Fri Sep 24 02:20:42 2021 WARNING: file 'client/tc.key' is group or others accessible
Fri Sep 24 02:20:42 2021 OpenVPN 2.4.7 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Apr 28 2021
Fri Sep 24 02:20:42 2021 library versions: OpenSSL 1.1.1d  10 Sep 2019, LZO 2.10
Fri Sep 24 02:20:42 2021 WARNING: No server certificate verification method has been enabled.  See http://openvpn.net/howto.html#mitm for more info.
Fri Sep 24 02:20:42 2021 Outgoing Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Fri Sep 24 02:20:42 2021 Incoming Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication
Fri Sep 24 02:20:42 2021 TCP/UDP: Preserving recently used remote address: [AF_INET]127.0.0.1:1194
Fri Sep 24 02:20:42 2021 Socket Buffers: R=[212992->212992] S=[212992->212992]
Fri Sep 24 02:20:42 2021 UDP link local: (not bound)
Fri Sep 24 02:20:42 2021 UDP link remote: [AF_INET]127.0.0.1:1194   <---- НЕ ХОЧЕТ
Fri Sep 24 02:21:42 2021 TLS Error: TLS key negotiation failed to occur within 60 seconds (check your network connectivity)
Fri Sep 24 02:21:42 2021 TLS Error: TLS handshake failed
Fri Sep 24 02:21:42 2021 SIGUSR1[soft,tls-error] received, process restarting
Fri Sep 24 02:21:42 2021 Restart pause, 5 second(s)
Fri Sep 24 02:21:47 2021 WARNING: No server certificate verification method has been enabled.  See http://openvpn.net/howto.html#mitm for more info.
Fri Sep 24 02:21:47 2021 TCP/UDP: Preserving recently used remote address: [AF_INET]127.0.0.1:1194
Fri Sep 24 02:21:47 2021 Socket Buffers: R=[212992->212992] S=[212992->212992]
Fri Sep 24 02:21:47 2021 UDP link local: (not bound)


```