#  Сетевые пакеты. LACP 

Начну c того, что для реализации рабочего стенда было перелопачено достаточно много материала. Менялись дистрибутивы, менялись ядра, менялись версии операционок, менялись утилиты настройки (Итог - CentOS 7 и БЕЗ NetworkManager). С целью экономии времени разработки и отладки я развернул отдельный стенд для этой задачи, просто 2 узла и 2 канала между ними. Если действительно необходимо для сдачи ДЗ, то я объединю блок с общим репозиторием сети "предприятия". Но "математика" одна (названия узлов сохранены).

* https://centos.name/?page/tipsandtricks/BondingInterfaces
* https://ahelpme.com/linux/centos-8/adding-bonding-interface-to-centos-8-editing-configuration-files-only/
* https://github.com/simonmcc/vagrant-bond/blob/master/shell/convert2bond.sh
* https://help.ubuntu.com/community/UbuntuBonding

## Исполнение

Очень важно понимать, что должно быть именно ДВА независимых ФИЗИЧЕСКИХ канала, будто это два провайдера. Соответсвенно в [details]:[Vagrantfile](./033_part2/vm/Vagrantfile) это каналы адапторов: 

```shell
cd ../vm/
vagrant destroy -f && vagrant up 
python3 v2a.py -o ../ansible/inventories/hosts # Это уже как кредо
cd ../ansible/
ansible-playbook playbooks/create_bond.yml 
ansible-playbook playbooks/demonstrate.yml 
```

[details]:[лог `ansible-playbook playbooks/create_bond.yml`](./033_part2/files/playbooks_create_bond.yml.log)

## Демонстрация работоспособности

__Замечание__: ключевой момент - это именно работа с `/etc/modprobe.conf`, лишь в одной статье говорится об этом, так как обычно опуци работы с `bond` включаются тут де в файл  `/etc/sysconfig/network-scripts/ifcfg-bond`. 

Для `inetRouter`:

[details --no-link]:[содержание `/proc/net/bonding/bond0`](./033_part2/files/inetRouter - cat _proc_net_bonding_bond0.txt)
[details --no-link]:[содержание `/etc/modprobe.conf`](./033_part2/files/inetRouter - cat _etc_modprobe.conf.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-bond0`](./033_part2/files/inetRouter - cat _etc_sysconfig_network-scripts_ifcfg-bond0.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-eth1`](./033_part2/files/inetRouter - cat _etc_sysconfig_network-scripts_ifcfg-eth1.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-eth2`](./033_part2/files/inetRouter - cat _etc_sysconfig_network-scripts_ifcfg-eth2.txt)
[details --no-link]:[лог `ip a`](./033_part2/files/inetRouter - _sbin_ip a.txt)
[details --no-link]:[лог `ip r`](./033_part2/files/inetRouter - _sbin_ip r.txt)
[details --no-link]:[лог `ping -s 64 -c 4 10.1.1.2`](./033_part2/files/inetRouter - ping -s 64 -c 4 10.1.1.2.txt)

Для `centralRouter`:

[details --no-link]:[содержание `/proc/net/bonding/bond0`](./033_part2/files/centralRouter - cat _proc_net_bonding_bond0.txt)
[details --no-link]:[содержание `/etc/modprobe.conf`](./033_part2/files/centralRouter - cat _etc_modprobe.conf.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-bond0`](./033_part2/files/centralRouter - cat _etc_sysconfig_network-scripts_ifcfg-bond0.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-eth1`](./033_part2/files/centralRouter - cat _etc_sysconfig_network-scripts_ifcfg-eth1.txt)
[details --no-link]:[содержание `/etc/sysconfig/network-scripts/ifcfg-eth2`](./033_part2/files/centralRouter - cat _etc_sysconfig_network-scripts_ifcfg-eth2.txt)
[details --no-link]:[лог `ip a`](./033_part2/files/centralRouter - _sbin_ip a.txt)
[details --no-link]:[лог `ip r`](./033_part2/files/centralRouter - _sbin_ip r.txt)
[details --no-link]:[лог `ping -s 64 -c 4 10.1.1.1`](./033_part2/files/centralRouter - ping -s 64 -c 4 10.1.1.1.txt)

## Вопросы

Почему PING идет с потерями? Куда копать?

[details --no-link]:[лог `ping -s 64 -c 4 10.1.1.1`](./033_part2/files/centralRouter - ping -s 64 -c 4 10.1.1.1.txt)

По рекомендации для отладки я поменял в Vagrantfile у всех интерфейсов `virtualbox__intnet` на одинаковое значение (хотя внутренне мне кажестя неправильным, так как так не протестировать "резервирование" и "отказоустойчивость" на приближенном к боевому). Да, пинг стал стабилен.

Но при дальнейшем тестировании при пинге с inetRouter, если на centralRouter `sudo ip link set eth2 down` - пинг продолжает идти.
Если вернуть `sudo ip link set eth2 up` и отключить первый `sudo ip link set eth1 down` - пинг ПРОПАДАЕТ.
Почему?

inetRouter | centralRouter
 --- | --- 
[vagrant@inetRouter ~]$  ping  10.1.1.2 | 
PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data. | 
64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.907 ms | 
64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.643 ms | 
64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=1.82 ms | [vagrant@centralRouter ~]$  sudo ip link set eth2 down
64 bytes from 10.1.1.2: icmp_seq=4 ttl=64 time=0.821 ms | # ping идет, как видим
64 bytes from 10.1.1.2: icmp_seq=5 ttl=64 time=0.764 ms | [vagrant@centralRouter ~]$  cat /proc/net/bonding/bond0
64 bytes from 10.1.1.2: icmp_seq=6 ttl=64 time=1.83 ms | ...
64 bytes from 10.1.1.2: icmp_seq=7 ttl=64 time=0.803 ms | Slave Interface: eth2
64 bytes from 10.1.1.2: icmp_seq=8 ttl=64 time=0.675 ms | MII Status: down
64 bytes from 10.1.1.2: icmp_seq=9 ttl=64 time=0.738 ms | ...
64 bytes from 10.1.1.2: icmp_seq=10 ttl=64 time=0.714 ms | Link Failure Count: 1
64 bytes from 10.1.1.2: icmp_seq=11 ttl=64 time=0.869 ms | ...
64 bytes from 10.1.1.2: icmp_seq=12 ttl=64 time=1.56 ms | [vagrant@centralRouter ~]$ sudo ip link set eth2 up
64 bytes from 10.1.1.2: icmp_seq=13 ttl=64 time=0.708 ms | [vagrant@centralRouter ~]$ sudo ip link set eth1 down
. | # ping больше не идет. Почему?
. | 
. | 
