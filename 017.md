# SELinux

Тренируем умение работать с SELinux: диагностировать проблемы и модифицировать политики SELinux для корректной работы приложений, если это требуется.

1. Запустить nginx на нестандартном порту 3-мя разными способами:
- переключатели setsebool - [решение](#p_1_1);
- добавление нестандартного порта в имеющийся тип - [решение](#p_1_2);
- формирование и установка модуля SELinux - [решение](#p_1_3). 
2. Обеспечить работоспособность приложения при включенном selinux.
- развернуть приложенный стенд https://github.com/mbfx/otus-linux-adm/tree/master/selinux_dns_problems; 
- выяснить причину неработоспособности механизма обновления зоны (см. README) - [выяснил](#p_2_0);
- предложить решение (или решения) для данной проблемы - [решение 1](#p_2_1) и - [решение 2](#p_2_2);
- выбрать одно из решений для реализации, предварительно обосновав выбор [в пользу решения 2](#p_2_vibor);
- реализовать выбранное решение и продемонстрировать его работоспособность.

К сдаче: cтатус "Принято" ставится при выполнении следующих условий:
- для задания 1 описаны, реализованы и продемонстрированы все 3 способа решения; 
- для задания 2 описана причина неработоспособности механизма обновления зоны; 
- для задания 2 реализован и продемонстрирован один из способов решения.

Опционально для выполнения:
- для задания 2 предложено более одного способа решения - [решение 1](#p_2_1) и - [решение 2](#p_2_2);
- для задания 2 обоснованно(!) выбран один из способов решения [в пользу решения 2](#p_2_2_true).

## Исполнение

Может быть, это будет заметно, но задачу №2 решал первой, поэтому пояснений в решении задачи №1 меньше.

## 1. Запустить nginx на нестандартном порту 3-мя разными способами.

Ранее [в домашнем задании №14](./014.md) не удавалось поднять `nginx` на недефолтных портах.
Использую соответствующую VM - `playbooks`. Пункты решал не хронологически.

__Очень важно__: для того, чтоб эффективно решить задачу, оказалось, ОЧЕНЬ важно выбрать ничем незадейсвованные порты, иначе пояснения `audit2allow` будут неоптимальны.
```shell
semanage port -l | grep 8080 # <--- это для демонстрации распределения
    http_cache_port_t              tcp      8080, 8118, 8123, 10001-10010
semanage port -l | grep 8081 # <-- 8081, например, задействован
    transproxy_port_t              tcp      8081 
semanage port -l | grep 8087 # <--- это для использования в п.1.1
semanage port -l | grep 8086 # <--- это для использования в п.1.2
semanage port -l | grep 8085 # <--- это для использования в п.1.3

```

```shell
vagrant up playbooks
vagrant ssh playbooks
```
Предварительно (пригодится)
```shell
yum install -y epel-release
yum install -y nginx
yum -q provides audit2why
    policycoreutils-python-2.5-34.el7.x86_64 : SELinux policy core python utilities
yum install -y policycoreutils-python
```

## 1.1 setsebool

<a name="p_1_1"></a>

```shell
curl -I 127.0.0.1:80
    curl: (7) Failed connect to 127.0.0.1:80; Connection refused

sed -i s@80@8087@g /etc/nginx/nginx.conf

cat  /etc/nginx/nginx.conf | grep 808 
        listen       8087;
        listen       [::]:8087;
        
service nginx restart
    Redirecting to /bin/systemctl restart nginx.service
    Job for nginx.service failed because the control process exited with error code. See "systemctl status nginx.service" and "journalctl -xe" for details.

service nginx status | grep play
    Redirecting to /bin/systemctl status nginx.service
    Jul 04 21:42:07 playbooks systemd[1]: Starting The nginx HTTP and reverse proxy server...
    Jul 04 21:42:08 playbooks nginx[3602]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
--> Jul 04 21:42:08 playbooks nginx[3602]: nginx: [emerg] bind() to 0.0.0.0:8087 failed (13: Permission denied)
    Jul 04 21:42:08 playbooks nginx[3602]: nginx: configuration file /etc/nginx/nginx.conf test failed
    Jul 04 21:42:08 playbooks systemd[1]: nginx.service: control process exited, code=exited status=1
    Jul 04 21:42:08 playbooks systemd[1]: Failed to start The nginx HTTP and reverse proxy server.
    Jul 04 21:42:08 playbooks systemd[1]: Unit nginx.service entered failed state.
    Jul 04 21:42:08 playbooks systemd[1]: nginx.service failed.

audit2why < /var/log/audit/audit.log
    type=AVC msg=audit(1625434928.031:1026): avc:  denied  { name_bind } for  pid=3602 comm="nginx" src=8087 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket permissive=0
        Was caused by:
        The boolean nis_enabled was set incorrectly.   <-- если б выбрали занятый порт, например, 8081, то вывод бы был совсем иной
        Description:
        Allow nis to enabled
        Allow access by executing:
        # setsebool -P nis_enabled 1

setsebool -P nis_enabled 1 <-- не быстро, подождать нужно

service nginx restart
    Redirecting to /bin/systemctl restart nginx.service

curl -I 127.0.0.1:8087
    HTTP/1.1 200 OK
    Server: nginx/1.20.1
    Date: Sun, 04 Jul 2021 21:50:51 GMT
    Content-Type: text/html
    Content-Length: 4833
    Last-Modified: Fri, 16 May 2014 15:12:48 GMT
    Connection: keep-alive
    ETag: "53762af0-12e1"
    Accept-Ranges: bytes

setsebool -P nis_enabled 0 <-- почистим за собой, нас тут не было :)

```

Необходимо заметить, что после `setsebool -P nis_enabled 0` сервис `nginx` продолжает отвечать `HTTP/1.1 200 OK` до перезапуска.

## 1.2 добавление нестандартного порта в имеющийся тип

<a name="p_1_2"></a>

```shell
sed -i s@8087@8086@g /etc/nginx/nginx.conf

cat  /etc/nginx/nginx.conf | grep 808 
        listen       8086;
        listen       [::]:8086;

semanage port -l | grep 8080 # <--- это дефолтный порт nginx, смотрим название типа
    http_cache_port_t              tcp      8080, 8118, 8123, 10001-10010
    
semanage port -a -t http_port_t -p tcp 8086 <-- очень долго происходит, было ощущение зависания, вопорс ниже

service nginx restart
    Redirecting to /bin/systemctl start nginx.service

curl -I 127.0.0.1:8086
    HTTP/1.1 200 OK
    Server: nginx/1.20.1
    Date: Sun, 04 Jul 2021 21:53:44 GMT
    Content-Type: text/html
    Content-Length: 4833
    Last-Modified: Fri, 16 May 2014 15:12:48 GMT
    Connection: keep-alive
    ETag: "53762af0-12e1"
    Accept-Ranges: bytes

semanage port -d -t http_port_t -p tcp 8086 <-- почистим за собой, нас тут не было :)
```

Необходимо заметить, что после `semanage port -d..` на порту `8086` сервис `nginx` продолжает отвечать `HTTP/1.1 200 OK` до перезапуска.

__Вопрос__: я не дождался команды и прервал через клавиатуру. При следующем запуске было 
```shell
libsemanage.semanage_get_lock: Could not get direct transaction lock at /etc/selinux/targeted/semanage.trans.LOCK. (Resource temporarily unavailable).
OSError: Resource temporarily unavailable
```

Через `ps ax` находил `<pid>`, однако `kill -9 <pid>` не срабатывал. Помог перезапуск виртуалки. Но как иначе без перезагрузки?

### 1.3 формирование и установка модуля SELinux

<a name="p_1_3"></a>

```shell
sed -i s@8086@8085@g /etc/nginx/nginx.conf

cat  /etc/nginx/nginx.conf | grep 808 
    listen       8085;
    listen       [::]:8085;

service nginx restart

audit2allow < /var/log/audit/audit.log
    
    #============= httpd_t ==============
    #!!!! This avc can be allowed using the boolean 'nis_enabled'
    allow httpd_t unreserved_port_t:tcp_socket name_bind;

audit2allow -M allow_httpd_name_bind --debug < /var/log/audit/audit.log

cat ./allow_httpd_name_bind.te 
    
    module allow_httpd_name_bind 1.0;
    require {
            type httpd_t;
            type unreserved_port_t;
            class tcp_socket name_bind;
    }
    #============= httpd_t ==============
    #!!!! This avc can be allowed using the boolean 'nis_enabled'
    allow httpd_t unreserved_port_t:tcp_socket name_bind;

semodule -i allow_httpd_name_bind.pp  <-- не быстро

semodule -l | grep allow_httpd_name_bind

    allow_httpd_name_bind	1.0

curl -I 127.0.0.1:8085
    HTTP/1.1 200 OK
    Server: nginx/1.20.1
    Date: Sun, 04 Jul 2021 22:04:15 GMT
    Content-Type: text/html
    Content-Length: 4833
    Last-Modified: Fri, 16 May 2014 15:12:48 GMT
    Connection: keep-alive
    ETag: "53762af0-12e1"
    Accept-Ranges: bytes
    
semodule -v -d allow_httpd_name_bind  <-- почистим за собой, выключить, не быстро
    Attempting to disable module 'allow_httpd_name_bind':
    Ok: return value of 0.
    Committing changes
    Ok: transaction number 0.
semodule -r allow_httpd_name_bind     <-- почистим за собой, удалить :)
  libsemanage.semanage_direct_remove_key: Removing last allow_httpd_name_bind module (no other allow_httpd_name_bind module exists at another priority).

```

Необходимо заметить, что после `semodule -r allow_httpd_name_bind.` на порту `8085` сервис `nginx` продолжает отвечать `HTTP/1.1 200 OK` до перезапуска.

## 2. Обеспечить работоспособность приложения при включенном selinux.

### Cтенд

Инженер настроил следующую [схему](https://github.com/mbfx/otus-linux-adm/tree/master/selinux_dns_problems):
- ns01 - DNS-сервер (192.168.50.10);
- client - клиентская рабочая станция (192.168.50.15).

При попытке удаленно (с рабочей станции) внести изменения в зону ddns.lab происходит следующее:
```bash
[vagrant@client ~]$ nsupdate -k /etc/named.zonetransfer.key
> server 192.168.50.10
> zone ddns.lab
> update add www.ddns.lab. 60 A 192.168.50.15
> send
update failed: SERVFAIL
>
```

## Определение узла

Настраиваем зону на `client`
<a name='ddns'></a>

```shell

[vagrant@client ~]$ nsupdate -k /etc/named.zonetransfer.key
> server 192.168.50.10
> zone ddns.lab
> update add www.ddns.lab. 60 A 192.168.50.15
> show
    
    Outgoing update query:
    ;; ->>HEADER<<- opcode: UPDATE, status: NOERROR, id:      0
    ;; flags:; ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: 0
    ;; ZONE SECTION:
    ;ddns.lab.                      IN      SOA
    
    ;; UPDATE SECTION:
    www.ddns.lab.           60      IN      A       192.168.50.15  <-- то, что должно добавиться

> send
update failed: SERVFAIL
>
```

Не закрывая сессию с `client`, производим на `ns01`

```shell
[vagrant@ns01 ~]$ sudo setenforce 0
```

Опять на `client` необходимо произвести заново

```shell
> update add www.ddns.lab. 60 A 192.168.50.15
> send  <-- итак, отработало без ошибок => `setenforce 0` на `ns01` помог => проблема в `ns01` 
> quit
```

Проверка

```shell
[vagrant@client ~]$ dig www.ddns.lab

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.5 <<>> www.ddns.lab
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61153
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.ddns.lab.                  IN      A

;; ANSWER SECTION:
www.ddns.lab.           60      IN      A       192.168.50.15  ------.
                                                                     |
;; AUTHORITY SECTION:                                                |
ddns.lab.               3600    IN      NS      ns01.dns.lab. ---.<--`
                                                                 |
;; ADDITIONAL SECTION:                                           |
ns01.dns.lab.           3600    IN      A       192.168.50.10 <--`

;; Query time: 4 msec
;; SERVER: 192.168.50.10#53(192.168.50.10)
;; WHEN: Wed Jun 30 19:32:56 UTC 2021
;; MSG SIZE  rcvd: 96

```

Вывод: дело действительно в SELinux на `ns01`.

### Установим причины ограничений SELinux на `ns01`

Для чистоты эксперимента необходимо "пересобрать" стенд 
```shell
vagrant destroy && vagrant up  && vagrant ssh client
```

Необходимо заметить, что, как оказалось, достаточно применить одно правило, чтоб стенд сделать [работоспособгным](#stend_on). 

Но, для демонстрации покажу, что и как решал.

### Первый вариант решения (почти в лоб)

<a name="p_2_1"></a>

Повторим заведомо безуспешную [настройку](#ddns) дополнительной зоны. 

Смотрим аудит-лог на `ns01`.

```shell
sudo su

cat /var/log/audit/audit.log  | grep dns
    type=AVC msg=audit(1625166596.582:1901): avc:  denied  { create } for  pid=5044 comm="isc-worker0000" name="named.ddns.lab.view1.jnl" scontext=system_u:system_r:named_t:s0 tcontext=system_u:object_r:etc_t:s0 tclass=file permissive=0

```

Видим "/etc/named/dynamic/named.ddns.lab.view1.jnl" "create" "denied".

Также

```shell
[root@ns01 vagrant]# cat /var/named/data/named.run 
    
    /etc/named/dynamic/named.ddns.lab.view1.jnl: create: permission denied
    
```

Понять причины поможет `audit2why`, а автоматически преобразовать их в правила - `audit2allow`

```shell

audit2why < /var/log/audit/audit.log

    type=AVC msg=audit(1625258891.481:1902): avc:  denied  { create } for  pid=5034 comm="isc-worker0000" name="named.ddns.lab.view1.jnl" scontext=system_u:system_r:named_t:s0 tcontext=system_u:object_r:etc_t:s0 tclass=file permissive=0
        Was caused by:
            Missing type enforcement (TE) allow rule.
            You can use audit2allow to generate a loadable module to allow this access.

audit2allow -M ddns_allow_part_1 --debug < /var/log/audit/audit.log

    ******************** IMPORTANT ***********************
    To make this policy package active, execute:
    semodule -i ddns_allow_part_1.pp

# Какие это правила
cat ./ddns_allow_part_1.te
    
    module ddns_allow_part_1 1.0;
    require {
            type etc_t;
            type named_t;
            class file create;
    }
    #============= named_t ==============
    #!!!! WARNING: 'etc_t' is a base type.                    <-- `etc_t`, но что не так с правами?
    allow named_t etc_t:file create;

semodule -i ddns_allow_part_1.pp  <-- учесть, что долго исполняется

# Для интереса, где он лежит теперь
find / -name ddns_allow_part_1
    /etc/selinux/targeted/active/modules/400/ddns_allow_part_1
    
echo '' > /var/log/audit/audit.log  <-- Для чистоты эксперимента
```

Необходимо запомнить вышеуказанный комментарий `WARNING: 'etc_t' is a base type`, он еще выстрелит.

Повторим на `client` [настройку](#ddns) доменной зоны и все равно получим ошибку

```shell
> server 192.168.50.10
> zone ddns.lab
> update add www.ddns.lab. 60 A 192.168.50.15
> send
update failed: SERVFAIL
```

Повторим на `ns01`
```shell
audit2allow --debug < /var/log/audit/audit.log
    #============= named_t ==============
    allow named_t etc_t:file write;
    
audit2allow -M ddns_allow_part_2 --debug < /var/log/audit/audit.log
    ******************** IMPORTANT ***********************
    To make this policy package active, execute:
    semodule -i ddns_allow_part_2.pp

semodule -i ddns_allow_part_2.pp

cat ddns_allow_part_2.te 
    module ddns_allow_part_2 1.0;
    require {
            type etc_t;
            type named_t;
            class file write;
    }
    #============= named_t ==============
    #!!!! WARNING: 'etc_t' is a base type.
    allow named_t etc_t:file write;

echo '' > /var/log/audit/audit.log  <-- Для чистоты эксперимента
```

Повторим на `client` [настройку](#ddns) доменной зоны и все равно получим ошибку

```shell
update failed: SERVFAIL
```

Повторим на `ns01`

```shell
audit2allow < /var/log/audit/audit.log
    Nothing to do  <-- "-Ошибку видишь? -Нет. -И я не вижу, а она есть"
```

Любые [мытарства](#mitary) НЕ помогали с [настройкой](#ddns) доменной зоны.

Но что заметил (`unconfined_u`)

```shell
ls -Zla /etc/named/*
    -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 784 Jul  3 04:59 /etc/named/named.50.168.192.rev
    -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 610 Jul  3 04:59 /etc/named/named.dns.lab
    -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 609 Jul  3 04:59 /etc/named/named.dns.lab.view1
    -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 657 Jul  3 04:59 /etc/named/named.newdns.lab
    
    /etc/named/dynamic:
    total 8
    drw-rwx---. 2 unconfined_u:object_r:etc_t:s0   root  named  88 Jul  3 09:34 .   <-- `unconfined_u`, но что не так с правами?
    drw-rwx---. 3 system_u:object_r:etc_t:s0       root  named 121 Jul  3 04:59 ..
    -rw-rw----. 1 system_u:object_r:etc_t:s0       named named 509 Jul  3 04:59 named.ddns.lab
    -rw-rw----. 1 system_u:object_r:etc_t:s0       named named 509 Jul  3 04:59 named.ddns.lab.view1
    -rw-r--r--. 1 system_u:object_r:etc_t:s0       named named   0 Jul  3 09:34 named.ddns.lab.view1.jnl  <-- 0 байт?
```

Сменил `unconfined_u` на `system_u`

```shell
sudo chcon -R -u system_u /etc/named/dynamic
```

Новых правил это не добавило.

и cлучайно решил удалить файл

```shell
rm -f /etc/named/dynamic/named.ddns.lab.view1.jnl
```

И все заработало!.

```shell
> server 192.168.50.10
>  zone ddns.lab
>  update add www.ddns.lab. 60 A 192.168.50.15
> send
> quit
```

### Второй вариант решения

<a name="p_2_2"></a>

А вообще какие правила есть для `named`

```shell

semanage fcontext --list | grep named | grep ':etc_t:'
        /var/named/chroot/etc(/.*)?                           all files          system_u:object_r:etc_t:s0 

semanage fcontext --list | grep named
        
        /etc/rndc.*                                        regular file       system_u:object_r:named_conf_t:s0 
        /var/named(/.*)?                                   all files          system_u:object_r:named_zone_t:s0 
        /etc/unbound(/.*)?                                 all files          system_u:object_r:named_conf_t:s0 
        /var/run/bind(/.*)?                                all files          system_u:object_r:named_var_run_t:s0 
        /var/log/named.*                                   regular file       system_u:object_r:named_log_t:s0 
        /var/run/named(/.*)?                               all files          system_u:object_r:named_var_run_t:s0 
        /var/named/data(/.*)?                              all files          system_u:object_r:named_cache_t:s0 
        /dev/xen/tapctrl.*                                 named pipe         system_u:object_r:xenctl_t:s0 
        /var/run/unbound(/.*)?                             all files          system_u:object_r:named_var_run_t:s0 
        /var/lib/softhsm(/.*)?                             all files          system_u:object_r:named_cache_t:s0 
        /var/lib/unbound(/.*)?                             all files          system_u:object_r:named_cache_t:s0 
        /var/named/slaves(/.*)?                            all files          system_u:object_r:named_cache_t:s0 
        /var/named/chroot(/.*)?                            all files          system_u:object_r:named_conf_t:s0 
        /etc/named\.rfc1912.zones                          regular file       system_u:object_r:named_conf_t:s0 
        /var/named/dynamic(/.*)?                           all files          system_u:object_r:named_cache_t:s0 
        /var/named/chroot/etc(/.*)?                        all files          system_u:object_r:etc_t:s0 
        /var/named/chroot/lib(/.*)?                        all files          system_u:object_r:lib_t:s0 
        /var/named/chroot/proc(/.*)?                       all files          <<None>>
        /var/named/chroot/var/tmp(/.*)?                    all files          system_u:object_r:named_cache_t:s0 
        /var/named/chroot/usr/lib(/.*)?                    all files          system_u:object_r:lib_t:s0 
        /var/named/chroot/etc/pki(/.*)?                    all files          system_u:object_r:cert_t:s0 
        /var/named/chroot/run/named.*                      all files          system_u:object_r:named_var_run_t:s0 
        /var/named/chroot/var/named(/.*)?                  all files          system_u:object_r:named_zone_t:s0 
        /usr/lib/systemd/system/named.*                    regular file       system_u:object_r:named_unit_file_t:s0 
        /var/named/chroot/var/run/dbus(/.*)?               all files          system_u:object_r:system_dbusd_var_run_t:s0 
        /usr/lib/systemd/system/unbound.*                  regular file       system_u:object_r:named_unit_file_t:s0 
        /var/named/chroot/var/log/named.*                  regular file       system_u:object_r:named_log_t:s0 
        /var/named/chroot/var/run/named.*                  all files          system_u:object_r:named_var_run_t:s0 
        /var/named/chroot/var/named/data(/.*)?             all files          system_u:object_r:named_cache_t:s0 
        /usr/lib/systemd/system/named-sdb.*                regular file       system_u:object_r:named_unit_file_t:s0 
        /var/named/chroot/var/named/slaves(/.*)?           all files          system_u:object_r:named_cache_t:s0 
        /var/named/chroot/etc/named\.rfc1912.zones         regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot/var/named/dynamic(/.*)?          all files          system_u:object_r:named_cache_t:s0 
        /var/run/ndc                                       socket             system_u:object_r:named_var_run_t:s0 
        /dev/gpmdata                                       named pipe         system_u:object_r:gpmctl_t:s0 
        /dev/initctl                                       named pipe         system_u:object_r:initctl_t:s0 
        /dev/xconsole                                      named pipe         system_u:object_r:xconsole_device_t:s0 
        /usr/sbin/named                                    regular file       system_u:object_r:named_exec_t:s0 
        /etc/named\.conf                                   regular file       system_u:object_r:named_conf_t:s0 
        /usr/sbin/lwresd                                   regular file       system_u:object_r:named_exec_t:s0 
        /var/run/initctl                                   named pipe         system_u:object_r:initctl_t:s0 
        /usr/sbin/unbound                                  regular file       system_u:object_r:named_exec_t:s0 
        /usr/sbin/named-sdb                                regular file       system_u:object_r:named_exec_t:s0 
        /var/named/named\.ca                               regular file       system_u:object_r:named_conf_t:s0 
        /etc/named\.root\.hints                            regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot/dev                              directory          system_u:object_r:device_t:s0 
        /etc/rc\.d/init\.d/named                           regular file       system_u:object_r:named_initrc_exec_t:s0 
        /usr/sbin/named-pkcs11                             regular file       system_u:object_r:named_exec_t:s0 
        /etc/rc\.d/init\.d/unbound                         regular file       system_u:object_r:named_initrc_exec_t:s0 
        /usr/sbin/unbound-anchor                           regular file       system_u:object_r:named_exec_t:s0 
        /usr/sbin/named-checkconf                          regular file       system_u:object_r:named_checkconf_exec_t:s0 
        /usr/sbin/unbound-control                          regular file       system_u:object_r:named_exec_t:s0 
        /var/named/chroot_sdb/dev                          directory          system_u:object_r:device_t:s0 
        /var/named/chroot/var/log                          directory          system_u:object_r:var_log_t:s0 
        /var/named/chroot/dev/log                          socket             system_u:object_r:devlog_t:s0 
        /etc/rc\.d/init\.d/named-sdb                       regular file       system_u:object_r:named_initrc_exec_t:s0 
        /var/named/chroot/dev/null                         character device   system_u:object_r:null_device_t:s0 
        /var/named/chroot/dev/zero                         character device   system_u:object_r:zero_device_t:s0 
        /usr/sbin/unbound-checkconf                        regular file       system_u:object_r:named_exec_t:s0 
        /var/named/chroot/dev/random                       character device   system_u:object_r:random_device_t:s0 
        /var/run/systemd/initctl/fifo                      named pipe         system_u:object_r:initctl_t:s0 
        /var/named/chroot/etc/rndc\.key                    regular file       system_u:object_r:dnssec_t:s0 
        /usr/share/munin/plugins/named                     regular file       system_u:object_r:services_munin_plugin_exec_t:s0 
        /var/named/chroot_sdb/dev/null                     character device   system_u:object_r:null_device_t:s0 
        /var/named/chroot_sdb/dev/zero                     character device   system_u:object_r:zero_device_t:s0 
        /var/named/chroot/etc/localtime                    regular file       system_u:object_r:locale_t:s0 
        /var/named/chroot/etc/named\.conf                  regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot_sdb/dev/random                   character device   system_u:object_r:random_device_t:s0 
        /etc/named\.caching-nameserver\.conf               regular file       system_u:object_r:named_conf_t:s0 
        /usr/lib/systemd/systemd-hostnamed                 regular file       system_u:object_r:systemd_hostnamed_exec_t:s0 
        /var/named/chroot/var/named/named\.ca              regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot/etc/named\.root\.hints           regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot/etc/named\.caching-nameserver\.conf regular file       system_u:object_r:named_conf_t:s0 
        /var/named/chroot/lib64 = /usr/lib
        /var/named/chroot/usr/lib64 = /usr/lib

```

Помогло буквально это <a name='stend_on'></a>

```shell
sudo chcon -R -t named_zone_t /etc/named
```

Причем можно перечеркнуть абсолютно все ранее сделанное и на ГОЛОМ тестовом стенде исполнить только эту команду и все заработает

```shell
dig www.ddns.lab
          
        ;; QUESTION SECTION:
        ;www.ddns.lab.                  IN      A
        ;; ANSWER SECTION:
        www.ddns.lab.           60      IN      A       192.168.50.15  >--------.
        ;; AUTHORITY SECTION:                                                   |
        ddns.lab.               3600    IN      NS      ns01.dns.lab.  <---.----'
        ;; ADDITIONAL SECTION:                                             |
        ns01.dns.lab.           3600    IN      A       192.168.50.10  <---'

```

__Вопрос__: наверно, нужно исходить из того, что в директории `/etc/named` лежат файлы сущности `зона` и поэтому-то необходимо `named_zone_t`. Но есть ли какие-то иные объективные признаки того, что нужно применить `named_zone_t`?

### Выбор решений

<a name="p_2_vibor"></a>

В итоге решений может быть 2. Это либо указанная [серебряная](#stend_on) пуля решения №2 или набор из файлов `*.te` (`*.pp`) решения №1. 
Однако, я за штатную [серебряную](#stend_on), так как люди "после" меня могут и не разобраться в нагороженном огороде из файлов `*.te` (`*.pp`).

__Вопрос__: после перезагрузки `client` потеряет зону, так как она динамическая (`/etc/named/dynamic/named.ddns.lab*`). А как сделать статической?

### Мытарства. Шлак для истории (не для ДЗ)

<a name="mitary"></a>

```shell
echo '' > /var/named/data/named.run
echo '' > /var/log/audit/audit.log
# nsupdate на client
audit2allow  < /var/log/audit/audit.log
    Nothing to do

cat /var/named/data/named.run
    
    client @0x7f875009e160 192.168.50.15#49269/key zonetransfer.key: view view1: updating zone 'ddns.lab/IN': error: journal open failed: no more

systemctl status -l named

    Jul 04 22:56:01 ns01 named[5025]: client @0x7fe5cc03c3e0 192.168.50.15#35619/key zonetransfer.key: view view1: updating zone 'ddns.lab/IN': error: journal open failed: no more
  <-- корень зла

ls -Zla /etc/named/*
        
        -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 784 Jul  3 04:59 /etc/named/named.50.168.192.rev
        -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 610 Jul  3 04:59 /etc/named/named.dns.lab
        -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 609 Jul  3 04:59 /etc/named/named.dns.lab.view1
        -rw-rw----. 1 system_u:object_r:etc_t:s0       root named 657 Jul  3 04:59 /etc/named/named.newdns.lab
        
        /etc/named/dynamic:
        total 8
        drw-rwx---. 2 unconfined_u:object_r:etc_t:s0   root  named  88 Jul  3 09:34 .   <-- `unconfined_u`, но что не так с правами?
        drw-rwx---. 3 system_u:object_r:etc_t:s0       root  named 121 Jul  3 04:59 ..
        -rw-rw----. 1 system_u:object_r:etc_t:s0       named named 509 Jul  3 04:59 named.ddns.lab
        -rw-rw----. 1 system_u:object_r:etc_t:s0       named named 509 Jul  3 04:59 named.ddns.lab.view1
        -rw-r--r--. 1 system_u:object_r:etc_t:s0       named named   0 Jul  3 09:34 named.ddns.lab.view1.jnl  <-- 0 байт?
```

```shell

sudo chcon -R -t named_conf_t /etc/named
echo '' > /var/log/audit/audit.log

audit2allow < /var/log/audit/audit.log


#============= named_t ==============
allow named_t etc_t:file write;

#!!!! This avc is allowed in the current policy
allow named_t etc_t:file create;
allow named_t named_conf_t:dir write;
allow named_t named_conf_t:file write;
[root@ns01 vagrant]# audit2allow -M ddns_allow_part_3 < /var/log/audit/audit.log
******************** IMPORTANT ***********************
To make this policy package active, execute:

semodule -i ddns_allow_part_3.pp

[root@ns01 vagrant]# cat ddns_allow_part_3.te 

module ddns_allow_part_3 1.0;

require {
        type named_conf_t;
        type etc_t;
        type named_t;
        class file { create write };
        class dir write;
}

#============= named_t ==============
allow named_t etc_t:file write;

#!!!! This avc is allowed in the current policy
allow named_t etc_t:file create;
allow named_t named_conf_t:dir write;
allow named_t named_conf_t:file write;

semodule -i ddns_allow_part_3.pp

Все равно ошибка

 audit2allow -M ddns_allow_part_4 < /var/log/audit/audit.log
******************** IMPORTANT ***********************
To make this policy package active, execute:

semodule -i ddns_allow_part_4.pp

[root@ns01 vagrant]# cat ddns_allow_part_4.te 

module ddns_allow_part_4 1.0;

require {
        type named_conf_t;
        type etc_t;
        type named_t;
        class file { create write };
        class dir { add_name write };
}

#============= named_t ==============

#!!!! This avc is allowed in the current policy
allow named_t etc_t:file { create write };
allow named_t named_conf_t:dir add_name;

#!!!! This avc is allowed in the current policy
allow named_t named_conf_t:dir write;

#!!!! This avc is allowed in the current policy
allow named_t named_conf_t:file write;

ps -Z 5034
LABEL                             PID TTY      STAT   TIME COMMAND
system_u:system_r:named_t:s0     5034 ?        Ssl    0:00 /usr/sbin/named -u named -c /etc/named.conf


### Разное на будущее

```shell
find / -name named.conf
    /etc/named.conf

grep named_t /var/log/audit/audit.log | audit2allow -m ddns_add_to_part_4 > ddns_add_to_part_4.te
find / -name ddns_add_to_part_4.te
/home/vagrant/ddns_add_to_part_4.te

grep named_t /var/log/audit/audit.log | audit2allow -M ddns_add_to_part_5
semodule -i ddns_add_to_part_5.pp

semodule -l | grep dns

    ddns_add_to     1.0
    ddns_add_to_part_2      1.0
    ddns_add_to_part_3      1.0
    ddns_add_to_part_5      1.0
    dnsmasq 1.10.0
    dnssec  1.0.0
    opendnssec      1.0.0

chmod 0664 /etc/named/dynamic/named.ddns.lab.view1.jnl 
[root@ns01 vagrant]# ls -Zl /etc/named/dynamic/named.ddns.lab.view1.jnl 
-rw-r--r--. 1 system_u:object_r:named_conf_t:s0 named named 0 Jul  3 09:34 /etc/named/dynamic/named.ddns.lab.view1.jnl
chmod 0664 /etc/named/dynamic/named.ddns.lab.view1.jnl 

    #============= named_t ==============
    
    #!!!! WARNING: 'etc_t' is a base type.
    allow named_t etc_t:file { create write };

#============= named_t ==============

#!!!! WARNING: 'etc_t' is a base type.
allow named_t etc_t:file { create write };
allow named_t named_conf_t:dir write;

#============= unconfined_t ==============
allow unconfined_t named_t:dir relabelto;
allow unconfined_t named_t:file relabelto;

ls -Zla /etc/named/ 

    drw-rwx---.  3 system_u:object_r:etc_t:s0       root named  121 Jul  1 19:01 .
    drwxr-xr-x. 86 system_u:object_r:etc_t:s0       root root  8192 Jul  1 19:01 ..
    drw-rwx---.  2 unconfined_u:object_r:etc_t:s0   root named   88 Jul  1 19:19 dynamic                  <-- unconfined_u ?
    -rw-rw----.  1 system_u:object_r:etc_t:s0       root named  784 Jul  1 19:01 named.50.168.192.rev
    -rw-rw----.  1 system_u:object_r:etc_t:s0       root named  610 Jul  1 19:01 named.dns.lab
    -rw-rw----.  1 system_u:object_r:etc_t:s0       root named  609 Jul  1 19:01 named.dns.lab.view1
    -rw-rw----.  1 system_u:object_r:etc_t:s0       root named  657 Jul  1 19:01 named.newdns.lab
    
ls -Z /etc/named/dynamic/
    
    -rw-rw----. named named system_u:object_r:etc_t:s0       named.ddns.lab
    -rw-rw----. named named system_u:object_r:etc_t:s0       named.ddns.lab.view1
    -rw-r--r--. named named system_u:object_r:etc_t:s0       named.ddns.lab.view1.jnl


sudo ls -Z /etc/named/
sudo ls -Z /var/named/
sudo ls -Z /etc/rndc

sudo chcon -R -t named_zone_t /etc/named/*
sudo chcon -R -t named_conf_t /var/named.*
sudo chcon -R -t named_conf_t /var/rndc.*
sudo chcon -R -t named_zone_t /var/tmp/slaves
sudo chcon -R -t named_zone_t /var/tmp/data
sudo chcon -R -t named_cache_t /var/named/slaves
sudo chcon -R -t named_cache_t /var/named/data

[root@ns01 vagrant]# semanage fcontext --list | grep named_conf_t
/etc/rndc.*                                        regular file       system_u:object_r:named_conf_t:s0 
/etc/unbound(/.*)?                                 all files          system_u:object_r:named_conf_t:s0 
/var/named/chroot(/.*)?                            all files          system_u:object_r:named_conf_t:s0 
/etc/named\.rfc1912.zones                          regular file       system_u:object_r:named_conf_t:s0 
/var/named/chroot/etc/named\.rfc1912.zones         regular file       system_u:object_r:named_conf_t:s0 
/etc/named\.conf                                   regular file       system_u:object_r:named_conf_t:s0 
/var/named/named\.ca                               regular file       system_u:object_r:named_conf_t:s0 
/etc/named\.root\.hints                            regular file       system_u:object_r:named_conf_t:s0 
/var/named/chroot/etc/named\.conf                  regular file       system_u:object_r:named_conf_t:s0 
/etc/named\.caching-nameserver\.conf               regular file       system_u:object_r:named_conf_t:s0 
/var/named/chroot/var/named/named\.ca              regular file       system_u:object_r:named_conf_t:s0 
/var/named/chroot/etc/named\.root\.hints           regular file       system_u:object_r:named_conf_t:s0 
/var/named/chroot/etc/named\.caching-nameserver\.conf regular file       system_u:object_r:named_conf_t:s0 
[root@ns01 vagrant]# 


[vagrant@client ~]$ nsupdate -k /etc/named.zonetransfer.key
> server 192.168.50.10
> zone ddns.lab
> update add otus.ddns.lab. 60 A 192.168.50.15
> send
update failed: SERVFAIL

```

```shell
[root@ns01 vagrant]# sudo chcon -R -u system_u /etc/named/dynamic
[root@ns01 vagrant]# ls -Z /etc/named/
drw-rwx---. root named system_u:object_r:etc_t:s0       dynamic
-rw-rw----. root named system_u:object_r:etc_t:s0       named.50.168.192.rev
-rw-rw----. root named system_u:object_r:etc_t:s0       named.dns.lab
-rw-rw----. root named system_u:object_r:etc_t:s0       named.dns.lab.view1
-rw-rw----. root named system_u:object_r:etc_t:s0       named.newdns.lab


semanage fcontext --modify -t named_conf_t /etc/named


 semanage fcontext --modify -t named_conf_t /etc/named
semanage fcontext --modify -t named_zone_t /etc/named
 
semanage fcontext --list | grep named

semanage fcontext --modify -t named_conf_t /etc/named
semanage fcontext --modify -t named_conf_t /etc/named
semanage fcontext --modify -t named_t /etc/named

sudo chcon -R -u system_u -t named_conf_t /etc/named
    /usr/sbin/named                                    regular file       system_u:object_r:named_exec_t:s0 

[vagrant@client ~]$ nsupdate -k /etc/named.zonetransfer.key
server 192.168.50.10
zone dns.lab
zone ns01.dns.lab
update add www.dns.lab. 60 A 192.168.50.15
update add www.dns.lab 60 A 192.168.50.15
update add www.ns01.dns.lab. 60 A 192.168.50.15
# update add www.ddns.lab. 60 A 192.168.50.15
#    update add lab.dns.www 60 A 192.168.50.15
show
send
#    update failed: SERVFAIL
>

- README с анализом причины неработоспособности, возможными способами решения и обоснованием выбора одного из них.
- Исправленный стенд или демонстрация работоспособной системы скриншотами и описанием.


 semanage port -l | grep " 53"
apertus_ldp_port_t             tcp      539
apertus_ldp_port_t             udp      539
dns_port_t                     tcp      53
dns_port_t                     udp      53
gdomap_port_t                  tcp      538
gdomap_port_t                  udp      538
howl_port_t                    tcp      5335
howl_port_t                    udp      5353
imaze_port_t                   tcp      5323
imaze_port_t                   udp      5323
jabber_router_port_t           tcp      5347
llmnr_port_t                   tcp      5355
llmnr_port_t                   udp      5355
lltng_port_t                   tcp      5345
wsdapi_port_t                  tcp      5357
wsdapi_port_t                  udp      5357

nslookup 192.168.50.10
10.50.168.192.in-addr.arpa      name = ns01.newdns.lab.
10.50.168.192.in-addr.arpa      name = ns01.dns.lab.


[root@client vagrant]# nslookup 192.168.50.15
15.50.168.192.in-addr.arpa      name = client.newdns.lab.
15.50.168.192.in-addr.arpa      name = client.dns.lab.
15.50.168.192.in-addr.arpa      name = www.newdns.lab.
15.50.168.192.in-addr.arpa      name = web1.dns.lab.


[root@client vagrant]# getsebool -a | grep zone
named_write_master_zones --> on
zoneminder_anon_write --> off
zoneminder_run_sudo --> off
[root@client vagrant]# getsebool -a | grep dns 
httpd_verify_dns --> off

[root@client vagrant]# semanage port -l | grep ^ns
nsd_control_port_t             tcp      8952

cat /var/named/named.ca        

; <<>> DiG 9.11.3-RedHat-9.11.3-3.fc27 <<>> +bufsize=1200 +norec @a.root-servers.net
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 46900
;; flags: qr aa; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 27

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1472
;; QUESTION SECTION:
;.                              IN      NS

;; ANSWER SECTION:
.                       518400  IN      NS      a.root-servers.net.
.                       518400  IN      NS      b.root-servers.net.
.                       518400  IN      NS      c.root-servers.net.
.                       518400  IN      NS      d.root-servers.net.
.                       518400  IN      NS      e.root-servers.net.
.                       518400  IN      NS      f.root-servers.net.
.                       518400  IN      NS      g.root-servers.net.
.                       518400  IN      NS      h.root-servers.net.
.                       518400  IN      NS      i.root-servers.net.
.                       518400  IN      NS      j.root-servers.net.
.                       518400  IN      NS      k.root-servers.net.
.                       518400  IN      NS      l.root-servers.net.
.                       518400  IN      NS      m.root-servers.net.

;; ADDITIONAL SECTION:
a.root-servers.net.     518400  IN      A       198.41.0.4
b.root-servers.net.     518400  IN      A       199.9.14.201
c.root-servers.net.     518400  IN      A       192.33.4.12
d.root-servers.net.     518400  IN      A       199.7.91.13
e.root-servers.net.     518400  IN      A       192.203.230.10
f.root-servers.net.     518400  IN      A       192.5.5.241
g.root-servers.net.     518400  IN      A       192.112.36.4
h.root-servers.net.     518400  IN      A       198.97.190.53
i.root-servers.net.     518400  IN      A       192.36.148.17
j.root-servers.net.     518400  IN      A       192.58.128.30
k.root-servers.net.     518400  IN      A       193.0.14.129
l.root-servers.net.     518400  IN      A       199.7.83.42
m.root-servers.net.     518400  IN      A       202.12.27.33
a.root-servers.net.     518400  IN      AAAA    2001:503:ba3e::2:30
b.root-servers.net.     518400  IN      AAAA    2001:500:200::b
c.root-servers.net.     518400  IN      AAAA    2001:500:2::c
d.root-servers.net.     518400  IN      AAAA    2001:500:2d::d
e.root-servers.net.     518400  IN      AAAA    2001:500:a8::e
f.root-servers.net.     518400  IN      AAAA    2001:500:2f::f
g.root-servers.net.     518400  IN      AAAA    2001:500:12::d0d
h.root-servers.net.     518400  IN      AAAA    2001:500:1::53
i.root-servers.net.     518400  IN      AAAA    2001:7fe::53
j.root-servers.net.     518400  IN      AAAA    2001:503:c27::2:30
k.root-servers.net.     518400  IN      AAAA    2001:7fd::1
l.root-servers.net.     518400  IN      AAAA    2001:500:9f::42
m.root-servers.net.     518400  IN      AAAA    2001:dc3::35

;; Query time: 24 msec
;; SERVER: 198.41.0.4#53(198.41.0.4)
;; WHEN: Thu Apr 05 15:57:34 CEST 2018
;; MSG SIZE  rcvd: 811


[root@client vagrant]# dig ddns.lab

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.5 <<>> ddns.lab
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 56313
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;ddns.lab.                      IN      A

;; AUTHORITY SECTION:
ddns.lab.               600     IN      SOA     ns01.dns.lab. root.dns.lab. 2711201407 3600 600 86400 600

;; Query time: 1 msec
;; SERVER: 192.168.50.10#53(192.168.50.10)
;; WHEN: Mon Jun 28 20:22:28 UTC 2021
;; MSG SIZE  rcvd: 87

sealert -a /var/log/audit/audit.log

[root@client vagrant]# (setroubleshoot:25692): Gtk-WARNING **: 20:31:05.089: Locale not supported by C library.
        Using the fallback 'C' locale.
100% done
found 0 alerts in /var/log/audit/audit.log

[root@client vagrant]#  ls -Z /usr/bin/nsupdate
-rwxr-xr-x. root root system_u:object_r:bin_t:s0       /usr/bin/nsupdate


[root@client vagrant]# semanage port -l | grep nsd
nsd_control_port_t             tcp      8952

```

Вопрос:
как при старте системы генерить такие приветсвенные штуки 

###############################
### Welcome to the DNS lab! ###
###############################

```shell

[root@client vagrant]# nslookup 192.168.50.10
10.50.168.192.in-addr.arpa      name = ns01.newdns.lab.
10.50.168.192.in-addr.arpa      name = ns01.dns.lab.


[root@client vagrant]# nslookup 192.168.50.15
15.50.168.192.in-addr.arpa      name = client.newdns.lab.
15.50.168.192.in-addr.arpa      name = client.dns.lab.
15.50.168.192.in-addr.arpa      name = www.newdns.lab.
15.50.168.192.in-addr.arpa      name = web1.dns.lab.
```

На `client`:

```shell
[vagrant@client ~]$ cat /etc/resolv.conf
domain dns.lab
search dns.lab
nameserver 192.168.50.10
```

На `ns01`:

```shell
[vagrant@ns01 ~]$ cat /etc/resolv.conf
domain dns.lab
search dns.lab
nameserver 127.0.0.1  <-- сам себе DNS
```

[root@ns01 vagrant]# ps -Z 5044                             

    LABEL                             PID TTY      STAT   TIME COMMAND
    system_u:system_r:named_t:s0     5044 ?        Ssl    0:00 /usr/sbin/named -u named -c /etc/named.conf
[vagrant@ns01 ~]$ sudo su
```